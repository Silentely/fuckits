name: Deploy to Cloudflare Works

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  WRANGLER_CONFIG_PATH: wrangler.ci.toml
  WORKFLOW_FILE: .github/workflows/deploy.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build worker bundle
        run: npm run build

      - name: Download wrangler configuration from gist
        env:
          WRANGLER_TOML_URL: ${{ vars.WRANGLER_TOML_URL }}
          WRANGLER_TOML_URL_SECRET: ${{ secrets.WRANGLER_TOML_URL }}
        run: |
          URL="${WRANGLER_TOML_URL:-$WRANGLER_TOML_URL_SECRET}"
          if [ -z "$URL" ]; then
            echo "WRANGLER_TOML_URL repository variable or secret is not configured."
            exit 1
          fi
          curl -fsSL "$URL" -o "$WRANGLER_CONFIG_PATH"
          echo "✅ Downloaded wrangler config to $WRANGLER_CONFIG_PATH"

      - name: Mask sensitive values from wrangler config
        run: |
          python3 - <<'PY'
          import os
          import tomllib

          path = os.environ["WRANGLER_CONFIG_PATH"]

          def emit(value: str) -> None:
              if value:
                  print(f"::add-mask::{value}")

          def add_mask(value):
              if not isinstance(value, str) or not value:
                  return
              variants = {value, f'"{value}"', f"'{value}'"}
              prefix_lengths = [4, 6, 8, 10, 12, 16]
              for plen in prefix_lengths:
                  if len(value) > plen:
                      prefix = value[:plen]
                      for ellipsis in ("...", "…"):
                          variants.add(prefix + ellipsis)
                          variants.add(f'"{prefix}{ellipsis}"')
                          variants.add(f"'{prefix}{ellipsis}'")
              for item in variants:
                  emit(item)

          try:
              with open(path, "rb") as fh:
                  data = tomllib.load(fh)
          except Exception as exc:
              raise SystemExit(f"Failed to parse {path}: {exc}")

          def mask_vars(section):
              if isinstance(section, dict):
                  for val in section.values():
                      add_mask(val)

          mask_vars(data.get("vars"))

          envs = data.get("env") or {}
          if isinstance(envs, dict):
              for env_cfg in envs.values():
                  if isinstance(env_cfg, dict):
                      mask_vars(env_cfg.get("vars"))

          for route in data.get("routes", []):
              if isinstance(route, dict):
                  pattern = route.get("pattern")
                  if isinstance(pattern, str):
                      add_mask(pattern)
                      if "." in pattern:
                          add_mask(pattern.split(".", 1)[1])
                  add_mask(route.get("custom_domain"))

          # Also cover env vars/injected secrets for wrangler output
          for env_var in ("CLOUDFLARE_API_TOKEN", "CLOUDFLARE_ACCOUNT_ID"):
              add_mask(os.environ.get(env_var))

          PY

      - name: Deploy to Cloudflare Works
        if: github.event_name != 'pull_request'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN secret is missing."
            exit 1
          fi
          npx wrangler deploy --config "$WRANGLER_CONFIG_PATH"
          rm -f "$WRANGLER_CONFIG_PATH"

      - name: Delete workflow runs older than 3 days
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cutoff = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
            const { owner, repo } = context.repo;
            const workflowFile = process.env.WORKFLOW_FILE || ".github/workflows/deploy.yml";
            const { data } = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
              per_page: 100
            });
            const wf = data.workflows.find(
              (item) => item.path === workflowFile || item.name === context.workflow
            );
            if (!wf) {
              core.warning(`Workflow ${workflowFile} not found; skipping cleanup.`);
              return;
            }
            const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
              owner,
              repo,
              workflow_id: wf.id,
              per_page: 100
            });
            let deleted = 0;
            for (const run of runs) {
              if (new Date(run.created_at) < cutoff) {
                await github.rest.actions.deleteWorkflowRun({
                  owner,
                  repo,
                  run_id: run.id
                });
                deleted++;
              }
            }
            core.info(`Deleted ${deleted} workflow runs older than 3 days.`);
