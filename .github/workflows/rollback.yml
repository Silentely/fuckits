name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      target_deployment:
        description: 'Deployment ID to rollback to (or "previous" for last stable)'
        required: true
        default: 'previous'
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

permissions:
  contents: read

jobs:
  rollback:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Fetch more history for rollback
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get rollback target
        id: get-target
        run: |
          if [ "${{ github.event.inputs.target_deployment }}" = "previous" ]; then
            # Get the previous successful deployment
            echo "Using previous stable deployment"
            # In a real scenario, you'd query Cloudflare API for deployment history
            # For now, we'll use the last commit before current
            TARGET_COMMIT=$(git rev-parse HEAD~1)
            echo "target_commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "target_commit=${{ github.event.inputs.target_deployment }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout target version
        run: |
          git checkout ${{ steps.get-target.outputs.target_commit }}
      
      - name: Run tests on rollback target
        run: npm run test
        continue-on-error: false
      
      - name: Build worker
        run: npm run build
      
      - name: Deploy to Cloudflare (Rollback)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env production
      
      - name: Verify deployment
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10
          
          # Test health endpoint
          response=$(curl -s https://fuckits.25500552.xyz/health)
          echo "Health check response: $response"
          
          if ! echo "$response" | grep -q '"status":"ok"'; then
            echo "❌ Rollback deployment health check failed!"
            exit 1
          fi
          
          echo "✅ Rollback deployment successful"
      
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rollback executed: ${{ github.event.inputs.reason }}`,
              body: `## Rollback Details
              
              - **Reason**: ${{ github.event.inputs.reason }}
              - **Target**: \`${{ steps.get-target.outputs.target_commit }}\`
              - **Executed by**: @${{ github.actor }}
              - **Timestamp**: ${new Date().toISOString()}
              
              ## Next Steps
              
              1. Investigate the root cause of the issue
              2. Fix the problem in a new PR
              3. Deploy with confidence after thorough testing
              
              cc: @Silentely`,
              labels: ['rollback', 'incident']
            });
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ URGENT: Rollback failed - ${{ github.event.inputs.reason }}`,
              body: `## Rollback Failure
              
              The automated rollback process has failed!
              
              - **Reason for rollback**: ${{ github.event.inputs.reason }}
              - **Target**: \`${{ steps.get-target.outputs.target_commit }}\`
              - **Executed by**: @${{ github.actor }}
              - **Timestamp**: ${new Date().toISOString()}
              
              ## Immediate Actions Required
              
              1. Check the GitHub Actions logs
              2. Manually rollback via Cloudflare dashboard if necessary
              3. Investigate why automated rollback failed
              
              cc: @Silentely`,
              labels: ['rollback', 'incident', 'urgent']
            });
