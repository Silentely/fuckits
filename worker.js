// --- FUCKIT.SH Cloudflare Worker ---

// This is the content of your main.sh installer script.
// It will be served when a user makes a GET request.
function b64_to_utf8(str) {
  try {
    // This is a more robust way to decode base64 to UTF-8
    const binaryString = atob(str);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return new TextDecoder().decode(bytes);
  } catch (e) {
    console.error("Failed to decode base64 string:", e);
    return ""; // Return empty string on failure
  }
}

const INSTALLER_SCRIPT = b64_to_utf8(`IyEvYmluL2Jhc2gKIwojIFRoaXMgc2NyaXB0IGlzIHRoZSBpbnN0YWxsZXIgYW5kIHRlbXBvcmFyeSBydW5uZXIgZm9yIGZ1Y2tpdC5zaAojCiMgLS0tIFJFQ09NTUVOREVEIFNFQ1VSRSBVU0FHRSAtLS0KIwojIDEuIERvd25sb2FkOgojICAgIGN1cmwgLW8gZnVja2l0LnNoIGh0dHBzOi8vZnVja2l0cy4yNTUwMDU1Mi54eXoKIwojIDIuIEluc3BlY3Q6CiMgICAgbGVzcyBmdWNraXQuc2gKIwojIDMuIFJ1biAoSW5zdGFsbCk6CiMgICAgYmFzaCBmdWNraXQuc2gKIwojIDQuIFJ1biAoVGVtcG9yYXJ5KToKIyAgICBiYXNoIGZ1Y2tpdC5zaCAieW91ciBwcm9tcHQiCiMKCnNldCAtZXVvIHBpcGVmYWlsCgojIC0tLSBDb2xvciBEZWZpbml0aW9ucyAtLS0KcmVhZG9ubHkgQ19SRVNFVD0nXDAzM1swbScKcmVhZG9ubHkgQ19SRURfQk9MRD0nXDAzM1sxOzMxbScKcmVhZG9ubHkgQ19SRUQ9J1wwMzNbMDszMW0nCnJlYWRvbmx5IENfR1JFRU49J1wwMzNbMDszMm0nCnJlYWRvbmx5IENfWUVMTE9XPSdcMDMzWzA7MzNtJwpyZWFkb25seSBDX0NZQU49J1wwMzNbMDszNm0nCnJlYWRvbmx5IENfQk9MRD0nXDAzM1sxbScKcmVhZG9ubHkgQ19ESU09J1wwMzNbMm0nCgojIC0tLSBGVUNLISAtLS0KcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfUZVQ0shJHtDX1JFU0VUfSIKcmVhZG9ubHkgRkNLTj0iJHtDX1JFRH1GKkNLSU5HJHtDX1JFU0VUfSIKCgojIC0tLSBDb25maWd1cmF0aW9uIC0tLQppZiBbIC16ICIke0hPTUU6LX0iIF07IHRoZW4KICAgIGVjaG8gLWUgIlwwMzNbMTszMW1GVUNLIVwwMzNbMG0gXDAzM1swOzMxbVlvdXIgSE9NRSB2YXJpYWJsZSBpc24ndCBzZXQuIEkgZG9uJ3Qga25vdyB3aGVyZSB0byBpbnN0YWxsIHRoaXMgc2hpdC4gU2V0IGl0IHlvdXJzZWxmIChlLmcuLCBleHBvcnQgSE9NRT0vcm9vdCkuXDAzM1swbSIgPiYyCiAgICBleGl0IDEKZmkKcmVhZG9ubHkgSU5TVEFMTF9ESVI9IiRIT01FLy5mdWNrIgpyZWFkb25seSBNQUlOX1NIPSIkSU5TVEFMTF9ESVIvbWFpbi5zaCIKcmVhZG9ubHkgQ09ORklHX0ZJTEU9IiRJTlNUQUxMX0RJUi9jb25maWcuc2giCgoKIyAtLS0gQ29yZSBMb2dpYyAoRW1iZWRkZWQgYXMgYSBzdHJpbmcpIC0tLQpyZWFkIC1yIC1kICcnIENPUkVfTE9HSUMgPDwnRU9GJyB8fCB0cnVlCgojIC0tLSBCZWdpbiBDb3JlIExvZ2ljIGZvciBmdWNraXQuc2ggLS0tCgojIC0tLSBDb2xvciBEZWZpbml0aW9ucyAtLS0KIyBPbmx5IGRlZmluZSBjb2xvcnMgaWYgdGhleSBoYXZlbid0IGJlZW4gZGVmaW5lZCB5ZXQgKGZvciB0ZW1wIG1vZGUpCmlmIFsgLXogIiR7Q19SRVNFVDotfSIgXTsgdGhlbgogICAgcmVhZG9ubHkgQ19SRVNFVD0nXDAzM1swbScKICAgIHJlYWRvbmx5IENfUkVEX0JPTEQ9J1wwMzNbMTszMW0nCiAgICByZWFkb25seSBDX1JFRD0nXDAzM1swOzMxbScKICAgIHJlYWRvbmx5IENfR1JFRU49J1wwMzNbMDszMm0nCiAgICByZWFkb25seSBDX1lFTExPVz0nXDAzM1swOzMzbScKICAgIHJlYWRvbmx5IENfQ1lBTj0nXDAzM1swOzM2bScKICAgIHJlYWRvbmx5IENfQk9MRD0nXDAzM1sxbScKICAgIHJlYWRvbmx5IENfRElNPSdcMDMzWzJtJwoKICAgICMgLS0tIEZVQ0shIC0tLQogICAgcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfUZVQ0shJHtDX1JFU0VUfSIKICAgIHJlYWRvbmx5IEZDS049IiR7Q19SRUR9RipDS0lORyR7Q19SRVNFVH0iCgogICAgIyAtLS0gQ29uZmlndXJhdGlvbiAtLS0KICAgIGlmIFsgLXogIiR7SE9NRTotfSIgXTsgdGhlbgogICAgICAgICMgVGhpcyBwYXJ0IGlzIGZvciB0aGUgdGVtcG9yYXJ5IHJ1bm5lciwgd2hpY2ggZG9lc24ndCBpbnN0YWxsLAogICAgICAgICMgYnV0IHdlIG5lZWQgdGhlIHZhcmlhYmxlcyBkZWZpbmVkIHRvIGF2b2lkIHVuYm91bmQgZXJyb3JzLgogICAgICAgICMgVGhlIGluc3RhbGwgY2hlY2sgd2lsbCBoYXBwZW4gaW4gdGhlIGluc3RhbGxlciBwYXJ0IG9mIHRoZSBzY3JpcHQuCiAgICAgICAgcmVhZG9ubHkgSU5TVEFMTF9ESVI9Ii90bXAvLmZ1Y2siCiAgICAgICAgcmVhZG9ubHkgTUFJTl9TSD0iL3RtcC8uZnVjay9tYWluLnNoIgogICAgICAgIHJlYWRvbmx5IENPTkZJR19GSUxFPSIvdG1wLy5mdWNrL2NvbmZpZy5zaCIKICAgIGVsc2UKICAgICAgICByZWFkb25seSBJTlNUQUxMX0RJUj0iJEhPTUUvLmZ1Y2siCiAgICAgICAgcmVhZG9ubHkgTUFJTl9TSD0iJElOU1RBTExfRElSL21haW4uc2giCiAgICAgICAgcmVhZG9ubHkgQ09ORklHX0ZJTEU9IiRJTlNUQUxMX0RJUi9jb25maWcuc2giCiAgICBmaQpmaQoKIyBMb2FkIHVzZXIgY29uZmlndXJhdGlvbiBpZiBpdCBleGlzdHMKaWYgWyAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICBzb3VyY2UgIiRDT05GSUdfRklMRSIKZmkKCmlmIFsgLXogIiR7REVGQVVMVF9BUElfRU5EUE9JTlQreH0iIF07IHRoZW4KICAgIHJlYWRvbmx5IERFRkFVTFRfQVBJX0VORFBPSU5UPSJodHRwczovL2Z1Y2tpdHMuMjU1MDA1NTIueHl6LyIKZmkKCiMgSGVscGVyIHRvIGZpbmQgdGhlIHVzZXIncyBzaGVsbCBwcm9maWxlIGZpbGUKX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSgpIHsKICAgIGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgInpzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uenNocmMiCiAgICBlbGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgImJhc2giOyB0aGVuCiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnByb2ZpbGUiIF07IHRoZW4KICAgICAgICAjIEZhbGxiYWNrIGZvciBzaCwga3NoLCBldGMuCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLmJhc2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy5iYXNocmMiCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93bl9wcm9maWxlIgogICAgZmkKfQoKIyBEZXRlY3RzIHRoZSBwYWNrYWdlIG1hbmFnZXIKX2Z1Y2tfZGV0ZWN0X3BrZ19tYW5hZ2VyKCkgewogICAgaWYgY29tbWFuZCAtdiBhcHQtZ2V0ICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gImFwdCIKICAgIGVsaWYgY29tbWFuZCAtdiB5dW0gJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAieXVtIgogICAgZWxpZiBjb21tYW5kIC12IGRuZiAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJkbmYiCiAgICBlbGlmIGNvbW1hbmQgLXYgcGFjbWFuICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gInBhY21hbiIKICAgIGVsaWYgY29tbWFuZCAtdiB6eXBwZXIgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAienlwcGVyIgogICAgZWxpZiBjb21tYW5kIC12IGJyZXcgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAiYnJldyIKICAgIGVsc2UKICAgICAgICBlY2hvICJ1bmtub3duIgogICAgZmkKfQoKIyBDb2xsZWN0cyBzeXN0ZW0gaW5mbyBhcyBhIHNpbXBsZSBzdHJpbmcKX2Z1Y2tfY29sbGVjdF9zeXNpbmZvX3N0cmluZygpIHsKICAgIGxvY2FsIHBrZ19tYW5hZ2VyCiAgICBwa2dfbWFuYWdlcj0kKF9mdWNrX2RldGVjdF9wa2dfbWFuYWdlcikKICAgICMgVGhlIHNlcnZlci1zaWRlIExMTSBwcm9tcHQgd2lsbCBuZWVkIHRvIHBhcnNlIHRoaXMgc3RyaW5nCiAgICBlY2hvICJPUzogJCh1bmFtZSAtcyksIEFyY2g6ICQodW5hbWUgLW0pLCBTaGVsbDogJHtTSEVMTDotdW5rbm93bn0sIFBrZ01ncjogJHBrZ19tYW5hZ2VyLCBDV0Q6ICQocHdkKSIKfQoKIyBFc2NhcGVzIGEgc3RyaW5nIGZvciB1c2UgaW4gYSBKU09OIHBheWxvYWQKX2Z1Y2tfanNvbl9lc2NhcGUoKSB7CiAgICAjIEJhc2ljIGVzY2FwZSBmb3IgcXVvdGVzLCBiYWNrc2xhc2hlcywgYW5kIGNvbnRyb2wgY2hhcmFjdGVycwogICAgcHJpbnRmICclcycgIiQxIiB8IHNlZCAtZSAncy9cXC9cXFxcL2cnIC1lICdzLyIvXCIvZycgLWUgJ3MvXG4vXFxuL2cnIC1lICdzL1xyL1xcci9nJyAtZSAncy9cdC9cXHQvZycKfQoKIyBTaW1wbGUgaGVscGVyIHRvIHBhcnNlIGJvb2xlYW4tbGlrZSB2YWx1ZXMKX2Z1Y2tfdHJ1dGh5KCkgewogICAgbG9jYWwgdmFsdWU9IiR7MTotfSIKICAgIGxvY2FsIG5vcm1hbGl6ZWQKICAgIG5vcm1hbGl6ZWQ9JChwcmludGYgJyVzJyAiJHZhbHVlIiB8IHRyICdbOnVwcGVyOl0nICdbOmxvd2VyOl0nKQogICAgY2FzZSAiJG5vcm1hbGl6ZWQiIGluCiAgICAgICAgMXx0cnVlfHllc3x5fG9uKQogICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICA7OwogICAgICAgICopCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIDs7CiAgICBlc2FjCn0KCiMgRGVidWcgaGVscGVyCl9mdWNrX2RlYnVnKCkgewogICAgaWYgX2Z1Y2tfdHJ1dGh5ICIke0ZVQ0tfREVCVUc6LTB9IjsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ESU19W2RlYnVnXSAkKiR7Q19SRVNFVH0iID4mMgogICAgZmkKfQoKIyBTcGlubmVyIGFuaW1hdGlvbgpfZnVja19zcGlubmVyKCkgewogICAgbG9jYWwgcGlkPSQxCiAgICBsb2NhbCBkZWxheT0wLjEKICAgIGxvY2FsIHNwaW5zdHI9J3wvLVwnCiAgICAKICAgICMgSGlkZSBjdXJzb3IKICAgIHRwdXQgY2l2aXMgMj4vZGV2L251bGwgfHwgcHJpbnRmICJcMDMzWz8yNWwiCgogICAgd2hpbGUga2lsbCAtMCAiJHBpZCIgMj4vZGV2L251bGw7IGRvCiAgICAgICAgbG9jYWwgdGVtcD0ke3NwaW5zdHIjP30KICAgICAgICBwcmludGYgIiBbJWNdICAiICIkc3BpbnN0ciIKICAgICAgICBsb2NhbCBzcGluc3RyPSR0ZW1wJHtzcGluc3RyJSIkdGVtcCJ9CiAgICAgICAgc2xlZXAgJGRlbGF5CiAgICAgICAgcHJpbnRmICJcYlxiXGJcYlxiXGIiCiAgICBkb25lCiAgICBwcmludGYgIiAgICBcYlxiXGJcYiIKICAgIAogICAgIyBTaG93IGN1cnNvcgogICAgdHB1dCBjbm9ybSAyPi9kZXYvbnVsbCB8fCBwcmludGYgIlwwMzNbPzI1aCIKfQoKIyBFbnN1cmUgYSBjb25maWcgZmlsZSBleGlzdHMgdG8gaGVscCB1c2VycyB0d2VhayB0aGUgYmVoYXZpb3VyCl9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzKCkgewogICAgaWYgWyAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgIG1rZGlyIC1wICIkKGRpcm5hbWUgIiRDT05GSUdfRklMRSIpIgogICAgY2F0IDw8J0NGRycgPiAiJENPTkZJR19GSUxFIgojIGZ1Y2tpdC5zaCBjb25maWd1cmF0aW9uCiMgVG9nZ2xlIHRoZSBleHBvcnRzIGJlbG93IHRvIGN1c3RvbWlzZSB5b3VyIGV4cGVyaWVuY2UuCgojIEN1c3RvbSBBUEkgZW5kcG9pbnQgdGhhdCBwb2ludHMgdG8geW91ciBzZWxmLWhvc3RlZCB3b3JrZXIKIyBleHBvcnQgRlVDS19BUElfRU5EUE9JTlQ9Imh0dHBzOi8veW91ci1kb21haW4ud29ya2Vycy5kZXYvIgoKIyBBZGQgYW4gZXh0cmEgYWxpYXMgYmVzaWRlcyB0aGUgZGVmYXVsdCAnZnVjaycKIyBleHBvcnQgRlVDS19BTElBUz0icGxzIgoKIyBTa2lwIGNvbmZpcm1hdGlvbiBwcm9tcHRzICh1c2Ugd2l0aCBjYXV0aW9uISkKIyBleHBvcnQgRlVDS19BVVRPX0VYRUM9ZmFsc2UKCiMgT3ZlcnJpZGUgY3VybCB0aW1lb3V0IChzZWNvbmRzKQojIGV4cG9ydCBGVUNLX1RJTUVPVVQ9MzAKCiMgRW5hYmxlIHZlcmJvc2UgZGVidWcgbG9ncwojIGV4cG9ydCBGVUNLX0RFQlVHPWZhbHNlCgojIERpc2FibGUgdGhlIGJ1aWx0LWluICdmdWNrJyBhbGlhcwojIGV4cG9ydCBGVUNLX0RJU0FCTEVfREVGQVVMVF9BTElBUz1mYWxzZQpDRkcKfQoKX2Z1Y2tfc2hvd19jb25maWdfaGVscCgpIHsKICAgIF9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfUNvbmZpZ3VyYXRpb24gZmlsZToke0NfUkVTRVR9ICR7Q19DWUFOfSRDT05GSUdfRklMRSR7Q19SRVNFVH0iCiAgICBpZiBbIC1uICIke0VESVRPUjotfSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9RWRpdCB3aXRoOiR7Q19SRVNFVH0gJHtDX0NZQU59JHtFRElUT1J9IFwiJENPTkZJR19GSUxFXCIke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9T3BlbiB0aGlzIGZpbGUgaW4geW91ciBmYXZvdXJpdGUgZWRpdG9yIHRvIGN1c3RvbWlzZSBmdWNraXQuc2guJHtDX1JFU0VUfSIKICAgIGZpCiAgICBlY2hvIC1lICIke0NfQ1lBTn1BdmFpbGFibGUgdG9nZ2xlczoke0NfUkVTRVR9IEZVQ0tfQVBJX0VORFBPSU5ULCBGVUNLX0FMSUFTLCBGVUNLX0FVVE9fRVhFQywgRlVDS19USU1FT1VULCBGVUNLX0RFQlVHIgp9CgojIFVuaW5zdGFsbHMgdGhlIHNjcmlwdApfdW5pbnN0YWxsX3NjcmlwdCgpIHsKICAgIGVjaG8gLWUgIiRGVUNLICR7Q19ZRUxMT1d9U28geW91J3JlIGtpY2tpbmcgbWUgb3V0PyBGaW5lLiR7Q19SRVNFVH0iCgogICAgIyBGaW5kIHRoZSBwcm9maWxlIGZpbGUKICAgIGxvY2FsIHByb2ZpbGVfZmlsZQogICAgcHJvZmlsZV9maWxlPSQoX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSkKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCgogICAgaWYgWyAiJHByb2ZpbGVfZmlsZSIgIT0gInVua25vd25fcHJvZmlsZSIgXSAmJiBbIC1mICIkcHJvZmlsZV9maWxlIiBdOyB0aGVuCiAgICAgICAgaWYgZ3JlcCAtcUYgIiRzb3VyY2VfbGluZSIgIiRwcm9maWxlX2ZpbGUiOyB0aGVuCiAgICAgICAgICAgICMgVXNlIHNlZCB0byByZW1vdmUgdGhlIGxpbmVzLiBDcmVhdGUgYSBiYWNrdXAuCiAgICAgICAgICAgIHNlZCAtaS5iYWsgInwkc291cmNlX2xpbmV8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgICAgIHNlZCAtaS5iYWsgInwjIEFkZGVkIGJ5IGZ1Y2tpdC5zaCBpbnN0YWxsZXJ8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfUNvdWxkIG5vdCBmaW5kIGEgc2hlbGwgcHJvZmlsZSBmaWxlIHRvIG1vZGlmeS4gWW91ciBwcm9ibGVtIG5vdy4ke0NfUkVTRVR9IgogICAgZmkKCiAgICBpZiBbIC1kICIkSU5TVEFMTF9ESVIiIF07IHRoZW4KICAgICAgICBybSAtcmYgIiRJTlNUQUxMX0RJUiIKICAgIGZpCgogICAgZWNobyAtZSAiJEZVQ0sgJHtDX0dSRUVOfUknbSBnb25lLiBEb24ndCBjb21lIGNyeWluZyBiYWNrLiR7Q19SRVNFVH0iCiAgICBlY2hvIC1lICIke0NfQ1lBTn1Ob3cgcmVzdGFydCB5b3VyIGRhbW4gc2hlbGwuJHtDX1JFU0VUfSIKfQoKIyBUaGUgbWFpbiBmdW5jdGlvbiB0aGF0IGNvbnRhY3RzIHRoZSBBUEkKIyBUYWtlcyA+MCBhcmd1bWVudHMgYXMgdGhlIHByb21wdApfZnVja19leGVjdXRlX3Byb21wdCgpIHsKICAgICMgSWYgdGhlIHVzZXIgdHlwZXMgKm9ubHkqICJmdWNrIHVuaW5zdGFsbCIKICAgIGlmIFsgIiQxIiA9ICJ1bmluc3RhbGwiIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfdW5pbnN0YWxsX3NjcmlwdAogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgICMgSWYgdGhlIHVzZXIgdHlwZXMgImZ1Y2sgY29uZmlnIgogICAgaWYgWyAiJDEiID0gImNvbmZpZyIgXSAmJiBbICIkIyIgLWVxIDEgXTsgdGhlbgogICAgICAgIF9mdWNrX3Nob3dfY29uZmlnX2hlbHAKICAgICAgICByZXR1cm4gMAogICAgZmkKCiAgICBpZiAhIGNvbW1hbmQgLXYgY3VybCAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfSdmdWNrJyBjb21tYW5kIG5lZWRzICdjdXJsJy4gUGxlYXNlIGluc3RhbGwgaXQuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgaWYgWyAiJCMiIC1lcSAwIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfVlvdSBmb3Jnb3QgdG8gYXNrIG1lIHdoYXQgdG8gZG8uJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgbG9jYWwgcHJvbXB0PSIkKiIKICAgIGxvY2FsIGF1dG9fbW9kZT0iJHtGVUNLX0FVVE9fRVhFQzotMH0iCiAgICBsb2NhbCBjdXJsX3RpbWVvdXQ9IiR7RlVDS19USU1FT1VUOi0zMH0iCiAgICBsb2NhbCBzeXNpbmZvX3N0cmluZwogICAgc3lzaW5mb19zdHJpbmc9JChfZnVja19jb2xsZWN0X3N5c2luZm9fc3RyaW5nKQogICAgCiAgICBsb2NhbCBlc2NhcGVkX3Byb21wdAogICAgZXNjYXBlZF9wcm9tcHQ9JChfZnVja19qc29uX2VzY2FwZSAiJHByb21wdCIpCiAgICAKICAgIGxvY2FsIGVzY2FwZWRfc3lzaW5mbwogICAgZXNjYXBlZF9zeXNpbmZvPSQoX2Z1Y2tfanNvbl9lc2NhcGUgIiRzeXNpbmZvX3N0cmluZyIpCgogICAgIyBDb25zdHJ1Y3QgdGhlIEpTT04gcGF5bG9hZAogICAgbG9jYWwgcGF5bG9hZAogICAgcGF5bG9hZD0kKHByaW50ZiAneyAic3lzaW5mbyI6ICIlcyIsICJwcm9tcHQiOiAiJXMiIH0nICIkZXNjYXBlZF9zeXNpbmZvIiAiJGVzY2FwZWRfcHJvbXB0IikKCiAgICAjIFVzZSBjb25maWd1cmVkIEFQSSBlbmRwb2ludCBvciBkZWZhdWx0CiAgICBsb2NhbCBhcGlfdXJsPSIke0ZVQ0tfQVBJX0VORFBPSU5UOi0kREVGQVVMVF9BUElfRU5EUE9JTlR9IgoKICAgIF9mdWNrX2RlYnVnICJBUEkgVVJMOiAkYXBpX3VybCIKICAgIF9mdWNrX2RlYnVnICJQYXlsb2FkOiAkcGF5bG9hZCIKCiAgICBlY2hvIC1uZSAiJHtDX1lFTExPV31UaGlua2luZy4uLiR7Q19SRVNFVH0iCiAgICAKICAgIGxvY2FsIHRtcF9yZXNwb25zZQogICAgdG1wX3Jlc3BvbnNlPSQobWt0ZW1wKQogICAgCiAgICAjIENhbGwgQVBJIGluIGJhY2tncm91bmQKICAgICgKICAgICAgICBjdXJsIC1zUyAtLW1heC10aW1lICIkY3VybF90aW1lb3V0IiAtWCBQT1NUICIkYXBpX3VybCIgXAogICAgICAgICAgICAtSCAiQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uIiBcCiAgICAgICAgICAgIC1kICIkcGF5bG9hZCIgPiAiJHRtcF9yZXNwb25zZSIgMj4mMQogICAgKSAmICAgIGxvY2FsIHBpZD0kIQogICAgCiAgICBfZnVja19zcGlubmVyICIkcGlkIgogICAgaWYgd2FpdCAiJHBpZCI7IHRoZW4KICAgICAgICBleGl0X2NvZGU9MAogICAgZWxzZQogICAgICAgIGV4aXRfY29kZT0kPwogICAgZmkKICAgIAogICAgZWNobyAiIiAjIE5ld2xpbmUgYWZ0ZXIgc3Bpbm5lcgoKICAgIGxvY2FsIHJlc3BvbnNlCiAgICBpZiBbIC1mICIkdG1wX3Jlc3BvbnNlIiBdOyB0aGVuCiAgICAgICAgcmVzcG9uc2U9JChjYXQgIiR0bXBfcmVzcG9uc2UiKQogICAgICAgIHJtIC1mICIkdG1wX3Jlc3BvbnNlIgogICAgZWxzZQogICAgICAgIHJlc3BvbnNlPSIiCiAgICBmaQoKICAgIGlmIFsgJGV4aXRfY29kZSAtbmUgMCBdIHx8IFsgLXogIiRyZXNwb25zZSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9Q291bGRuJ3QgcmVhY2ggdGhlIEFJIHNlcnZpY2Ugb3IgZ290IGVtcHR5IHJlc3BvbnNlLiR7Q19SRVNFVH0iID4mMgogICAgICAgIFsgLW4gIiRyZXNwb25zZSIgXSAmJiBlY2hvIC1lICIke0NfRElNfSRyZXNwb25zZSR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMgLS0tIFVzZXIgQ29uZmlybWF0aW9uIChhcyByZXF1ZXN0ZWQpIC0tLQogICAgZWNobyAtZSAiJHtDX0NZQU59SGVyZSBpcyB3aGF0IEkgY2FtZSB1cCB3aXRoOiR7Q19SRVNFVH0iCiAgICBlY2hvIC1lICIke0NfRElNfS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0ke0NfUkVTRVR9IgogICAgZWNobyAtZSAiJHtDX0dSRUVOfSR7cmVzcG9uc2V9JHtDX1JFU0VUfSIKICAgIGVjaG8gLWUgIiR7Q19ESU19LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSR7Q19SRVNFVH0iCiAgICAKICAgICMgQ2hlY2sgaWYgYXV0by1leGVjIG1vZGUgaXMgZW5hYmxlZAogICAgbG9jYWwgc2hvdWxkX2V4ZWM9ZmFsc2UKICAgIGlmIF9mdWNrX3RydXRoeSAiJGF1dG9fbW9kZSI7IHRoZW4KICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfeKaoSBBdXRvLWV4ZWMgZW5hYmxlZC4gUnVubmluZy4uLiR7Q19SRVNFVH0iCiAgICAgICAgc2hvdWxkX2V4ZWM9dHJ1ZQogICAgZWxzZQogICAgICAgICMgSW50ZXJhY3RpdmUgY29uZmlybWF0aW9uCiAgICAgICAgd2hpbGUgdHJ1ZTsgZG8KICAgICAgICAgICAgcHJpbnRmICIke0NfQk9MRH1FeGVjdXRlPyBbWS9uXSAke0NfUkVTRVR9IgogICAgICAgICAgICBsb2NhbCBjb25maXJtYXRpb24KICAgICAgICAgICAgaWYgWyAtciAvZGV2L3R0eSBdOyB0aGVuCiAgICAgICAgICAgICAgICByZWFkIC1yIC1uIDEgY29uZmlybWF0aW9uIDwgL2Rldi90dHkKICAgICAgICAgICAgICAgIGVjaG8gIiIgIyBOZXdsaW5lCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICMgRmFsbGJhY2sgZm9yIG5vIFRUWQogICAgICAgICAgICAgICAgcmVhZCAtciBjb25maXJtYXRpb24KICAgICAgICAgICAgZmkKCiAgICAgICAgICAgIGNhc2UgIiRjb25maXJtYXRpb24iIGluCiAgICAgICAgICAgICAgICBbeVldfCIiKQogICAgICAgICAgICAgICAgICAgIHNob3VsZF9leGVjPXRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICBbbk5dKQogICAgICAgICAgICAgICAgICAgIHNob3VsZF9leGVjPWZhbHNlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgKikKICAgICAgICAgICAgICAgICAgICAjIExvb3AgYWdhaW4KICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICBlc2FjCiAgICAgICAgZG9uZQogICAgZmkKCiAgICBpZiBbICIkc2hvdWxkX2V4ZWMiID0gInRydWUiIF07IHRoZW4KICAgICAgICAjIEV4ZWN1dGUgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBhbmQgY2hlY2sgaXRzIGV4aXQgY29kZQogICAgICAgIGlmIGV2YWwgIiRyZXNwb25zZSI7IHRoZW4KICAgICAgICAgICAgZWNobyAtZSAiJHtDX0dSRUVOfURvbmUuJHtDX1JFU0VUfSIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGxvY2FsIGV4aXRfY29kZT0kPwogICAgICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfUNvbW1hbmQgZmFpbGVkIHdpdGggZXhpdCBjb2RlICRleGl0X2NvZGUuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgICAgIHJldHVybiAkZXhpdF9jb2RlCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfUFib3J0ZWQuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCn0KCiMgRGVmaW5lIHRoZSBhbGlhcyBmb3IgaW50ZXJhY3RpdmUgdXNlIChzdXBwb3J0cyBjdXN0b20gYWxpYXNlcykKX2Z1Y2tfZGVmaW5lX2FsaWFzZXMoKSB7CiAgICBsb2NhbCBkZWZhdWx0X2FsaWFzPSJmdWNrIgoKICAgIGlmICEgX2Z1Y2tfdHJ1dGh5ICIke0ZVQ0tfRElTQUJMRV9ERUZBVUxUX0FMSUFTOi0wfSI7IHRoZW4KICAgICAgICBhbGlhcyAiJGRlZmF1bHRfYWxpYXMiPSdfZnVja19leGVjdXRlX3Byb21wdCcKICAgIGZpCgogICAgaWYgWyAtbiAiJHtGVUNLX0FMSUFTOi19IiBdICYmIFsgIiRGVUNLX0FMSUFTIiAhPSAiJGRlZmF1bHRfYWxpYXMiIF07IHRoZW4KICAgICAgICBhbGlhcyAiJEZVQ0tfQUxJQVMiPSdfZnVja19leGVjdXRlX3Byb21wdCcKICAgIGZpCn0KCl9mdWNrX2RlZmluZV9hbGlhc2VzCgojIC0tLSBFbmQgQ29yZSBMb2dpYyAtLS0KRU9GCgojIC0tLSBFbmQgb2YgQ29yZSBMb2dpYyBIZXJlZG9jIC0tLQoKCiMgLS0tIEluc3RhbGxlciBGdW5jdGlvbnMgKFJ1biBieSB0aGUgb3V0ZXIgc2NyaXB0KSAtLS0KCiMgSGVscGVyIHRvIGZpbmQgdGhlIHVzZXIncyBzaGVsbCBwcm9maWxlIGZpbGUKX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSgpIHsKICAgIGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgInpzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uenNocmMiCiAgICBlbGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgImJhc2giOyB0aGVuCiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnByb2ZpbGUiIF07IHRoZW4KICAgICAgICAjIEZhbGxiYWNrIGZvciBzaCwga3NoLCBldGMuCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLmJhc2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy5iYXNocmMiCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93bl9wcm9maWxlIgogICAgZmkKfQoKIyBNYWluIGluc3RhbGxhdGlvbiBmdW5jdGlvbgpfaW5zdGFsbF9zY3JpcHQoKSB7CiAgICBlY2hvIC1lICIkRkNLTiAke0NfQk9MRH1BbHJpZ2h0LCBsZXQncyBnZXQgdGhpcyBzaGl0IGluc3RhbGxlZC4uLiR7Q19SRVNFVH0iCiAgICBta2RpciAtcCAiJElOU1RBTExfRElSIgogICAgCiAgICAjIFdyaXRlIHRoZSBlbWJlZGRlZCBjb3JlIGxvZ2ljIHRvIHRoZSBtYWluLnNoIGZpbGUKICAgIGVjaG8gIiRDT1JFX0xPR0lDIiA+ICIkTUFJTl9TSCIKICAgIAogICAgaWYgWyAkPyAtbmUgMCBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1DYW4ndCB3cml0ZSB0byB0aGUgZmlsZS4gQ2hlY2sgeW91ciBkYW1uIHBlcm1pc3Npb25zLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMgQ3JlYXRlIGEgZGVmYXVsdCBjb25maWcgZmlsZSBpZiBpdCBkb2Vzbid0IGV4aXN0CiAgICBpZiBbICEgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgICAgIGNhdCA8PCdDRkcnID4gIiRDT05GSUdfRklMRSIKIyBmdWNraXQuc2ggY29uZmlndXJhdGlvbgojIFRvZ2dsZSB0aGUgZXhwb3J0cyBiZWxvdyB0byBjdXN0b21pc2UgeW91ciBleHBlcmllbmNlLgoKIyBDdXN0b20gQVBJIGVuZHBvaW50IHRoYXQgcG9pbnRzIHRvIHlvdXIgc2VsZi1ob3N0ZWQgd29ya2VyCiMgZXhwb3J0IEZVQ0tfQVBJX0VORFBPSU5UPSJodHRwczovL3lvdXItZG9tYWluLndvcmtlcnMuZGV2LyIKCiMgU2tpcCBjb25maXJtYXRpb24gcHJvbXB0cyAodXNlIHdpdGggY2F1dGlvbiEpCiMgZXhwb3J0IEZVQ0tfQVVUT19FWEVDPTAKCiMgT3ZlcnJpZGUgY3VybCB0aW1lb3V0IChzZWNvbmRzKQojIGV4cG9ydCBGVUNLX1RJTUVPVVQ9MzAKCiMgRW5hYmxlIHZlcmJvc2UgZGVidWcgbG9ncwojIGV4cG9ydCBGVUNLX0RFQlVHPTAKQ0ZHCiAgICBmaQoKICAgICMgQWRkIHNvdXJjZSBsaW5lIHRvIHNoZWxsIHByb2ZpbGUKICAgIGxvY2FsIHByb2ZpbGVfZmlsZQogICAgcHJvZmlsZV9maWxlPSQoX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSkKICAgIAogICAgaWYgWyAiJHByb2ZpbGVfZmlsZSIgPSAidW5rbm93bl9wcm9maWxlIiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1JIGNhbid0IGZpbmQgLmJhc2hyYywgLnpzaHJjLCBvciAucHJvZmlsZS4gWW91J3JlIG9uIHlvdXIgb3duLiR7Q19SRVNFVH0iID4mMgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9TWFudWFsbHkgYWRkIHRoaXMgbGluZSB0byB3aGF0ZXZlciBzdGFydHVwIGZpbGUgeW91IHVzZToke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICJcbiAgJHtDX0NZQU59c291cmNlICRNQUlOX1NIJHtDX1JFU0VUfVxuIiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCiAgICBpZiAhIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICMgRW5zdXJlIHRoZSBmaWxlIGVuZHMgd2l0aCBhIG5ld2xpbmUgYmVmb3JlIHdlIGFkZCBvdXIgbGluZXMKICAgICAgICBpZiBbIC1uICIkKHRhaWwgLWMxICIkcHJvZmlsZV9maWxlIikiIF07IHRoZW4KICAgICAgICAgICAgZWNobyAiIiA+PiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBmaQogICAgICAgIGVjaG8gIiMgQWRkZWQgYnkgZnVja2l0LnNoIGluc3RhbGxlciIgPj4gIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZWNobyAiJHNvdXJjZV9saW5lIiA+PiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfR1JFRU59SXQncyBpbnN0YWxsZWQuIE5vdyBnZXQgdG8gd29yay4ke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9UmVzdGFydCB5b3VyIHNoZWxsLCBvciBydW4gJHtDX0JPTER9c291cmNlICRwcm9maWxlX2ZpbGUke0NfWUVMTE9XfSB0byBzdGFydC4ke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIlxuJHtDX0JPTER9LS0tIEhPVyBUTyBVU0UgLS0tJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICJKdXN0IHR5cGUgJHtDX1JFRF9CT0xEfWZ1Y2ske0NfUkVTRVR9IGZvbGxvd2VkIGJ5IHdoYXQgeW91IHdhbnQgdG8gZG8uIgogICAgICAgIGVjaG8gLWUgIkV4YW1wbGVzOiIKICAgICAgICBlY2hvIC1lICIgICR7Q19DWUFOfWZ1Y2sgaW5zdGFsbCBnaXQke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX0NZQU59ZnVjayB1bmluc3RhbGwgZ2l0JHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19DWUFOfWZ1Y2sgZmluZCBhbGwgZmlsZXMgbGFyZ2VyIHRoYW4gMTBNQiBpbiB0aGUgY3VycmVudCBkaXJlY3Rvcnkke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX1JFRF9CT0xEfWZ1Y2sgdW5pbnN0YWxsJHtDX1JFU0VUfSAke0NfR1JFRU59IyBVbmluc3RhbGxzICR7Q19SRVNFVH0ke0NfUkVEfWZ1Y2ske0NfUkVTRVR9JHtDX0dSRUVOfSBpdHNlbGYke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX1JFRF9CT0xEfWZ1Y2sgY29uZmlnJHtDX1JFU0VUfSAke0NfR1JFRU59IyBTaG93IGNvbmZpZ3VyYXRpb24gaGVscCR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiXG4ke0NfWUVMTE9XfVJlbWVtYmVyIHRvIHJlc3RhcnQgeW91ciBzaGVsbCB0byBiZWdpbiEke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19ZRUxMT1d9SXQncyBhbHJlYWR5IGluc3RhbGxlZCwgZ2VuaXVzLiBKdXN0IHVwZGF0ZWQgdGhlIHNjcmlwdCBmb3IgeW91LiR7Q19SRVNFVH0iCiAgICBmaQp9CgoKIyAtLS0gTWFpbiBTY3JpcHQgRW50cnlwb2ludCAtLS0KCiMgSWYgYXJndW1lbnRzIGFyZSBwYXNzZWQgKGUuZy4sICJiYXNoIC1zIC4uLiIpCmlmIFsgIiQjIiAtZ3QgMCBdOyB0aGVuCiAgICAjIFRlbXBvcmFyeSBNb2RlCiAgICAjIEV2YWx1YXRlIHRoZSBjb3JlIGxvZ2ljIHRvIGRlZmluZSBmdW5jdGlvbnMgaW4gdGhpcyBzaGVsbAogICAgZXZhbCAiJENPUkVfTE9HSUMiCiAgICAjIENhbGwgdGhlIG1haW4gZnVuY3Rpb24gZGlyZWN0bHkgKGFsaWFzIHdvbid0IHdvcmsgaGVyZSkKICAgIF9mdWNrX2V4ZWN1dGVfcHJvbXB0ICIkQCIKZWxzZQogICAgIyBJbnN0YWxsIE1vZGUKICAgIF9pbnN0YWxsX3NjcmlwdApmaQo=`);
const INSTALLER_SCRIPT_ZH = b64_to_utf8(`IyEvYmluL2Jhc2gKIwojIOi/meaYryBmdWNraXQuc2gg55qE5a6J6KOF5ZKM5Li05pe26L+Q6KGM6ISa5pysCiMg5qyi6L+O5L2/55SoCiMKIyAtLS0g5a6J5YWo5L2/55So5pa55rOVIC0tLQojCiMgMS4g5LiL6L29OgojICAgIGN1cmwgLW8gZnVja2l0LnNoIGh0dHBzOi8vZnVja2l0cy4yNTUwMDU1Mi54eXovemgKIwojIDIuIOafpeeci+S7o+eggToKIyAgICBsZXNzIGZ1Y2tpdC5zaAojCiMgMy4g6L+Q6KGMICjlronoo4UpOgojICAgIGJhc2ggZnVja2l0LnNoCiMKIyA0LiDov5DooYwgKOS4tOaXtuS9v+eUqCk6CiMgICAgYmFzaCBmdWNraXQuc2ggIuS9oOeahOWRveS7pCIKIwoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgLS0tIOminOiJsuWumuS5iSAtLS0KcmVhZG9ubHkgQ19SRVNFVD0nXDAzM1swbScKcmVhZG9ubHkgQ19SRURfQk9MRD0nXDAzM1sxOzMxbScKcmVhZG9ubHkgQ19SRUQ9J1wwMzNbMDszMW0nCnJlYWRvbmx5IENfR1JFRU49J1wwMzNbMDszMm0nCnJlYWRvbmx5IENfWUVMTE9XPSdcMDMzWzA7MzNtJwpyZWFkb25seSBDX0NZQU49J1wwMzNbMDszNm0nCnJlYWRvbmx5IENfQk9MRD0nXDAzM1sxbScKcmVhZG9ubHkgQ19ESU09J1wwMzNbMm0nCgojIC0tLSDmj5DnpLrnrKYgLS0tCnJlYWRvbmx5IEZVQ0s9IiR7Q19SRURfQk9MRH1bIV0ke0NfUkVTRVR9IgpyZWFkb25seSBGQ0tOPSIke0NfUkVEfVvmj5DnpLpdJHtDX1JFU0VUfSIKCgojIC0tLSDphY3nva4gLS0tCmlmIFsgLXogIiR7SE9NRTotfSIgXTsgdGhlbgogICAgZWNobyAtZSAiXDAzM1sxOzMxbemUmeivryFcMDMzWzBtIFwwMzNbMDszMW3mgqjnmoQgSE9NRSDnjq/looPlj5jph4/mnKrorr7nva7vvIzml6Dms5Xnoa7lrprlronoo4XkvY3nva7vvIzor7flhYjorr7nva7or6Xlj5jph4/jgIIgKOS+i+WmgjogZXhwb3J0IEhPTUU9L3Jvb3QpXDAzM1swbSIgPiYyCiAgICBleGl0IDEKZmkKcmVhZG9ubHkgSU5TVEFMTF9ESVI9IiRIT01FLy5mdWNrIgpyZWFkb25seSBNQUlOX1NIPSIkSU5TVEFMTF9ESVIvbWFpbi5zaCIKcmVhZG9ubHkgQ09ORklHX0ZJTEU9IiRJTlNUQUxMX0RJUi9jb25maWcuc2giCgoKIyAtLS0g5qC45b+D6YC76L6RICjloZ7ov5vkuIDkuKrlrZfnrKbkuLLph4wpIC0tLQpyZWFkIC1yIC1kICcnIENPUkVfTE9HSUMgPDwnRU9GJyB8fCB0cnVlCgojIC0tLSBmdWNraXQuc2gg5qC45b+D6YC76L6R5byA5aeLIC0tLQoKIyAtLS0g6aKc6Imy5a6a5LmJIC0tLQojIOWPquacieWcqOayoeWumuS5iei/h+minOiJsueahOaDheWGteS4i+aJjeWumuS5iSAo5Li05pe25qih5byP55SoKQppZiBbIC16ICIke0NfUkVTRVQ6LX0iIF07IHRoZW4KICAgIHJlYWRvbmx5IENfUkVTRVQ9J1wwMzNbMG0nCiAgICByZWFkb25seSBDX1JFRF9CT0xEPSdcMDMzWzE7MzFtJwogICAgcmVhZG9ubHkgQ19SRUQ9J1wwMzNbMDszMW0nCiAgICByZWFkb25seSBDX0dSRUVOPSdcMDMzWzA7MzJtJwogICAgcmVhZG9ubHkgQ19ZRUxMT1c9J1wwMzNbMDszM20nCiAgICByZWFkb25seSBDX0NZQU49J1wwMzNbMDszNm0nCiAgICByZWFkb25seSBDX0JPTEQ9J1wwMzNbMW0nCiAgICByZWFkb25seSBDX0RJTT0nXDAzM1sybScKCiAgICAjIC0tLSDmj5DnpLrnrKYgLS0tCiAgICByZWFkb25seSBGVUNLPSIke0NfUkVEX0JPTER9WyFdJHtDX1JFU0VUfSIKICAgIHJlYWRvbmx5IEZDS049IiR7Q19SRUR9W+aPkOekul0ke0NfUkVTRVR9IgoKICAgICMgLS0tIOmFjee9riAtLS0KICAgIGlmIFsgLXogIiR7SE9NRTotfSIgXTsgdGhlbgogICAgICAgICMg6L+Z6YOo5YiG5piv57uZ5Li05pe26L+Q6KGM5qih5byP55So55qE77yM5a6D5LiN5a6J6KOF5Lu75L2V5Lic6KW/CiAgICAgICAgIyDkvYbmiJHku6zov5jmmK/pnIDopoHlrprkuYnov5nkupvlj5jph4/vvIzlhY3lvpfohJrmnKzmiqXplJkKICAgICAgICAjIOWuieijheeoi+W6j+mDqOWIhuS8mui/m+ihjOecn+ato+eahOajgOafpQogICAgICAgIHJlYWRvbmx5IElOU1RBTExfRElSPSIvdG1wLy5mdWNrIgogICAgICAgIHJlYWRvbmx5IE1BSU5fU0g9Ii90bXAvLmZ1Y2svbWFpbi5zaCIKICAgICAgICByZWFkb25seSBDT05GSUdfRklMRT0iL3RtcC8uZnVjay9jb25maWcuc2giCiAgICBlbHNlCiAgICAgICAgcmVhZG9ubHkgSU5TVEFMTF9ESVI9IiRIT01FLy5mdWNrIgogICAgICAgIHJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgogICAgICAgIHJlYWRvbmx5IENPTkZJR19GSUxFPSIkSU5TVEFMTF9ESVIvY29uZmlnLnNoIgogICAgZmkKZmkKCiMg5aaC5p6c5a2Y5Zyo6YWN572u5paH5Lu25YiZ5Yqg6L29CmlmIFsgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgc291cmNlICIkQ09ORklHX0ZJTEUiCmZpCgppZiBbIC16ICIke0RFRkFVTFRfQVBJX0VORFBPSU5UK3h9IiBdOyB0aGVuCiAgICByZWFkb25seSBERUZBVUxUX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly9mdWNraXRzLjI1NTAwNTUyLnh5ei96aCIKZmkKCiMg5om+55So5oi3IHNoZWxsIOmFjee9ruaWh+S7tueahOi+heWKqeWHveaVsApfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMg5YW85a65IHNoLCBrc2gg562JCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgU0hFTEwg5Y+Y6YeP5rKh6K6+572u5pe255qE5aSH55So5pa55qGICiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBTSEVMTCDlj5jph4/msqHorr7nva7ml7bnmoTlpIfnlKjmlrnmoYgKICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxzZQogICAgICAgIGVjaG8gInVua25vd25fcHJvZmlsZSIKICAgIGZpCn0KCiMg5qOA5rWL5YyF566h55CG5ZmoCl9mdWNrX2RldGVjdF9wa2dfbWFuYWdlcigpIHsKICAgIGlmIGNvbW1hbmQgLXYgYXB0LWdldCAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJhcHQiCiAgICBlbGlmIGNvbW1hbmQgLXYgeXVtICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gInl1bSIKICAgIGVsaWYgY29tbWFuZCAtdiBkbmYgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAiZG5mIgogICAgZWxpZiBjb21tYW5kIC12IHBhY21hbiAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJwYWNtYW4iCiAgICBlbGlmIGNvbW1hbmQgLXYgenlwcGVyICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gInp5cHBlciIKICAgIGVsaWYgY29tbWFuZCAtdiBicmV3ICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gImJyZXciCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93biIKICAgIGZpCn0KCiMg5oqK57O757uf5L+h5oGv5pW05oiQ5LiA5Liq5a2X56ym5LiyCl9mdWNrX2NvbGxlY3Rfc3lzaW5mb19zdHJpbmcoKSB7CiAgICBsb2NhbCBwa2dfbWFuYWdlcgogICAgcGtnX21hbmFnZXI9JChfZnVja19kZXRlY3RfcGtnX21hbmFnZXIpCiAgICAjIOacjeWKoeerr+eahCBMTE0g5b6X6IO955yL5oeC6L+Z5Liq5a2X56ym5LiyCiAgICBlY2hvICJPUzogJCh1bmFtZSAtcyksIEFyY2g6ICQodW5hbWUgLW0pLCBTaGVsbDogJHtTSEVMTDotdW5rbm93bn0sIFBrZ01ncjogJHBrZ19tYW5hZ2VyLCBDV0Q6ICQocHdkKSIKfQoKIyBKU09OIOi9rOS5ie+8jOWFjeW+l+WHuumXrumimApfZnVja19qc29uX2VzY2FwZSgpIHsKICAgICMg5bCx6L2s5LmJ6YKj5Yeg5Liq54m55q6K5a2X56ymCiAgICBwcmludGYgJyVzJyAiJDEiIHwgc2VkIC1lICdzL1xcL1xcXFwvZycgLWUgJ3MvIi9cIi9nJyAtZSAncy9cbi9cXG4vZycgLWUgJ3MvXHIvXFxyL2cnIC1lICdzL1x0L1xcdC9nJwp9CgojIOWIpOaWreaYr+WQpuS4uiB0cnVlL3llcy9vbiDnrYkKX2Z1Y2tfdHJ1dGh5KCkgewogICAgbG9jYWwgdmFsdWU9IiR7MTotfSIKICAgIGxvY2FsIG5vcm1hbGl6ZWQKICAgIG5vcm1hbGl6ZWQ9JChwcmludGYgJyVzJyAiJHZhbHVlIiB8IHRyICdbOnVwcGVyOl0nICdbOmxvd2VyOl0nKQogICAgY2FzZSAiJG5vcm1hbGl6ZWQiIGluCiAgICAgICAgMXx0cnVlfHllc3x5fG9ufOaYr3zlvIB855yfKQogICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICA7OwogICAgICAgICopCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIDs7CiAgICBlc2FjCn0KCiMg6LCD6K+V5pel5b+XCl9mdWNrX2RlYnVnKCkgewogICAgaWYgX2Z1Y2tfdHJ1dGh5ICIke0ZVQ0tfREVCVUc6LTB9IjsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ESU19W+iwg+ivlV0gJCoke0NfUkVTRVR9IiA+JjIKICAgIGZpCn0KCiMgU3Bpbm5lciDliqjnlLsKX2Z1Y2tfc3Bpbm5lcigpIHsKICAgIGxvY2FsIHBpZD0kMQogICAgbG9jYWwgZGVsYXk9MC4xCiAgICBsb2NhbCBzcGluc3RyPSd8Ly1cJwogICAgCiAgICAjIOmakOiXj+WFieaghwogICAgdHB1dCBjaXZpcyAyPi9kZXYvbnVsbCB8fCBwcmludGYgIlwwMzNbPzI1bCIKCiAgICB3aGlsZSBraWxsIC0wICIkcGlkIiAyPi9kZXYvbnVsbDsgZG8KICAgICAgICBsb2NhbCB0ZW1wPSR7c3BpbnN0ciM/fQogICAgICAgIHByaW50ZiAiIFslY10gICIgIiRzcGluc3RyIgogICAgICAgIGxvY2FsIHNwaW5zdHI9JHRlbXAke3NwaW5zdHIlIiR0ZW1wIn0KICAgICAgICBzbGVlcCAkZGVsYXkKICAgICAgICBwcmludGYgIlxiXGJcYlxiXGJcYiIKICAgIGRvbmUKICAgIHByaW50ZiAiICAgIFxiXGJcYlxiIgogICAgCiAgICAjIOaBouWkjeWFieaghwogICAgdHB1dCBjbm9ybSAyPi9kZXYvbnVsbCB8fCBwcmludGYgIlwwMzNbPzI1aCIKfQoKIyDnoa7kv53phY3nva7mlofku7blrZjlnKgKX2Z1Y2tfZW5zdXJlX2NvbmZpZ19leGlzdHMoKSB7CiAgICBpZiBbIC1mICIkQ09ORklHX0ZJTEUiIF07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCgogICAgbWtkaXIgLXAgIiQoZGlybmFtZSAiJENPTkZJR19GSUxFIikiCiAgICBjYXQgPDwnQ0ZHJyA+ICIkQ09ORklHX0ZJTEUiCiMgZnVja2l0LnNoIOmFjee9ruaWh+S7tuekuuS+iwojIOWOu+aOieihjOmmlueahCAjIOW5tuS/ruaUueS4uuS9oOaDs+imgeeahOWAvOWNs+WPr+OAggoKIyDoh6rlrprkuYkgQVBJIOWFpeWPo++8iOWmguiHquW7uiBXb3JrZXLvvIkKIyBleHBvcnQgRlVDS19BUElfRU5EUE9JTlQ9Imh0dHBzOi8veW91ci1kb21haW4ud29ya2Vycy5kZXYvIgoKIyDpop3lpJbliKvlkI3vvIjpu5jorqTmj5DkvpsgZnVja++8iQojIGV4cG9ydCBGVUNLX0FMSUFTPSLov5DooYwiCgojIOiHquWKqOaJp+ihjOi/lOWbnueahOWRveS7pO+8jOi3s+i/h+ehruiupO+8iOiwqOaFjuW8gOWQr++8iQojIGV4cG9ydCBGVUNLX0FVVE9fRVhFQz1mYWxzZQoKIyDor7fmsYLotoXml7bml7bpl7TvvIjnp5LvvIkKIyBleHBvcnQgRlVDS19USU1FT1VUPTMwCgojIOaYr+WQpuaJk+WNsOiwg+ivleS/oeaBrwojIGV4cG9ydCBGVUNLX0RFQlVHPWZhbHNlCgojIOS4jeWGjeiHquWKqOazqOWFpem7mOiupOWIq+WQjQojIGV4cG9ydCBGVUNLX0RJU0FCTEVfREVGQVVMVF9BTElBUz1mYWxzZQpDRkcKfQoKIyDmmL7npLrphY3nva7mj5DnpLoKX2Z1Y2tfc2hvd19jb25maWdfaGVscCgpIHsKICAgIF9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfemFjee9ruaWh+S7tu+8miR7Q19SRVNFVH0gJHtDX0NZQU59JENPTkZJR19GSUxFJHtDX1JFU0VUfSIKICAgIGlmIFsgLW4gIiR7RURJVE9SOi19IiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33lj6/ku6Xkvb/nlKjvvJoke0NfUkVTRVR9ICR7Q19DWUFOfSR7RURJVE9SfSAkQ09ORklHX0ZJTEUke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d955So5Lu75oSP57yW6L6R5Zmo5omT5byA6K+l5paH5Lu25Y2z5Y+v5L+u5pS56YWN572u44CCJHtDX1JFU0VUfSIKICAgIGZpCiAgICBlY2hvIC1lICIke0NfQ1lBTn3lj6/nlKjpgInpobnvvJoke0NfUkVTRVR9RlVDS19BUElfRU5EUE9JTlQsIEZVQ0tfQUxJQVMsIEZVQ0tfQVVUT19FWEVDLCBGVUNLX1RJTUVPVVQsIEZVQ0tfREVCVUciCn0KCiMg5Y246L296ISa5pysCl91bmluc3RhbGxfc2NyaXB0KCkgewogICAgZWNobyAtZSAiJHtDX1JFRF9CT0xEfeWlveWlveWlve+8gSR7Q19SRVNFVH0ke0NfWUVMTE9XfeaAjuS5iOedgO+8jOimgeWNuOejqOadgOmptOWViu+8n+ihjOWViuS9oOS4quiAgeWFre+8jOaIkeecn+iwouiwouS9oOS6huOAgiR7Q19SRVNFVH0iCgogICAgIyDmib7phY3nva7mlofku7YKICAgIGxvY2FsIHByb2ZpbGVfZmlsZQogICAgcHJvZmlsZV9maWxlPSQoX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSkKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCgogICAgaWYgWyAiJHByb2ZpbGVfZmlsZSIgIT0gInVua25vd25fcHJvZmlsZSIgXSAmJiBbIC1mICIkcHJvZmlsZV9maWxlIiBdOyB0aGVuCiAgICAgICAgaWYgZ3JlcCAtcUYgIiRzb3VyY2VfbGluZSIgIiRwcm9maWxlX2ZpbGUiOyB0aGVuCiAgICAgICAgICAgICMg55SoIHNlZCDmiorpgqPlh6DooYzliKDkuobvvIzpobrkvr/lpIfkuKrku70KICAgICAgICAgICAgc2VkIC1pLmJhayAifCRzb3VyY2VfbGluZXxkIiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICAgICAgc2VkIC1pLmJhayAifCMgQWRkZWQgYnkgZnVja2l0LnNoIGluc3RhbGxlcnxkIiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBmaQogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95om+5LiN5YiwIHNoZWxsIOmFjee9ruaWh+S7tu+8jOaCqOWPr+S7peaJi+WKqOWIoOmZpOebuOWFs+mFjee9ruOAgiR7Q19SRVNFVH0iCiAgICBmaQoKICAgIGlmIFsgLWQgIiRJTlNUQUxMX0RJUiIgXTsgdGhlbgogICAgICAgIHJtIC1yZiAiJElOU1RBTExfRElSIgogICAgZmkKCiAgICBzbGVlcCAzCiAgICBlY2hvIC1lICIke0NfR1JFRU596KGM77yM5oiR5YWI6LWw5LiA5q2l77yM5ZGK6L6e44CCJHtDX0NZQU596LW257Sn6YeN5ZCv5L2g6YKj57uI56uv5ZCn77yM5LiN54S25Lya5Yir5ZCN5rGh5p+T44CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDMKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95Li05Yir5LmL6ZmF77yM54yu5LiK5LiA6aaW5bCP6K+X77yM56Wd5oKo5YmN56iL5Ly86ZSm77yaJHtDX1JFU0VUfSIKICAgIHNsZWVwIDIKICAgIGVjaG8gLWUgIlxuJHtDX1JFRH3jgIror5fnu4/Ct+W9vOmYs+OAiyR7Q19SRVNFVH0iCiAgICBzbGVlcCAyCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfeW9vOmYs+iLpeiHs++8jOWIneWNh+S4nOabpuOAgiR7Q19SRVNFVH0iCiAgICBzbGVlcCAyCiAgICBlY2hvIC1lICIke0NfWUVMTE9Xfee7r+mbvumjkuiUve+8jOS8vOW5lee7oee7uOOAgiR7Q19SRVNFVH0iCiAgICBzbGVlcCAzCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfeW9vOmYs+evneeip++8jOmbvumcgua2p+a7geOAgiR7Q19SRVNFVH0iCiAgICBzbGVlcCA0CiAgICBlY2hvIC1lICIke0NfWUVMTE9Xfei1pOefs+WGrOa6qu+8jOS8vOeOm+eRmea9reOAgiR7Q19SRVNFVH0iCiAgICBzbGVlcCA0CiAgICBlY2hvIC1lICIke0NfWUVMTE9XfeW9vOmYs+aZmuaEj++8jOaaluaipuS8vOS5kOOAgiR7Q19SRVNFVH0iCiAgICBzbGVlcCAzCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfeWvkOa4uOa1ruaykO+8jOiLpembiemjnuiInuOAgiR7Q19SRVNFVH0iCn0KCiMg6LefIEFQSSDpgJrkv6HnmoTkuLvlh73mlbAKIyDlj4LmlbDlsLHmmK/opoHmiafooYznmoTlkb3ku6QKX2Z1Y2tfZXhlY3V0ZV9wcm9tcHQoKSB7CiAgICAjIOWmguaenOeUqOaIt+WPqui+k+WFpSAiZnVjayB1bmluc3RhbGwiCiAgICBpZiBbICIkMSIgPSAidW5pbnN0YWxsIiBdICYmIFsgIiQjIiAtZXEgMSBdOyB0aGVuCiAgICAgICAgX3VuaW5zdGFsbF9zY3JpcHQKICAgICAgICByZXR1cm4gMAogICAgZmkKCiAgICAjIOWmguaenOeUqOaIt+i+k+WFpSAiZnVjayBjb25maWciCiAgICBpZiBbICIkMSIgPSAiY29uZmlnIiBdICYmIFsgIiQjIiAtZXEgMSBdOyB0aGVuCiAgICAgICAgX2Z1Y2tfc2hvd19jb25maWdfaGVscAogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIGlmICEgY29tbWFuZCAtdiBjdXJsICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9J2Z1Y2snIOWRveS7pOmcgOimgSAnY3VybCfvvIzor7flhYjlronoo4UgY3VybOOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGlmIFsgIiQjIiAtZXEgMCBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH3or7fmj5DkvpvopoHmiafooYznmoTlkb3ku6TjgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBsb2NhbCBwcm9tcHQ9IiQqIgogICAgbG9jYWwgYXV0b19tb2RlPSIke0ZVQ0tfQVVUT19FWEVDOi0wfSIKICAgIGxvY2FsIGN1cmxfdGltZW91dD0iJHtGVUNLX1RJTUVPVVQ6LTMwfSIKICAgIGxvY2FsIHN5c2luZm9fc3RyaW5nCiAgICBzeXNpbmZvX3N0cmluZz0kKF9mdWNrX2NvbGxlY3Rfc3lzaW5mb19zdHJpbmcpCiAgICAKICAgIGxvY2FsIGVzY2FwZWRfcHJvbXB0CiAgICBlc2NhcGVkX3Byb21wdD0kKF9mdWNrX2pzb25fZXNjYXBlICIkcHJvbXB0IikKICAgIAogICAgbG9jYWwgZXNjYXBlZF9zeXNpbmZvCiAgICBlc2NhcGVkX3N5c2luZm89JChfZnVja19qc29uX2VzY2FwZSAiJHN5c2luZm9fc3RyaW5nIikKCiAgICAjIOaehOW7uiBKU09OCiAgICBsb2NhbCBwYXlsb2FkCiAgICBwYXlsb2FkPSQocHJpbnRmICd7ICJzeXNpbmZvIjogIiVzIiwgInByb21wdCI6ICIlcyIgfScgIiRlc2NhcGVkX3N5c2luZm8iICIkZXNjYXBlZF9wcm9tcHQiKQoKICAgICMg5L2/55So6YWN572u55qEIEFQSSDlnLDlnYDmiJbpu5jorqTlnLDlnYAKICAgIGxvY2FsIGFwaV91cmw9IiR7RlVDS19BUElfRU5EUE9JTlQ6LSRERUZBVUxUX0FQSV9FTkRQT0lOVH0iCgogICAgX2Z1Y2tfZGVidWcgIkFQSSDlnLDlnYA6ICRhcGlfdXJsIgogICAgX2Z1Y2tfZGVidWcgIuivt+axguS9kzogJHBheWxvYWQiCgogICAgZWNobyAtbmUgIiR7Q19ZRUxMT1d95oCd6ICD5LitLi4uJHtDX1JFU0VUfSAiCiAgICAKICAgIGxvY2FsIHRtcF9yZXNwb25zZQogICAgdG1wX3Jlc3BvbnNlPSQobWt0ZW1wKQogICAgCiAgICAjIOWQjuWPsOaJp+ihjCBjdXJsCiAgICAoCiAgICAgICAgY3VybCAtc1MgLS1tYXgtdGltZSAiJGN1cmxfdGltZW91dCIgLVggUE9TVCAiJGFwaV91cmwiIFwKICAgICAgICAgICAgLUggIkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbiIgXAogICAgICAgICAgICAtZCAiJHBheWxvYWQiID4gIiR0bXBfcmVzcG9uc2UiIDI+JjEKICAgICkgJgogICAgbG9jYWwgcGlkPSQhCiAgICAKICAgIF9mdWNrX3NwaW5uZXIgIiRwaWQiCiAgICBpZiB3YWl0ICIkcGlkIjsgdGhlbgogICAgICAgIGV4aXRfY29kZT0wCiAgICBlbHNlCiAgICAgICAgZXhpdF9jb2RlPSQ/CiAgICBmaQogICAgCiAgICBlY2hvICIiICMgTmV3bGluZQogICAgCiAgICBsb2NhbCByZXNwb25zZQogICAgaWYgWyAtZiAiJHRtcF9yZXNwb25zZSIgXTsgdGhlbgogICAgICAgIHJlc3BvbnNlPSQoY2F0ICIkdG1wX3Jlc3BvbnNlIikKICAgICAgICBybSAtZiAiJHRtcF9yZXNwb25zZSIKICAgIGVsc2UKICAgICAgICByZXNwb25zZT0iIgogICAgZmkKCiAgICBpZiBbICRleGl0X2NvZGUgLW5lIDAgXSB8fCBbIC16ICIkcmVzcG9uc2UiIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfeaXoOazlei/nuaOpeWIsCBBSSDmnI3liqHmiJbml6Dlk43lupTjgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICBbIC1uICIkcmVzcG9uc2UiIF0gJiYgZWNobyAtZSAiJHtDX0RJTX0kcmVzcG9uc2Uke0NfUkVTRVR9IiA+JjIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICAjIC0tLSDnlKjmiLfnoa7orqQgLS0tCiAgICBlY2hvIC1lICIke0NfQ1lBTn3kuLrmgqjnlJ/miJDkuobku6XkuIvlkb3ku6TvvJoke0NfUkVTRVR9IgogICAgZWNobyAtZSAiJHtDX0RJTX0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJHtDX1JFU0VUfSIKICAgIGVjaG8gLWUgIiR7Q19HUkVFTn0ke3Jlc3BvbnNlfSR7Q19SRVNFVH0iCiAgICBlY2hvIC1lICIke0NfRElNfS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0ke0NfUkVTRVR9IgoKICAgIGxvY2FsIHNob3VsZF9leGVjPWZhbHNlCiAgICBpZiBfZnVja190cnV0aHkgIiRhdXRvX21vZGUiOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33imqEg5bey5byA5ZCv6Ieq5Yqo5omn6KGM5qih5byP77yM56uL5Y2z6L+Q6KGMLi4uJHtDX1JFU0VUfSIKICAgICAgICBzaG91bGRfZXhlYz10cnVlCiAgICBlbHNlCiAgICAgICAgd2hpbGUgdHJ1ZTsgZG8KICAgICAgICAgICAgcHJpbnRmICIke0NfQk9MRH3mmK/lkKbmiafooYzvvJ9bWS9uXSAke0NfUkVTRVR9IgogICAgICAgICAgICBsb2NhbCBjb25maXJtYXRpb24KICAgICAgICAgICAgaWYgWyAtciAvZGV2L3R0eSBdOyB0aGVuCiAgICAgICAgICAgICAgICByZWFkIC1yIC1uIDEgY29uZmlybWF0aW9uIDwgL2Rldi90dHkKICAgICAgICAgICAgICAgIGVjaG8gIiIgIyBOZXdsaW5lCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJlYWQgLXIgY29uZmlybWF0aW9uCiAgICAgICAgICAgIGZpCgogICAgICAgICAgICBjYXNlICIkY29uZmlybWF0aW9uIiBpbgogICAgICAgICAgICAgICAgW3lZXXwiIikKICAgICAgICAgICAgICAgICAgICBzaG91bGRfZXhlYz10cnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgW25OXSkKICAgICAgICAgICAgICAgICAgICBzaG91bGRfZXhlYz1mYWxzZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgICAgICopCiAgICAgICAgICAgICAgICAgICAgIyBMb29wCiAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgZXNhYwogICAgICAgIGRvbmUKICAgIGZpCgogICAgaWYgWyAiJHNob3VsZF9leGVjIiA9ICJ0cnVlIiBdOyB0aGVuCiAgICAgICAgIyDmiafooYzmnI3liqHlmajov5Tlm57nmoTlkb3ku6Tlubbmo4Dmn6XpgIDlh7rnoIEKICAgICAgICBpZiBldmFsICIkcmVzcG9uc2UiOyB0aGVuCiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19HUkVFTn3miafooYzlrozmiJDjgIIke0NfUkVTRVR9IgogICAgICAgIGVsc2UKICAgICAgICAgICAgbG9jYWwgZXhpdF9jb2RlPSQ/CiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19SRURfQk9MRH3plJnor6/vvIEke0NfUkVEfeWRveS7pOaJp+ihjOWksei0pe+8jOmAgOWHuueggSAkZXhpdF9jb2Rl44CCJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgICAgIHJldHVybiAkZXhpdF9jb2RlCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfeW3suWPlua2iOOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQp9CgojIOWumuS5ieWIq+WQje+8iOaUr+aMgeiHquWumuS5ieWIq+WQje+8iQpfZnVja19kZWZpbmVfYWxpYXNlcygpIHsKICAgIGxvY2FsIGRlZmF1bHRfYWxpYXM9ImZ1Y2siCgogICAgaWYgISBfZnVja190cnV0aHkgIiR7RlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVM6LTB9IjsgdGhlbgogICAgICAgIGFsaWFzICIkZGVmYXVsdF9hbGlhcyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKCiAgICBpZiBbIC1uICIke0ZVQ0tfQUxJQVM6LX0iIF0gJiYgWyAiJEZVQ0tfQUxJQVMiICE9ICIkZGVmYXVsdF9hbGlhcyIgXTsgdGhlbgogICAgICAgIGFsaWFzICIkRlVDS19BTElBUyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKfQoKX2Z1Y2tfZGVmaW5lX2FsaWFzZXMKCiMgLS0tIOaguOW/g+mAu+i+kee7k+adnyAtLS0KRU9GCgojIC0tLSDmoLjlv4PpgLvovpEgSGVyZWRvYyDnu5PmnZ8gLS0tCgoKIyAtLS0g5a6J6KOF5Ye95pWwICjnlLHlpJbpg6johJrmnKzov5DooYwpIC0tLQoKIyDmib7nlKjmiLcgc2hlbGwg6YWN572u5paH5Lu255qE6L6F5Yqp5Ye95pWwCl9pbnN0YWxsZXJfZGV0ZWN0X3Byb2ZpbGUoKSB7CiAgICBpZiBbIC1uICIke1NIRUxMOi19IiBdICYmIGVjaG8gIiRTSEVMTCIgfCBncmVwIC1xICJ6c2giOyB0aGVuCiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1uICIke1NIRUxMOi19IiBdICYmIGVjaG8gIiRTSEVMTCIgfCBncmVwIC1xICJiYXNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy5iYXNocmMiCiAgICBlbGlmIFsgLWYgIiRIT01FLy5wcm9maWxlIiBdOyB0aGVuCiAgICAgICAgIyDlhbzlrrkgc2gsIGtzaCDnrYkKICAgICAgICBlY2hvICIkSE9NRS8ucHJvZmlsZSIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnpzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBTSEVMTCDlj5jph4/msqHorr7nva7ml7bnmoTlpIfnlKjmlrnmoYgKICAgICAgICBlY2hvICIkSE9NRS8uenNocmMiCiAgICBlbGlmIFsgLWYgIiRIT01FLy5iYXNocmMiIF07IHRoZW4KICAgICAgICAjIFNIRUxMIOWPmOmHj+ayoeiuvue9ruaXtueahOWkh+eUqOaWueahiAogICAgICAgIGVjaG8gIiRIT01FLy5iYXNocmMiCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93bl9wcm9maWxlIgogICAgZmkKfQoKIyDkuLvlronoo4Xlh73mlbAKX2luc3RhbGxfc2NyaXB0KCkgewogICAgZWNobyAtZSAiJHtDX0JPTER95byA5aeL5a6J6KOFIGZ1Y2tpdC5zaC4uLiR7Q19SRVNFVH0iCiAgICBta2RpciAtcCAiJElOU1RBTExfRElSIgogICAgCiAgICAjIOaKiuaguOW/g+mAu+i+keWGmei/myBtYWluLnNoCiAgICBlY2hvICIkQ09SRV9MT0dJQyIgPiAiJE1BSU5fU0giCiAgICAKICAgIGlmIFsgJD8gLW5lIDAgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR95peg5rOV5YaZ5YWl5paH5Lu277yM6K+35qOA5p+l55uu5b2V5p2D6ZmQ44CCJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgIyDlpoLmnpzmsqHmnInphY3nva7mlofku7bliJnnlJ/miJDkuIDkuKrnpLrkvosKICAgIGlmIFsgISAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICAgICAgY2F0IDw8J0NGRycgPiAiJENPTkZJR19GSUxFIgojIGZ1Y2tpdC5zaCDphY3nva7mlofku7bnpLrkvosKIyDljrvmjonooYzpppbnmoQgIyDlubbkv67mlLnkuLrkvaDmg7PopoHnmoTlgLzljbPlj6/jgIIKCiMg6Ieq5a6a5LmJIEFQSSDlhaXlj6PvvIjlpoLoh6rlu7ogV29ya2Vy77yJCiMgZXhwb3J0IEZVQ0tfQVBJX0VORFBPSU5UPSJodHRwczovL3lvdXItZG9tYWluLndvcmtlcnMuZGV2LyIKCiMg6Ieq5Yqo5omn6KGM6L+U5Zue55qE5ZG95Luk77yM6Lez6L+H56Gu6K6k77yI6LCo5oWO5byA5ZCv77yJCiMgZXhwb3J0IEZVQ0tfQVVUT19FWEVDPWZhbHNlCgojIOivt+axgui2heaXtuaXtumXtO+8iOenku+8iQojIGV4cG9ydCBGVUNLX1RJTUVPVVQ9MzAKCiMg5piv5ZCm5omT5Y2w6LCD6K+V5L+h5oGvCiMgZXhwb3J0IEZVQ0tfREVCVUc9ZmFsc2UKQ0ZHCiAgICBmaQoKICAgICMg5oqKIHNvdXJjZSDpgqPooYzliqDliLAgc2hlbGwg6YWN572u5paH5Lu26YeMCiAgICBsb2NhbCBwcm9maWxlX2ZpbGUKICAgIHByb2ZpbGVfZmlsZT0kKF9pbnN0YWxsZXJfZGV0ZWN0X3Byb2ZpbGUpCiAgICAKICAgIGlmIFsgIiRwcm9maWxlX2ZpbGUiID0gInVua25vd25fcHJvZmlsZSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR95om+5LiN5YiwIC5iYXNocmMsIC56c2hyYyDmiJYgLnByb2ZpbGXvvIzml6Dms5Xoh6rliqjphY3nva7jgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9Xfeivt+aJi+WKqOWwhuS7peS4i+WGheWuuea3u+WKoOWIsOaCqOeahCBzaGVsbCDphY3nva7mlofku7bkuK3vvJoke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICJcbiAgJHtDX0NZQU59c291cmNlICRNQUlOX1NIJHtDX1JFU0VUfVxuIiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCiAgICBpZiAhIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICMg5L+d6K+B5paH5Lu25pyA5ZCO5pyJ5o2i6KGMCiAgICAgICAgaWYgWyAtbiAiJCh0YWlsIC1jMSAiJHByb2ZpbGVfZmlsZSIpIiBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gIiIgPj4gIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZmkKICAgICAgICBlY2hvICIjIEFkZGVkIGJ5IGZ1Y2tpdC5zaCBpbnN0YWxsZXIiID4+ICIkcHJvZmlsZV9maWxlIgogICAgICAgIGVjaG8gIiRzb3VyY2VfbGluZSIgPj4gIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZWNobyAtZSAiJHtDX0dSRUVOfeWuieijheWujOaIkO+8gSR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33or7fph43lkK/nu4jnq6/miJbmiafooYwgJHtDX0JPTER9c291cmNlICRwcm9maWxlX2ZpbGUke0NfWUVMTE9XfSDku6Xkvb/mm7TmlLnnlJ/mlYjjgIIke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIlxuJHtDX0JPTER9LS0tIOS9v+eUqOaWueazlSAtLS0ke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIuS9v+eUqCAke0NfUkVEX0JPTER9ZnVjayR7Q19SRVNFVH0g5ZG95Luk5ZCO6Lef5oKo5oOz5omn6KGM55qE5pON5L2c5Y2z5Y+v44CCIgogICAgICAgIGVjaG8gLWUgIuekuuS+izoiCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIGluc3RhbGwgZ2l0JHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19DWUFOfWZ1Y2sgdW5pbnN0YWxsIGdpdCR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIOaJvuWHuuW9k+WJjeebruW9leaJgOacieWkp+S6jjEwTULnmoTmlofku7Yke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX1JFRF9CT0xEfWZ1Y2sgdW5pbnN0YWxsJHtDX1JFU0VUfSAke0NfR1JFRU59IyDljbjovb0gZnVja2l0LnNoJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19SRURfQk9MRH1mdWNrIGNvbmZpZyR7Q19SRVNFVH0gJHtDX0dSRUVOfSMg5pi+56S66YWN572u5biu5YqpJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICJcbiR7Q19ZRUxMT1d96K6w5b6X6YeN5ZCv57uI56uv5Lul5L2/55So5paw5ZG95Luk77yBJHtDX1JFU0VUfSIKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfWUVMTE9XfeajgOa1i+WIsOW3suWuieijhe+8jOW3suS4uuaCqOabtOaWsOiEmuacrOOAgiR7Q19SRVNFVH0iCiAgICBmaQp9CgoKIyAtLS0g5Li76ISa5pys5YWl5Y+jIC0tLQoKIyDlpoLmnpzmnInlj4LmlbDkvKDov5vmnaUgKOavlOWmgiAiYmFzaCAtcyAuLi4iKQppZiBbICIkIyIgLWd0IDAgXTsgdGhlbgogICAgIyDkuLTml7bmqKHlvI8KICAgICMg6L+Q6KGM5qC45b+D6YC76L6R77yM5a6a5LmJ5Ye95pWwCiAgICBldmFsICIkQ09SRV9MT0dJQyIKICAgICMg55u05o6l6LCD55So5Li75Ye95pWwICjliKvlkI3lnKjov5nlhL/kuI3lpb3kvb8pCiAgICBfZnVja19leGVjdXRlX3Byb21wdCAiJEAiCmVsc2UKICAgICMg5a6J6KOF5qih5byPCiAgICBfaW5zdGFsbF9zY3JpcHQKZmkK`);

const README_URL_EN = 'https://github.com/Silentely/fuckits/blob/main/README.en.md';
const README_URL_ZH = 'https://github.com/Silentely/fuckits';
const INSTALLER_FILENAME_EN = 'fuckits.sh';
const INSTALLER_FILENAME_ZH = 'fuckits-zh.sh';

function isBrowserRequest(userAgent = '') {
  return /Mozilla|Chrome|Safari|Firefox|Edg/.test(userAgent);
}

function resolveLocale(url, headers) {
  const pathname = url.pathname.toLowerCase();
  if (pathname === '/zh' || pathname.startsWith('/zh/')) {
    return 'zh';
  }

  const langParam = (url.searchParams.get('lang') || '').toLowerCase();
  if (langParam.startsWith('zh')) {
    return 'zh';
  }

  const acceptLanguage = (headers.get('Accept-Language') || '').toLowerCase();
  if (acceptLanguage.split(',').some((token) => token.trim().startsWith('zh'))) {
    return 'zh';
  }

  return 'en';
}


export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    if (request.method === 'GET' && url.pathname === '/health') {
      return handleHealthCheck(env);
    }

    if (request.method === 'GET') {
      return handleGetRequest(request);
    } else if (request.method === 'POST') {
      return handlePostRequest(request, env);
    } else {
      return new Response('Expected GET or POST', { status: 405 });
    }
  },
};

function handleHealthCheck(env) {
  const payload = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    hasApiKey: Boolean(env?.OPENAI_API_KEY),
  };

  return new Response(JSON.stringify(payload), {
    status: 200,
    headers: { 'Content-Type': 'application/json; charset=utf-8' },
  });
}

/**
 * Handles GET requests to serve the installer script or redirect browsers to GitHub.
 * @param {Request} request The incoming request.
 * @returns {Response} A response with the shell script or a redirect.
 */
function handleGetRequest(request) {
  const userAgent = request.headers.get('User-Agent') || '';
  const url = new URL(request.url);
  const locale = resolveLocale(url, request.headers);
  const isBrowser = isBrowserRequest(userAgent);

  // If the request comes from a browser, redirect to the appropriate README.
  if (isBrowser) {
    const docsUrl = locale === 'zh' ? README_URL_ZH : README_URL_EN;
    return Response.redirect(docsUrl, 302);
  }

  // Otherwise, serve the installer script based on the resolved locale.
  const script = locale === 'zh' ? INSTALLER_SCRIPT_ZH : INSTALLER_SCRIPT;
  const filename = locale === 'zh' ? INSTALLER_FILENAME_ZH : INSTALLER_FILENAME_EN;

  return new Response(script, {
    headers: {
      'Content-Type': 'text/plain; charset=utf-8',
      'Content-Disposition': `attachment; filename="${filename}"`,
    },
  });
}

/**
 * Handles POST requests by forwarding the prompt to an AI model.
 * @param {Request} request The incoming request.
 * @param {object} env The environment variables.
 * @returns {Promise<Response>} A promise that resolves to the AI's response.
 */
async function handlePostRequest(request, env) {
  try {
    const { sysinfo, prompt } = await request.json();

    if (!prompt) {
      return new Response('Missing "prompt" in request body', { status: 400 });
    }
    if (!env.OPENAI_API_KEY) {
      return new Response('Missing OPENAI_API_KEY secret', { status: 500 });
    }

    const model = env.OPENAI_API_MODEL || 'gpt-4-turbo';
    const apiBase = (env.OPENAI_API_BASE || 'https://api.openai.com/v1').replace(/\/$/, '');
    const apiUrl = `${apiBase}/chat/completions`;

    const url = new URL(request.url);
    const locale = resolveLocale(url, request.headers);
    const isChinese = locale === 'zh';

    const system_prompt = isChinese
      ? `你是一个专业的 shell 脚本生成器。用户会提供他们的系统信息和一个命令。你的任务是返回一个可执行的、原始的 shell 脚本来完成他们的目标。脚本可以是多行的。不要提供任何解释、注释、markdown 格式（比如 \`\`\`bash）或 shebang（例如 #!/bin/bash）。只需要原始的脚本内容。用户的系统信息是：${sysinfo}`
      : `You are an expert shell script generator. A user will provide their system information and a prompt. Your task is to return a raw, executable shell script that accomplishes their goal. The script can be multi-line. Do not provide any explanation, comments, markdown formatting (like \`\`\`bash), or a shebang (e.g., #!/bin/bash). Just the raw script content. The user's system info is: ${sysinfo}`;

    const aiRequestPayload = {
      model: model,
      messages: [
        {
          role: 'system',
          content: system_prompt,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 1024,
      temperature: 0.2,
    };

    const aiResponse = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify(aiRequestPayload),
    });

    if (!aiResponse.ok) {
      const errorText = await aiResponse.text();
      return new Response(`AI API Error: ${errorText}`, { status: aiResponse.status });
    }

    const aiJson = await aiResponse.json();
    const command = aiJson.choices[0]?.message?.content.trim();

    if (!command) {
      return new Response('The AI returned an empty command.', { status: 500 });
    }

    return new Response(command, {
      headers: { 'Content-Type': 'text/plain' },
    });
  } catch (error) {
    return new Response(`Error: ${error.message}`, { status: 500 });
  }
}
