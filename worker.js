// --- FUCKIT.SH Cloudflare Worker ---

// This is the content of your main.sh installer script.
// It will be served when a user makes a GET request.
function b64_to_utf8(str) {
  try {
    // This is a more robust way to decode base64 to UTF-8
    const binaryString = atob(str);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return new TextDecoder().decode(bytes);
  } catch (e) {
    console.error("Failed to decode base64 string:", e);
    return ""; // Return empty string on failure
  }
}

const INSTALLER_SCRIPT = b64_to_utf8(`"IyEvYmluL2Jhc2gKIwojIFRoaXMgc2NyaXB0IGlzIHRoZSBpbnN0YWxsZXIgYW5kIHRlbXBvcmFyeSBydW5uZXIgZm9yIGZ1Y2tpdHMKIwojIC0tLSBSRUNPTU1FTkRFRCBTRUNVUkUgVVNBR0UgLS0tCiMKIyAxLiBEb3dubG9hZDoKIyAgICBjdXJsIC1vIGZ1Y2tpdHMgaHR0cHM6Ly9mdWNraXRzLjI1NTAwNTUyLnh5egojCiMgMi4gSW5zcGVjdDoKIyAgICBsZXNzIGZ1Y2tpdHMKIwojIDMuIFJ1biAoSW5zdGFsbCk6CiMgICAgYmFzaCBmdWNraXRzCiMKIyA0LiBSdW4gKFRlbXBvcmFyeSk6CiMgICAgYmFzaCBmdWNraXRzICJ5b3VyIHByb21wdCIKIwoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgLS0tIENvbG9yIERlZmluaXRpb25zIC0tLQpyZWFkb25seSBDX1JFU0VUPSdcMDMzWzBtJwpyZWFkb25seSBDX1JFRF9CT0xEPSdcMDMzWzE7MzFtJwpyZWFkb25seSBDX1JFRD0nXDAzM1swOzMxbScKcmVhZG9ubHkgQ19HUkVFTj0nXDAzM1swOzMybScKcmVhZG9ubHkgQ19ZRUxMT1c9J1wwMzNbMDszM20nCnJlYWRvbmx5IENfQ1lBTj0nXDAzM1swOzM2bScKcmVhZG9ubHkgQ19CT0xEPSdcMDMzWzFtJwpyZWFkb25seSBDX0RJTT0nXDAzM1sybScKCiMgLS0tIEZVQ0shIC0tLQpyZWFkb25seSBGVUNLPSIke0NfUkVEX0JPTER9RlVDSyEke0NfUkVTRVR9IgpyZWFkb25seSBGQ0tOPSIke0NfUkVEfUYqQ0tJTkcke0NfUkVTRVR9IgoKcmVhZG9ubHkgRlVDS0lUU19MT0NBTEU9ImVuIgoKCiMgLS0tIENvbmZpZ3VyYXRpb24gLS0tCmlmIFsgLXogIiR7SE9NRTotfSIgXTsgdGhlbgogICAgZWNobyAtZSAiXDAzM1sxOzMxbUZVQ0shXDAzM1swbSBcMDMzWzA7MzFtWW91ciBIT01FIHZhcmlhYmxlIGlzbid0IHNldC4gSSBkb24ndCBrbm93IHdoZXJlIHRvIGluc3RhbGwgdGhpcyBzaGl0LiBTZXQgaXQgeW91cnNlbGYgKGUuZy4sIGV4cG9ydCBIT01FPS9yb290KS5cMDMzWzBtIiA+JjIKICAgIGV4aXQgMQpmaQpyZWFkb25seSBJTlNUQUxMX0RJUj0iJEhPTUUvLmZ1Y2siCnJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgpyZWFkb25seSBDT05GSUdfRklMRT0iJElOU1RBTExfRElSL2NvbmZpZy5zaCIKCgojIC0tLSBDb3JlIExvZ2ljIChFbWJlZGRlZCBhcyBhIHN0cmluZykgLS0tCnJlYWQgLXIgLWQgJycgQ09SRV9MT0dJQyA8PCdFT0YnIHx8IHRydWUKCiMgLS0tIEJlZ2luIENvcmUgTG9naWMgZm9yIGZ1Y2tpdHMgLS0tCgojIC0tLSBDb2xvciBEZWZpbml0aW9ucyAtLS0KIyBPbmx5IGRlZmluZSBjb2xvcnMgaWYgdGhleSBoYXZlbid0IGJlZW4gZGVmaW5lZCB5ZXQgKGZvciB0ZW1wIG1vZGUpCmlmIFsgLXogIiR7Q19SRVNFVDotfSIgXTsgdGhlbgogICAgcmVhZG9ubHkgQ19SRVNFVD0nXDAzM1swbScKICAgIHJlYWRvbmx5IENfUkVEX0JPTEQ9J1wwMzNbMTszMW0nCiAgICByZWFkb25seSBDX1JFRD0nXDAzM1swOzMxbScKICAgIHJlYWRvbmx5IENfR1JFRU49J1wwMzNbMDszMm0nCiAgICByZWFkb25seSBDX1lFTExPVz0nXDAzM1swOzMzbScKICAgIHJlYWRvbmx5IENfQ1lBTj0nXDAzM1swOzM2bScKICAgIHJlYWRvbmx5IENfQk9MRD0nXDAzM1sxbScKICAgIHJlYWRvbmx5IENfRElNPSdcMDMzWzJtJwoKICAgICMgLS0tIEZVQ0shIC0tLQogICAgcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfUZVQ0shJHtDX1JFU0VUfSIKICAgIHJlYWRvbmx5IEZDS049IiR7Q19SRUR9RipDS0lORyR7Q19SRVNFVH0iCmZpCgppZiBbIC16ICIke0lOU1RBTExfRElSK3h9IiBdIHx8IFsgLXogIiR7TUFJTl9TSCt4fSIgXSB8fCBbIC16ICIke0NPTkZJR19GSUxFK3h9IiBdOyB0aGVuCiAgICBpZiBbIC16ICIke0hPTUU6LX0iIF07IHRoZW4KICAgICAgICByZWFkb25seSBJTlNUQUxMX0RJUj0iL3RtcC8uZnVjayIKICAgICAgICByZWFkb25seSBNQUlOX1NIPSIvdG1wLy5mdWNrL21haW4uc2giCiAgICAgICAgcmVhZG9ubHkgQ09ORklHX0ZJTEU9Ii90bXAvLmZ1Y2svY29uZmlnLnNoIgogICAgZWxzZQogICAgICAgIHJlYWRvbmx5IElOU1RBTExfRElSPSIkSE9NRS8uZnVjayIKICAgICAgICByZWFkb25seSBNQUlOX1NIPSIkSU5TVEFMTF9ESVIvbWFpbi5zaCIKICAgICAgICByZWFkb25seSBDT05GSUdfRklMRT0iJElOU1RBTExfRElSL2NvbmZpZy5zaCIKICAgIGZpCmZpCgojIExvYWQgdXNlciBjb25maWd1cmF0aW9uIGlmIGl0IGV4aXN0cwppZiBbIC1mICIkQ09ORklHX0ZJTEUiIF07IHRoZW4KICAgIHNvdXJjZSAiJENPTkZJR19GSUxFIgpmaQoKaWYgWyAteiAiJHtERUZBVUxUX0FQSV9FTkRQT0lOVCt4fSIgXTsgdGhlbgogICAgcmVhZG9ubHkgREVGQVVMVF9BUElfRU5EUE9JTlQ9Imh0dHBzOi8vZnVja2l0cy4yNTUwMDU1Mi54eXovIgpmaQoKIyBIZWxwZXIgdG8gZmluZCB0aGUgdXNlcidzIHNoZWxsIHByb2ZpbGUgZmlsZQpfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgZm9yIHNoLCBrc2gsIGV0Yy4KICAgICAgICBlY2hvICIkSE9NRS8ucHJvZmlsZSIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnpzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsc2UKICAgICAgICBlY2hvICJ1bmtub3duX3Byb2ZpbGUiCiAgICBmaQp9CgojIERldGVjdHMgdGhlIHBhY2thZ2UgbWFuYWdlcgpfZnVja19kZXRlY3RfcGtnX21hbmFnZXIoKSB7CiAgICBpZiBjb21tYW5kIC12IGFwdC1nZXQgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAiYXB0IgogICAgZWxpZiBjb21tYW5kIC12IHl1bSAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJ5dW0iCiAgICBlbGlmIGNvbW1hbmQgLXYgZG5mICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gImRuZiIKICAgIGVsaWYgY29tbWFuZCAtdiBwYWNtYW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAicGFjbWFuIgogICAgZWxpZiBjb21tYW5kIC12IHp5cHBlciAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJ6eXBwZXIiCiAgICBlbGlmIGNvbW1hbmQgLXYgYnJldyAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJicmV3IgogICAgZWxzZQogICAgICAgIGVjaG8gInVua25vd24iCiAgICBmaQp9CgojIENvbGxlY3RzIHN5c3RlbSBpbmZvIGFzIGEgc2ltcGxlIHN0cmluZwpfZnVja19jb2xsZWN0X3N5c2luZm9fc3RyaW5nKCkgewogICAgbG9jYWwgcGtnX21hbmFnZXIKICAgIHBrZ19tYW5hZ2VyPSQoX2Z1Y2tfZGV0ZWN0X3BrZ19tYW5hZ2VyKQogICAgIyBUaGUgc2VydmVyLXNpZGUgTExNIHByb21wdCB3aWxsIG5lZWQgdG8gcGFyc2UgdGhpcyBzdHJpbmcKICAgIGVjaG8gIk9TOiAkKHVuYW1lIC1zKSwgQXJjaDogJCh1bmFtZSAtbSksIFNoZWxsOiAke1NIRUxMOi11bmtub3dufSwgUGtnTWdyOiAkcGtnX21hbmFnZXIsIENXRDogJChwd2QpIgp9CgojIEVzY2FwZXMgYSBzdHJpbmcgZm9yIHVzZSBpbiBhIEpTT04gcGF5bG9hZApfZnVja19qc29uX2VzY2FwZSgpIHsKICAgICMgQmFzaWMgZXNjYXBlIGZvciBxdW90ZXMsIGJhY2tzbGFzaGVzLCBhbmQgY29udHJvbCBjaGFyYWN0ZXJzCiAgICBwcmludGYgJyVzJyAiJDEiIHwgc2VkIC1lICdzL1xcL1xcXFwvZycgLWUgJ3MvIi9cIi9nJyAtZSAncy9cbi9cXG4vZycgLWUgJ3MvXHIvXFxyL2cnIC1lICdzL1x0L1xcdC9nJwp9CgpfZnVja19zaG91bGRfdXNlX2xvY2FsX2FwaSgpIHsKICAgIGlmIFsgLW4gIiR7RlVDS19PUEVOQUlfQVBJX0tFWTotfSIgXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBmaQogICAgcmV0dXJuIDEKfQoKX2Z1Y2tfbG9jYWxfc3lzdGVtX3Byb21wdCgpIHsKICAgIGxvY2FsIHN5c2luZm89IiQxIgogICAgaWYgWyAiJEZVQ0tJVFNfTE9DQUxFIiA9ICJ6aCIgXTsgdGhlbgogICAgICAgIHByaW50ZiAn5L2g5piv5LiA5Liq5LiT5Lia55qEIHNoZWxsIOiEmuacrOeUn+aIkOWZqOOAgueUqOaIt+S8muaPkOS+m+S7luS7rOeahOezu+e7n+S/oeaBr+WSjOS4gOS4quWRveS7pOOAguS9oOeahOS7u+WKoeaYr+i/lOWbnuS4gOS4quWPr+aJp+ihjOeahOOAgeWOn+Wni+eahCBzaGVsbCDohJrmnKzmnaXlrozmiJDku5bku6znmoTnm67moIfjgILohJrmnKzlj6/ku6XmmK/lpJrooYznmoTjgILkuI3opoHmj5Dkvpvku7vkvZXop6Pph4rjgIHms6jph4rjgIFtYXJrZG93biDmoLzlvI/vvIjmr5TlpoIgYGBgYmFzaO+8ieaIliBzaGViYW5n77yI5L6L5aaCICMhL2Jpbi9iYXNo77yJ44CC5Y+q6ZyA6KaB5Y6f5aeL55qE6ISa5pys5YaF5a6544CC55So5oi355qE57O757uf5L+h5oGv5piv77yaJXMnICIkc3lzaW5mbyIKICAgIGVsc2UKICAgICAgICBwcmludGYgJ1lvdSBhcmUgYW4gZXhwZXJ0IHNoZWxsIHNjcmlwdCBnZW5lcmF0b3IuIEEgdXNlciB3aWxsIHByb3ZpZGUgdGhlaXIgc3lzdGVtIGluZm9ybWF0aW9uIGFuZCBhIHByb21wdC4gWW91ciB0YXNrIGlzIHRvIHJldHVybiBhIHJhdywgZXhlY3V0YWJsZSBzaGVsbCBzY3JpcHQgdGhhdCBhY2NvbXBsaXNoZXMgdGhlaXIgZ29hbC4gVGhlIHNjcmlwdCBjYW4gYmUgbXVsdGktbGluZS4gRG8gbm90IHByb3ZpZGUgYW55IGV4cGxhbmF0aW9uLCBjb21tZW50cywgbWFya2Rvd24gZm9ybWF0dGluZyAobGlrZSBgYGBiYXNoKSwgb3IgYSBzaGViYW5nIChlLmcuLCAjIS9iaW4vYmFzaCkuIEp1c3QgdGhlIHJhdyBzY3JpcHQgY29udGVudC4gVGhlIHVzZXInIiciJ3Mgc3lzdGVtIGluZm8gaXM6ICVzJyAiJHN5c2luZm8iCiAgICBmaQp9CgpfZnVja19leHRyYWN0X2NvbW1hbmRfZnJvbV9qc29uKCkgewogICAgbG9jYWwganNvbl9maWxlPSIkMSIKICAgIGlmIGNvbW1hbmQgLXYgcHl0aG9uMyA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBweXRob24zIC0gIiRqc29uX2ZpbGUiIDw8J1BZJwppbXBvcnQganNvbiwgc3lzCnBhdGggPSBzeXMuYXJndlsxXQp3aXRoIG9wZW4ocGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgZGF0YSA9IGpzb24ubG9hZChmKQpjaG9pY2VzID0gZGF0YS5nZXQoJ2Nob2ljZXMnKSBvciBbXQppZiBub3QgY2hvaWNlczoKICAgIHN5cy5leGl0KDEpCm1lc3NhZ2UgPSBjaG9pY2VzWzBdLmdldCgnbWVzc2FnZScpIG9yIHt9CmNvbnRlbnQgPSAobWVzc2FnZS5nZXQoJ2NvbnRlbnQnKSBvciAnJykuc3RyaXAoKQppZiBub3QgY29udGVudDoKICAgIHN5cy5leGl0KDEpCnByaW50KGNvbnRlbnQpClBZCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgIGlmIGNvbW1hbmQgLXYgbm9kZSA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBub2RlIC0gIiRqc29uX2ZpbGUiIDw8J0pTJwpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CmNvbnN0IHBhdGggPSBwcm9jZXNzLmFyZ3ZbMV07CmNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmOCcpKTsKY29uc3QgY2hvaWNlID0gKGRhdGEuY2hvaWNlcyAmJiBkYXRhLmNob2ljZXNbMF0pIHx8IHt9Owpjb25zdCBtZXNzYWdlID0gY2hvaWNlLm1lc3NhZ2UgfHwge307CmNvbnN0IGNvbnRlbnQgPSAobWVzc2FnZS5jb250ZW50IHx8ICcnKS50cmltKCk7CmlmICghY29udGVudCkgewogIHByb2Nlc3MuZXhpdCgxKTsKfQpjb25zb2xlLmxvZyhjb250ZW50KTsKSlMKICAgICAgICByZXR1cm4KICAgIGZpCgogICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1DYW5ub3QgcGFyc2UgQUkgcmVzcG9uc2UgYmVjYXVzZSBuZWl0aGVyIHB5dGhvbjMgbm9yIG5vZGUgaXMgYXZhaWxhYmxlLiR7Q19SRVNFVH0iID4mMgogICAgZWNobyAtZSAiJHtDX1lFTExPV31QbGVhc2UgaW5zdGFsbCBweXRob24zIG9yIG5vZGUgdG8gdXNlIGxvY2FsIEFQSSBtb2RlLiR7Q19SRVNFVH0iID4mMgogICAgcmV0dXJuIDEKfQoKX2Z1Y2tfcmVxdWVzdF9sb2NhbF9tb2RlbCgpIHsKICAgIGxvY2FsIHByb21wdD0iJDEiCiAgICBsb2NhbCBzeXNpbmZvPSIkMiIKICAgIGxvY2FsIGN1cmxfdGltZW91dD0iJDMiCgogICAgbG9jYWwgYXBpX2tleT0iJHtGVUNLX09QRU5BSV9BUElfS0VZOi19IgogICAgaWYgWyAteiAiJGFwaV9rZXkiIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfUxvY2FsIEFQSSBrZXkgbm90IGNvbmZpZ3VyZWQuIFNldCBGVUNLX09QRU5BSV9BUElfS0VZIGluIH4vLmZ1Y2svY29uZmlnLnNoLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIG1vZGVsPSIke0ZVQ0tfT1BFTkFJX01PREVMOi1ncHQtNS1uYW5vfSIKICAgIGxvY2FsIGFwaV9iYXNlPSIke0ZVQ0tfT1BFTkFJX0FQSV9CQVNFOi1odHRwczovL2FwaS5vcGVuYWkuY29tL3YxfSIKICAgIGFwaV9iYXNlPSR7YXBpX2Jhc2UlL30KICAgIGxvY2FsIGFwaV91cmw9IiRhcGlfYmFzZS9jaGF0L2NvbXBsZXRpb25zIgoKICAgIF9mdWNrX2RlYnVnICJsb2NhbCBhcGkgYmFzZT0kYXBpX2Jhc2UiCiAgICBfZnVja19kZWJ1ZyAibG9jYWwgbW9kZWw9JG1vZGVsIgoKICAgIGxvY2FsIHN5c3RlbV9wcm9tcHQKICAgIHN5c3RlbV9wcm9tcHQ9JChfZnVja19sb2NhbF9zeXN0ZW1fcHJvbXB0ICIkc3lzaW5mbyIpCgogICAgbG9jYWwgZXNjYXBlZF9wcm9tcHQgZXNjYXBlZF9zeXN0ZW0KICAgIGVzY2FwZWRfcHJvbXB0PSQoX2Z1Y2tfanNvbl9lc2NhcGUgIiRwcm9tcHQiKQogICAgZXNjYXBlZF9zeXN0ZW09JChfZnVja19qc29uX2VzY2FwZSAiJHN5c3RlbV9wcm9tcHQiKQogICAgbG9jYWwgcGF5bG9hZAogICAgcGF5bG9hZD0kKHByaW50ZiAneyAibW9kZWwiOiAiJXMiLCAibWVzc2FnZXMiOiBbIHsicm9sZSI6InN5c3RlbSIsImNvbnRlbnQiOiIlcyJ9LCB7InJvbGUiOiJ1c2VyIiwiY29udGVudCI6IiVzIn0gXSwgIm1heF90b2tlbnMiOiAxMDI0LCAidGVtcGVyYXR1cmUiOiAwLjIgfScgXAogICAgICAgICIkbW9kZWwiICIkZXNjYXBlZF9zeXN0ZW0iICIkZXNjYXBlZF9wcm9tcHQiKQoKICAgIGxvY2FsIHRtcF9qc29uCiAgICB0bXBfanNvbj0kKG1rdGVtcCkgfHwgcmV0dXJuIDEKCiAgICBpZiAhIGN1cmwgLWZzUyAtLW1heC10aW1lICIkY3VybF90aW1lb3V0IiAiJGFwaV91cmwiIFwKICAgICAgICAtSCAiQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uIiBcCiAgICAgICAgLUggIkF1dGhvcml6YXRpb246IEJlYXJlciAkYXBpX2tleSIgXAogICAgICAgIC1kICIkcGF5bG9hZCIgPiAiJHRtcF9qc29uIjsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9TG9jYWwgQVBJIHJlcXVlc3QgZmFpbGVkLiR7Q19SRVNFVH0iID4mMgogICAgICAgIGNhdCAiJHRtcF9qc29uIiA+JjIKICAgICAgICBybSAtZiAiJHRtcF9qc29uIgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIGNvbW1hbmRfb3V0cHV0CiAgICBpZiAhIGNvbW1hbmRfb3V0cHV0PSQoX2Z1Y2tfZXh0cmFjdF9jb21tYW5kX2Zyb21fanNvbiAiJHRtcF9qc29uIik7IHRoZW4KICAgICAgICBybSAtZiAiJHRtcF9qc29uIgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9VW5hYmxlIHRvIHBhcnNlIGxvY2FsIG1vZGVsIHJlc3BvbnNlLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIHJtIC1mICIkdG1wX2pzb24iCiAgICBwcmludGYgJyVzXG4nICIkY29tbWFuZF9vdXRwdXQiCn0KCl9mdWNrX3JlcXVlc3Rfd29ya2VyX21vZGVsKCkgewogICAgbG9jYWwgcHJvbXB0PSIkMSIKICAgIGxvY2FsIHN5c2luZm89IiQyIgogICAgbG9jYWwgY3VybF90aW1lb3V0PSIkMyIKCiAgICBsb2NhbCBhZG1pbl9rZXk9IiR7RlVDS19BRE1JTl9LRVk6LX0iCiAgICBsb2NhbCBhZG1pbl9zZWdtZW50PSIiCiAgICBpZiBbIC1uICIkYWRtaW5fa2V5IiBdOyB0aGVuCiAgICAgICAgYWRtaW5fc2VnbWVudD0kKHByaW50ZiAnLCAiYWRtaW5LZXkiOiAiJXMiJyAiJCggX2Z1Y2tfanNvbl9lc2NhcGUgIiRhZG1pbl9rZXkiICkiKQogICAgZmkKCiAgICBsb2NhbCBwYXlsb2FkCiAgICBwYXlsb2FkPSQocHJpbnRmICd7ICJzeXNpbmZvIjogIiVzIiwgInByb21wdCI6ICIlcyIlcyB9JyBcCiAgICAgICAgIiQoIF9mdWNrX2pzb25fZXNjYXBlICIkc3lzaW5mbyIgKSIgXAogICAgICAgICIkKCBfZnVja19qc29uX2VzY2FwZSAiJHByb21wdCIgKSIgXAogICAgICAgICIkYWRtaW5fc2VnbWVudCIpCgogICAgbG9jYWwgYXBpX3VybD0iJHtGVUNLX0FQSV9FTkRQT0lOVDotJERFRkFVTFRfQVBJX0VORFBPSU5UfSIKCiAgICBfZnVja19kZWJ1ZyAiQVBJIFVSTDogJGFwaV91cmwiCiAgICBfZnVja19kZWJ1ZyAiUGF5bG9hZDogJHBheWxvYWQiCiAgICBfZnVja19kZWJ1ZyAiVGltZW91dDogJGN1cmxfdGltZW91dCIKCiAgICBsb2NhbCB0bXBfcmVzcG9uc2UgdG1wX3N0YXR1cwogICAgdG1wX3Jlc3BvbnNlPSQobWt0ZW1wKQogICAgdG1wX3N0YXR1cz0kKG1rdGVtcCkKCiAgICAoCiAgICAgICAgY3VybCAtc1MgLS1tYXgtdGltZSAiJGN1cmxfdGltZW91dCIgLVggUE9TVCAiJGFwaV91cmwiIFwKICAgICAgICAgICAgLUggIkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbiIgXAogICAgICAgICAgICAtZCAiJHBheWxvYWQiIC1vICIkdG1wX3Jlc3BvbnNlIiAtdyAiJXtodHRwX2NvZGV9IiA+ICIkdG1wX3N0YXR1cyIKICAgICkgJgogICAgbG9jYWwgcGlkPSQhCgogICAgaWYgWyAtdCAyIF07IHRoZW4KICAgICAgICBfZnVja19zcGlubmVyICIkcGlkIiA+JjIKICAgIGZpCgogICAgbG9jYWwgY3VybF9leGl0PTAKICAgIGlmICEgd2FpdCAiJHBpZCI7IHRoZW4KICAgICAgICBjdXJsX2V4aXQ9JD8KICAgIGZpCgogICAgbG9jYWwgaHR0cF9zdGF0dXM9IiIKICAgIGlmIFsgLWYgIiR0bXBfc3RhdHVzIiBdOyB0aGVuCiAgICAgICAgaHR0cF9zdGF0dXM9JCh0ciAtZCAnXHJcbicgPCAiJHRtcF9zdGF0dXMiKQogICAgICAgIHJtIC1mICIkdG1wX3N0YXR1cyIKICAgIGZpCgogICAgbG9jYWwgcmVzcG9uc2U9IiIKICAgIGlmIFsgLWYgIiR0bXBfcmVzcG9uc2UiIF07IHRoZW4KICAgICAgICByZXNwb25zZT0kKGNhdCAiJHRtcF9yZXNwb25zZSIpCiAgICAgICAgcm0gLWYgIiR0bXBfcmVzcG9uc2UiCiAgICBmaQoKICAgIGlmIFsgJGN1cmxfZXhpdCAtbmUgMCBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1GYWlsZWQgdG8gcmVhY2ggdGhlIHNoYXJlZCBXb3JrZXIuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgaWYgWyAtbiAiJHJlc3BvbnNlIiBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19ESU19JHJlc3BvbnNlJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgZmkKICAgICAgICByZXR1cm4gJGN1cmxfZXhpdAogICAgZmkKCiAgICBpZiBbIC16ICIkaHR0cF9zdGF0dXMiIF07IHRoZW4KICAgICAgICBodHRwX3N0YXR1cz0wCiAgICBmaQoKICAgIGlmIFsgIiRodHRwX3N0YXR1cyIgLWVxIDQyOSBdICYmIHByaW50ZiAnJXMnICIkcmVzcG9uc2UiIHwgZ3JlcCAtcSAnREVNT19MSU1JVF9FWENFRURFRCc7IHRoZW4KICAgICAgICBsb2NhbCBsaW1pdAogICAgICAgIGxpbWl0PSQocHJpbnRmICclcycgIiRyZXNwb25zZSIgfCBzZWQgLW4gJ3MvLioibGltaXQiOltbOnNwYWNlOl1dKlwoWzAtOV1cK1wpLiovXDEvcCcgfCBoZWFkIC1uMSkKICAgICAgICBsb2NhbCByZW1haW5pbmcKICAgICAgICByZW1haW5pbmc9JChwcmludGYgJyVzJyAiJHJlc3BvbnNlIiB8IHNlZCAtbiAncy8uKiJyZW1haW5pbmciOltbOnNwYWNlOl1dKlwoWzAtOV1cK1wpLiovXDEvcCcgfCBoZWFkIC1uMSkKICAgICAgICBbIC16ICIkbGltaXQiIF0gJiYgbGltaXQ9MTAKICAgICAgICBfZnVja19ub3RpZnlfZGVtb19saW1pdCAiJGxpbWl0IiAiJHJlbWFpbmluZyIKICAgICAgICByZXR1cm4gMgogICAgZmkKCiAgICBpZiBbICIkaHR0cF9zdGF0dXMiIC1nZSA0MDAgXSB8fCBbIC16ICIkcmVzcG9uc2UiIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfVNoYXJlZCBXb3JrZXIgcmV0dXJuZWQgSFRUUCAkaHR0cF9zdGF0dXMuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgaWYgWyAtbiAiJHJlc3BvbnNlIiBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19ESU19JHJlc3BvbnNlJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgZmkKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBwcmludGYgJyVzXG4nICIkcmVzcG9uc2UiCn0KCl9mdWNrX25vdGlmeV9kZW1vX2xpbWl0KCkgewogICAgbG9jYWwgZGFpbHlfbGltaXQ9IiR7MTotMTB9IgogICAgbG9jYWwgcmVtYWluaW5nPSIkezI6LTB9IgoKICAgIGVjaG8gLWUgIiRGVUNLICR7Q19ZRUxMT1d9U2hhcmVkIGRlbW8gcXVvdGEgZXhoYXVzdGVkICgke2RhaWx5X2xpbWl0fSBjYWxscyBwZXIgZGF5KS4ke0NfUkVTRVR9IiA+JjIKICAgIGNhc2UgIiRyZW1haW5pbmciIGluCiAgICAgICAgJyd8KlshMC05XSopIDs7CiAgICAgICAgKikKICAgICAgICAgICAgaWYgWyAiJHJlbWFpbmluZyIgLWd0IDAgXTsgdGhlbgogICAgICAgICAgICAgICAgZWNobyAtZSAiJHtDX0RJTX0kcmVtYWluaW5nIGNhbGxzIGxlZnQgZm9yIHRvZGF5LiR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICBmaQogICAgICAgICAgICA7OwogICAgZXNhYwoKICAgIF9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzCiAgICBfZnVja19zZWN1cmVfY29uZmlnX2ZpbGUKCiAgICBlY2hvIC1lICIke0NfQ1lBTn1Td2l0Y2ggdG8geW91ciBvd24ga2V5OiR7Q19SRVNFVH0gcnVuICR7Q19HUkVFTn1mdWNrIGNvbmZpZyR7Q19SRVNFVH0gYW5kIHNldCAke0NfQk9MRH1GVUNLX09QRU5BSV9BUElfS0VZJHtDX1JFU0VUfSAocGx1cyBvcHRpb25hbCAke0NfQk9MRH1GVUNLX09QRU5BSV9NT0RFTCR7Q19SRVNFVH0vJHtDX0JPTER9RlVDS19PUEVOQUlfQVBJX0JBU0Uke0NfUkVTRVR9KS4iID4mMgogICAgZWNobyAtZSAiJHtDX0NZQU59VHJ1c3RlZCBtYWludGFpbmVyIG92ZXJyaWRlOiR7Q19SRVNFVH0gc2V0ICR7Q19CT0xEfUZVQ0tfQURNSU5fS0VZJHtDX1JFU0VUfSBpZiB5b3Ugd2VyZSBpc3N1ZWQgdGhlIHdvcmtlcidzIEFETUlOX0FDQ0VTU19LRVkgdG8gYnlwYXNzIHRoZSBzaGFyZWQgcXVvdGEuIiA+JjIKICAgIGVjaG8gLWUgIiR7Q19DWUFOfUNvbmZpZyBwYXRoOiR7Q19SRVNFVH0gJHtDX0dSRUVOfSRDT05GSUdfRklMRSR7Q19SRVNFVH0iID4mMgogICAgaWYgWyAtbiAiJHtFRElUT1I6LX0iIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfUhpbnQ6JHtDX1JFU0VUfSAke0VESVRPUn0gXCIkQ09ORklHX0ZJTEVcIiIgPiYyCiAgICBmaQogICAgZWNobyAtZSAiJHtDX0RJTX1TZWN1cml0eToke0NfUkVTRVR9IHRoZSBmaWxlIHBlcm1pc3Npb25zIGFyZSBsb2NrZWQgdG8gNjAwIHNvIHRoZSBrZXkgc3RheXMgbG9jYWwuIiA+JjIKfQoKIyBTaW1wbGUgaGVscGVyIHRvIHBhcnNlIGJvb2xlYW4tbGlrZSB2YWx1ZXMKX2Z1Y2tfdHJ1dGh5KCkgewogICAgbG9jYWwgdmFsdWU9IiR7MTotfSIKICAgIGxvY2FsIG5vcm1hbGl6ZWQKICAgIG5vcm1hbGl6ZWQ9JChwcmludGYgJyVzJyAiJHZhbHVlIiB8IHRyICdbOnVwcGVyOl0nICdbOmxvd2VyOl0nKQogICAgY2FzZSAiJG5vcm1hbGl6ZWQiIGluCiAgICAgICAgMXx0cnVlfHllc3x5fG9uKQogICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICA7OwogICAgICAgICopCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIDs7CiAgICBlc2FjCn0KCiMgRGVidWcgaGVscGVyCl9mdWNrX2RlYnVnKCkgewogICAgaWYgX2Z1Y2tfdHJ1dGh5ICIke0ZVQ0tfREVCVUc6LTB9IjsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ESU19W2RlYnVnXSAkKiR7Q19SRVNFVH0iID4mMgogICAgZmkKfQoKIyBTcGlubmVyIGFuaW1hdGlvbgpfZnVja19zcGlubmVyKCkgewogICAgbG9jYWwgcGlkPSQxCiAgICBsb2NhbCBkZWxheT0wLjEKICAgIGxvY2FsIHNwaW5zdHI9J+Kgi+KgmeKgueKguOKgvOKgtOKgpuKgp+Kgh+KgjycKICAgIAogICAgIyBIaWRlIGN1cnNvcgogICAgdHB1dCBjaXZpcyAyPi9kZXYvbnVsbCB8fCBwcmludGYgIlwwMzNbPzI1bCIKCiAgICB3aGlsZSBraWxsIC0wICIkcGlkIiAyPi9kZXYvbnVsbDsgZG8KICAgICAgICBsb2NhbCB0ZW1wPSR7c3BpbnN0ciM/fQogICAgICAgIHByaW50ZiAiICVjICIgIiRzcGluc3RyIgogICAgICAgIGxvY2FsIHNwaW5zdHI9JHRlbXAke3NwaW5zdHIlIiR0ZW1wIn0KICAgICAgICBzbGVlcCAkZGVsYXkKICAgICAgICBwcmludGYgIlxiXGJcYiIKICAgIGRvbmUKICAgIHByaW50ZiAiICAgXGJcYlxiIgogICAgCiAgICAjIFNob3cgY3Vyc29yCiAgICB0cHV0IGNub3JtIDI+L2Rldi9udWxsIHx8IHByaW50ZiAiXDAzM1s/MjVoIgp9CgojIERldGVjdHMgcG90ZW50aWFsbHkgZGFuZ2Vyb3VzIGNvbW1hbmRzIGFuZCBwcmludHMgYSB3YXJuaW5nCl9mdWNrX2RldGVjdF9kYW5nZXJvdXNfY29tbWFuZCgpIHsKICAgIGxvY2FsIGNvbW1hbmRfdG9fY2hlY2s9IiQxIgogICAgbG9jYWwgZGFuZ2Vyb3VzX2ZvdW5kPWZhbHNlCgogICAgIyBMaXN0IG9mIGRhbmdlcm91cyBwYXR0ZXJucwogICAgIyBVc2luZyB3b3JkIGJvdW5kYXJpZXMgKFxiKSBmb3IgYmV0dGVyIG1hdGNoaW5nIHdoZXJlIGFwcGxpY2FibGUKICAgIGxvY2FsIHBhdHRlcm5zPSgKICAgICAgICAnXGJybSAtcmYnCiAgICAgICAgJ1xibWtmc1xiJwogICAgICAgICdcYmRkXGInCiAgICAgICAgJyA+IC9kZXYvbnVsbCcgIyBSZWRpcmVjdGluZyBvdXRwdXQgdG8gL2Rldi9udWxsIGZvciBwb3RlbnRpYWxseSBkYW5nZXJvdXMgY29tbWFuZHMKICAgICAgICAnID4gL2V0Yy9wYXNzd2QnCiAgICAgICAgJyA+IC9ldGMvc2hhZG93JwogICAgICAgICcgPiAvZXRjL3N1ZG9lcnMnCiAgICAgICAgJyA+IC9kZXYvc2RhJyAjIE9yIG90aGVyIGRpc2sgZGV2aWNlcwogICAgICAgICdjaG1vZCAuKiA3NzcnCiAgICAgICAgJ1xid2lwZWZzXGInCiAgICAgICAgJ1xiZm9ybWF0XGInCiAgICAgICAgJ1xic2hyZWRcYicKICAgICAgICAnXGJmZGlza1xiJwogICAgICAgICdcYnBhcnRlZFxiJwogICAgICAgICdcYmN1cmwgLiogXHwgc3VkbyBzaCcgIyBwaXBpbmcgY3VybCB0byBzdWRvIHNoCiAgICAgICAgJ1xid2dldCAuKiBcfCBzdWRvIHNoJyAjIHBpcGluZyB3Z2V0IHRvIHN1ZG8gc2gKICAgICkKCiAgICBmb3IgcGF0dGVybiBpbiAiJHtwYXR0ZXJuc1tAXX0iOyBkbwogICAgICAgIGlmIHByaW50ZiAnJXMnICIkY29tbWFuZF90b19jaGVjayIgfCBncmVwIC1FcSAiJHBhdHRlcm4iOyB0aGVuCiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19SRURfQk9MRH3imqDvuI8gIFdBUk5JTkc6IFBvdGVudGlhbGx5IGRhbmdlcm91cyBjb21tYW5kIGRldGVjdGVkISDimqDvuI8ke0NfUkVTRVR9IiA+JjIKICAgICAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31UaGUgc3VnZ2VzdGVkIGNvbW1hbmQgY29udGFpbnMgcGF0dGVybnMgdGhhdCBjb3VsZCBsZWFkIHRvIGRhdGEgbG9zcyBvciBzeXN0ZW0gaW5zdGFiaWxpdHkuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9UmV2aWV3IGl0IGNhcmVmdWxseSBiZWZvcmUgZXhlY3V0aW9uLiBVc2UgJHtDX0JPTER9biR7Q19SRVNFVH0ke0NfWUVMTE9XfSB0byBhYm9ydCBpZiB5b3UgYXJlIHVuc3VyZS4ke0NfUkVTRVR9IiA+JjIKICAgICAgICAgICAgZGFuZ2Vyb3VzX2ZvdW5kPXRydWUKICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgZG9uZQogICAgCiAgICBpZiAkZGFuZ2Vyb3VzX2ZvdW5kOyB0aGVuCiAgICAgICAgcmV0dXJuIDAgIyBEYW5nZXJvdXMgY29tbWFuZCBmb3VuZAogICAgZWxzZQogICAgICAgIHJldHVybiAxICMgTm8gZGFuZ2Vyb3VzIGNvbW1hbmQgZm91bmQKICAgIGZpCn0KCgojIEVuc3VyZSBhIGNvbmZpZyBmaWxlIGV4aXN0cyB0byBoZWxwIHVzZXJzIHR3ZWFrIHRoZSBiZWhhdmlvdXIKX2Z1Y2tfc2VjdXJlX2NvbmZpZ19maWxlKCkgewogICAgaWYgWyAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICAgICAgY2htb2QgNjAwICIkQ09ORklHX0ZJTEUiIDI+L2Rldi9udWxsIHx8IHRydWUKICAgIGZpCn0KCl9mdWNrX2FwcGVuZF9jb25maWdfaGludCgpIHsKICAgIGxvY2FsIGtleT0iJDEiCiAgICBsb2NhbCBjb21tZW50PSIkMiIKICAgIGxvY2FsIHNhbXBsZT0iJDMiCiAgICBsb2NhbCBxdW90ZWQ9IiR7NDotMX0iCiAgICBbIC1mICIkQ09ORklHX0ZJTEUiIF0gfHwgcmV0dXJuCiAgICBpZiBncmVwIC1FcSAiXlxccyojP1xccypleHBvcnRcXHMrJGtleSIgIiRDT05GSUdfRklMRSI7IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCgogICAgbG9jYWwgYXNzaWdubWVudAogICAgaWYgWyAiJHF1b3RlZCIgPSAiMSIgXTsgdGhlbgogICAgICAgIGFzc2lnbm1lbnQ9IiMgZXhwb3J0ICRrZXk9XCIkc2FtcGxlXCIiCiAgICBlbHNlCiAgICAgICAgYXNzaWdubWVudD0iIyBleHBvcnQgJGtleT0kc2FtcGxlIgogICAgZmkKCiAgICB7CiAgICAgICAgcHJpbnRmICdcbicKICAgICAgICBwcmludGYgJyMgJXNcbicgIiRjb21tZW50IgogICAgICAgIHByaW50ZiAnJXNcbicgIiRhc3NpZ25tZW50IgogICAgfSA+PiAiJENPTkZJR19GSUxFIgp9CgpfZnVja19zZWVkX2NvbmZpZ19wbGFjZWhvbGRlcnMoKSB7CiAgICBbIC1mICIkQ09ORklHX0ZJTEUiIF0gfHwgcmV0dXJuCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfT1BFTkFJX0FQSV9LRVkiICJMb2NhbCBPcGVuQUktY29tcGF0aWJsZSBBUEkga2V5IChyZWNvbW1lbmRlZCkiICdzay0uLi4nCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfQURNSU5fS0VZIiAiT3B0aW9uYWw6IGFkbWluIGJ5cGFzcyBrZXkgZm9yIHRydXN0ZWQgbWFpbnRhaW5lcnMiICdhZG0tLi4uJwogICAgX2Z1Y2tfYXBwZW5kX2NvbmZpZ19oaW50ICJGVUNLX09QRU5BSV9NT0RFTCIgIk9wdGlvbmFsOiBvdmVycmlkZSBtb2RlbCB3aGVuIHVzaW5nIHlvdXIgb3duIGtleSIgJ2dwdC00by1taW5pJwogICAgX2Z1Y2tfYXBwZW5kX2NvbmZpZ19oaW50ICJGVUNLX09QRU5BSV9BUElfQkFTRSIgIk9wdGlvbmFsOiBvdmVycmlkZSBBUEkgYmFzZSIgJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEnCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfQUxJQVMiICJBZGQgYW4gZXh0cmEgYWxpYXMgYmVzaWRlcyB0aGUgZGVmYXVsdCAnZnVjayciICdwbHMnCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfQVVUT19FWEVDIiAiU2tpcCBjb25maXJtYXRpb24gcHJvbXB0cyAodXNlIHdpdGggY2F1dGlvbiEpIiAnZmFsc2UnIDAKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19USU1FT1VUIiAiT3ZlcnJpZGUgY3VybCB0aW1lb3V0IChzZWNvbmRzKSIgJzMwJyAwCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfREVCVUciICJFbmFibGUgdmVyYm9zZSBkZWJ1ZyBsb2dzIiAnZmFsc2UnIDAKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVMiICJEaXNhYmxlIHRoZSBidWlsdC1pbiAnZnVjaycgYWxpYXMiICdmYWxzZScgMAp9CgpfZnVja19lbnN1cmVfY29uZmlnX2V4aXN0cygpIHsKICAgIGlmIFsgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgICAgIF9mdWNrX3NlZWRfY29uZmlnX3BsYWNlaG9sZGVycwogICAgICAgIF9mdWNrX3NlY3VyZV9jb25maWdfZmlsZQogICAgICAgIHJldHVybgogICAgZmkKCiAgICBta2RpciAtcCAiJChkaXJuYW1lICIkQ09ORklHX0ZJTEUiKSIKICAgIGNhdCA8PCdDRkcnID4gIiRDT05GSUdfRklMRSIKIyBmdWNraXRzIGNvbmZpZ3VyYXRpb24KIyBUb2dnbGUgdGhlIGV4cG9ydHMgYmVsb3cgdG8gY3VzdG9taXNlIHlvdXIgZXhwZXJpZW5jZS4KCiMgQ3VzdG9tIEFQSSBlbmRwb2ludCB0aGF0IHBvaW50cyB0byB5b3VyIHNlbGYtaG9zdGVkIHdvcmtlcgojIGV4cG9ydCBGVUNLX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly95b3VyLWRvbWFpbi53b3JrZXJzLmRldi8iCgojIExvY2FsIE9wZW5BSS1jb21wYXRpYmxlIEFQSSBrZXkgKHJlY29tbWVuZGVkKQojIGV4cG9ydCBGVUNLX09QRU5BSV9BUElfS0VZPSJzay0uLi4iCgojIE9wdGlvbmFsOiBhZG1pbiBieXBhc3Mga2V5IGZvciB0cnVzdGVkIG1haW50YWluZXJzCiMgZXhwb3J0IEZVQ0tfQURNSU5fS0VZPSJhZG0tLi4uIgoKIyBPcHRpb25hbDogb3ZlcnJpZGUgbW9kZWwvYmFzZSB3aGVuIHVzaW5nIHlvdXIgb3duIGtleQojIGV4cG9ydCBGVUNLX09QRU5BSV9NT0RFTD0iZ3B0LTRvLW1pbmkiCiMgZXhwb3J0IEZVQ0tfT1BFTkFJX0FQSV9CQVNFPSJodHRwczovL2FwaS5vcGVuYWkuY29tL3YxIgoKIyBBZGQgYW4gZXh0cmEgYWxpYXMgYmVzaWRlcyB0aGUgZGVmYXVsdCAnZnVjaycKIyBleHBvcnQgRlVDS19BTElBUz0icGxzIgoKIyBTa2lwIGNvbmZpcm1hdGlvbiBwcm9tcHRzICh1c2Ugd2l0aCBjYXV0aW9uISkKIyBleHBvcnQgRlVDS19BVVRPX0VYRUM9ZmFsc2UKCiMgT3ZlcnJpZGUgY3VybCB0aW1lb3V0IChzZWNvbmRzKQojIGV4cG9ydCBGVUNLX1RJTUVPVVQ9MzAKCiMgRW5hYmxlIHZlcmJvc2UgZGVidWcgbG9ncwojIGV4cG9ydCBGVUNLX0RFQlVHPWZhbHNlCgojIERpc2FibGUgdGhlIGJ1aWx0LWluICdmdWNrJyBhbGlhcwojIGV4cG9ydCBGVUNLX0RJU0FCTEVfREVGQVVMVF9BTElBUz1mYWxzZQpDRkcKCiAgICBfZnVja19zZWVkX2NvbmZpZ19wbGFjZWhvbGRlcnMKICAgIF9mdWNrX3NlY3VyZV9jb25maWdfZmlsZQp9CgpfZnVja19zaG93X2NvbmZpZ19oZWxwKCkgewogICAgX2Z1Y2tfZW5zdXJlX2NvbmZpZ19leGlzdHMKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9Q29uZmlndXJhdGlvbiBmaWxlOiR7Q19SRVNFVH0gJHtDX0NZQU59JENPTkZJR19GSUxFJHtDX1JFU0VUfSIKICAgIGlmIFsgLW4gIiR7RURJVE9SOi19IiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31FZGl0IHdpdGg6JHtDX1JFU0VUfSAke0NfQ1lBTn0ke0VESVRPUn0gXCIkQ09ORklHX0ZJTEVcIiR7Q19SRVNFVH0iCiAgICBlbHNlCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31PcGVuIHRoaXMgZmlsZSBpbiB5b3VyIGZhdm91cml0ZSBlZGl0b3IgdG8gY3VzdG9taXNlIGZ1Y2tpdHMuJHtDX1JFU0VUfSIKICAgIGZpCiAgICBlY2hvIC1lICIke0NfQ1lBTn1BdmFpbGFibGUgdG9nZ2xlczoke0NfUkVTRVR9IEZVQ0tfQVBJX0VORFBPSU5ULCBGVUNLX09QRU5BSV9BUElfS0VZLCBGVUNLX0FETUlOX0tFWSwgRlVDS19PUEVOQUlfTU9ERUwsIEZVQ0tfT1BFTkFJX0FQSV9CQVNFLCBGVUNLX0FMSUFTLCBGVUNLX0FVVE9fRVhFQywgRlVDS19USU1FT1VULCBGVUNLX0RFQlVHLCBGVUNLX0RJU0FCTEVfREVGQVVMVF9BTElBUyIKICAgIGVjaG8gLWUgIiR7Q19ESU19UHJvIHRpcDoke0NfUkVTRVR9IHdlIGxvY2sgJHtDT05GSUdfRklMRX0gdG8gY2htb2QgNjAwIHNvIHlvdXIgQVBJIGtleSBzdGF5cyBsb2NhbC4iCn0KCiMgVW5pbnN0YWxscyB0aGUgc2NyaXB0Cl91bmluc3RhbGxfc2NyaXB0KCkgewogICAgZWNobyAtZSAiJEZVQ0sgJHtDX1lFTExPV31TbyB5b3UncmUga2lja2luZyBtZSBvdXQ/IEZpbmUuJHtDX1JFU0VUfSIKCiAgICAjIEZpbmQgdGhlIHByb2ZpbGUgZmlsZQogICAgbG9jYWwgcHJvZmlsZV9maWxlCiAgICBwcm9maWxlX2ZpbGU9JChfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKQogICAgbG9jYWwgc291cmNlX2xpbmU9InNvdXJjZSAkTUFJTl9TSCIKCiAgICBpZiBbICIkcHJvZmlsZV9maWxlIiAhPSAidW5rbm93bl9wcm9maWxlIiBdICYmIFsgLWYgIiRwcm9maWxlX2ZpbGUiIF07IHRoZW4KICAgICAgICBpZiBncmVwIC1xRiAiJHNvdXJjZV9saW5lIiAiJHByb2ZpbGVfZmlsZSI7IHRoZW4KICAgICAgICAgICAgIyBVc2Ugc2VkIHRvIHJlbW92ZSB0aGUgbGluZXMuIENyZWF0ZSBhIGJhY2t1cC4KICAgICAgICAgICAgaWYgc2VkIC0tdmVyc2lvbiA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICAgICAgICAgICMgR05VIHNlZCAoTGludXgpCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICJcfCRzb3VyY2VfbGluZVx8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICJcfCMgQWRkZWQgYnkgZnVja2l0cyBpbnN0YWxsZXJcfGQiICIkcHJvZmlsZV9maWxlIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAjIEJTRC9tYWNPUyBzZWQgcmVxdWlyZXMgYXJndW1lbnQgbGV0dGVyIGFmdGVyIC1pCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICIiIC1lICJcfCRzb3VyY2VfbGluZVx8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICIiIC1lICJcfCMgQWRkZWQgYnkgZnVja2l0cyBpbnN0YWxsZXJcfGQiICIkcHJvZmlsZV9maWxlIgogICAgICAgICAgICBmaQogICAgICAgIGZpCiAgICBlbHNlCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31Db3VsZCBub3QgZmluZCBhIHNoZWxsIHByb2ZpbGUgZmlsZSB0byBtb2RpZnkuIFlvdXIgcHJvYmxlbSBub3cuJHtDX1JFU0VUfSIKICAgIGZpCgogICAgaWYgWyAtZCAiJElOU1RBTExfRElSIiBdOyB0aGVuCiAgICAgICAgcm0gLXJmICIkSU5TVEFMTF9ESVIiCiAgICBmaQoKICAgIGVjaG8gLWUgIiRGVUNLICR7Q19HUkVFTn1JJ20gZ29uZS4gRG9uJ3QgY29tZSBjcnlpbmcgYmFjay4ke0NfUkVTRVR9IgogICAgZWNobyAtZSAiJHtDX0NZQU59Tm93IHJlc3RhcnQgeW91ciBkYW1uIHNoZWxsLiR7Q19SRVNFVH0iCn0KCiMgVGhlIG1haW4gZnVuY3Rpb24gdGhhdCBjb250YWN0cyB0aGUgQVBJCiMgVGFrZXMgPjAgYXJndW1lbnRzIGFzIHRoZSBwcm9tcHQKX2Z1Y2tfZXhlY3V0ZV9wcm9tcHQoKSB7CiAgICAjIElmIHRoZSB1c2VyIHR5cGVzICpvbmx5KiAiZnVjayB1bmluc3RhbGwiCiAgICBpZiBbICIkMSIgPSAidW5pbnN0YWxsIiBdICYmIFsgIiQjIiAtZXEgMSBdOyB0aGVuCiAgICAgICAgX3VuaW5zdGFsbF9zY3JpcHQKICAgICAgICByZXR1cm4gMAogICAgZmkKCiAgICAjIElmIHRoZSB1c2VyIHR5cGVzICJmdWNrIGNvbmZpZyIKICAgIGlmIFsgIiQxIiA9ICJjb25maWciIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfZnVja19zaG93X2NvbmZpZ19oZWxwCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgaWYgISBjb21tYW5kIC12IGN1cmwgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH0nZnVjaycgY29tbWFuZCBuZWVkcyAnY3VybCcuIFBsZWFzZSBpbnN0YWxsIGl0LiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGlmIFsgIiQjIiAtZXEgMCBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1Zb3UgZm9yZ290IHRvIGFzayBtZSB3aGF0IHRvIGRvLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIHByb21wdD0iJCoiCiAgICBsb2NhbCBhdXRvX21vZGU9IiR7RlVDS19BVVRPX0VYRUM6LTB9IgogICAgbG9jYWwgY3VybF90aW1lb3V0PSIke0ZVQ0tfVElNRU9VVDotMzB9IgogICAgbG9jYWwgc3lzaW5mb19zdHJpbmcKICAgIHN5c2luZm9fc3RyaW5nPSQoX2Z1Y2tfY29sbGVjdF9zeXNpbmZvX3N0cmluZykKCiAgICBsb2NhbCByZXNwb25zZT0iIgogICAgbG9jYWwgZXhpdF9jb2RlPTAKICAgIGlmIF9mdWNrX3Nob3VsZF91c2VfbG9jYWxfYXBpOyB0aGVuCiAgICAgICAgZWNobyAtbmUgIiR7Q19ZRUxMT1d9VXNpbmcgeW91ciBsb2NhbCBBUEkga2V5Li4uJHtDX1JFU0VUfSAiCiAgICAgICAgcmVzcG9uc2U9JChfZnVja19yZXF1ZXN0X2xvY2FsX21vZGVsICIkcHJvbXB0IiAiJHN5c2luZm9fc3RyaW5nIiAiJGN1cmxfdGltZW91dCIpCiAgICAgICAgZXhpdF9jb2RlPSQ/CiAgICBlbHNlCiAgICAgICAgZWNobyAtbmUgIiR7Q19ZRUxMT1d9VGhpbmtpbmcuLi4ke0NfUkVTRVR9ICIKICAgICAgICByZXNwb25zZT0kKF9mdWNrX3JlcXVlc3Rfd29ya2VyX21vZGVsICIkcHJvbXB0IiAiJHN5c2luZm9fc3RyaW5nIiAiJGN1cmxfdGltZW91dCIpCiAgICAgICAgZXhpdF9jb2RlPSQ/CiAgICBmaQoKICAgIGVjaG8gIiIKCiAgICBpZiBbICRleGl0X2NvZGUgLW5lIDAgXSB8fCBbIC16ICIkcmVzcG9uc2UiIF07IHRoZW4KICAgICAgICByZXR1cm4gJGV4aXRfY29kZQogICAgZmkKCiAgICBlY2hvIC1lICIke0NfQ1lBTn1IZXJlIGlzIHdoYXQgSSBjYW1lIHVwIHdpdGg6JHtDX1JFU0VUfSIKICAgIGVjaG8gLWUgIiR7Q19ESU19LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSR7Q19SRVNFVH0iCiAgICBwcmludGYgJyVzXG4nICIkcmVzcG9uc2UiCiAgICBlY2hvIC1lICIke0NfRElNfS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0ke0NfUkVTRVR9IgoKICAgIF9mdWNrX2RldGVjdF9kYW5nZXJvdXNfY29tbWFuZCAiJHJlc3BvbnNlIgoKICAgIGxvY2FsIHNob3VsZF9leGVjPWZhbHNlCgogICAgaWYgX2Z1Y2tfdHJ1dGh5ICIkYXV0b19tb2RlIjsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d94pqhIEF1dG8tZXhlYyBlbmFibGVkLiBSdW5uaW5nLi4uJHtDX1JFU0VUfSIKICAgICAgICBzaG91bGRfZXhlYz10cnVlCiAgICBlbHNlCiAgICAgICAgIyBJbnRlcmFjdGl2ZSBjb25maXJtYXRpb24KICAgICAgICB3aGlsZSB0cnVlOyBkbwogICAgICAgICAgICBwcmludGYgIiR7Q19CT0xEfUV4ZWN1dGU/IFtZL25dICR7Q19SRVNFVH0iCiAgICAgICAgICAgIGxvY2FsIGNvbmZpcm1hdGlvbiBub3JtYWxpemVkCiAgICAgICAgICAgIGlmIFsgLXIgL2Rldi90dHkgXTsgdGhlbgogICAgICAgICAgICAgICAgSUZTPSByZWFkIC1yIGNvbmZpcm1hdGlvbiA8IC9kZXYvdHR5CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICMgRmFsbGJhY2sgZm9yIG5vIFRUWQogICAgICAgICAgICAgICAgSUZTPSByZWFkIC1yIGNvbmZpcm1hdGlvbgogICAgICAgICAgICBmaQoKICAgICAgICAgICAgY29uZmlybWF0aW9uPSQocHJpbnRmICclcycgIiR7Y29uZmlybWF0aW9uOi19IiB8IHRyIC1kICcgXHRccicpCiAgICAgICAgICAgIG5vcm1hbGl6ZWQ9JChwcmludGYgJyVzJyAiJGNvbmZpcm1hdGlvbiIgfCB0ciAnWzp1cHBlcjpdJyAnWzpsb3dlcjpdJykKCiAgICAgICAgICAgIGNhc2UgIiRub3JtYWxpemVkIiBpbgogICAgICAgICAgICAgICAgIiJ8InkifCJ5ZXMiKQogICAgICAgICAgICAgICAgICAgIHNob3VsZF9leGVjPXRydWUKICAgICAgICAgICAgICAgICAgICBlY2hvIC1lICIke0NfR1JFRU594pyFIEV4ZWN1dGluZy4uLiR7Q19SRVNFVH0iCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgIm4ifCJubyIpCiAgICAgICAgICAgICAgICAgICAgc2hvdWxkX2V4ZWM9ZmFsc2UKICAgICAgICAgICAgICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfeKdjCBBYm9ydGVkLiR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgICAgICopCiAgICAgICAgICAgICAgICAgICAgIyBMb29wIGFnYWluCiAgICAgICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgZXNhYwogICAgICAgIGRvbmUKICAgIGZpCgogICAgaWYgWyAiJHNob3VsZF9leGVjIiA9ICJ0cnVlIiBdOyB0aGVuCiAgICAgICAgZXZhbCAiJHJlc3BvbnNlIgogICAgICAgIGxvY2FsIGV4aXRfY29kZT0kPwogICAgICAgIGlmIFsgJGV4aXRfY29kZSAtbmUgMCBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9Q29tbWFuZCBmYWlsZWQgd2l0aCBleGl0IGNvZGUgJGV4aXRfY29kZS4ke0NfUkVTRVR9IiA+JjIKICAgICAgICBmaQogICAgICAgIHJldHVybiAkZXhpdF9jb2RlCiAgICBlbHNlCiAgICAgICAgIyBUaGUgJ0Fib3J0ZWQuJyBtZXNzYWdlIGlzIG5vdyBwcmludGVkIHdpdGhpbiB0aGUgbG9vcCwKICAgICAgICAjIHNvIHdlIGp1c3QgcmV0dXJuIDEgaGVyZSBpZiBzaG91bGRfZXhlYyBpcyBmYWxzZS4KICAgICAgICByZXR1cm4gMQogICAgZmkKfQoKIyBEZWZpbmUgdGhlIGFsaWFzIGZvciBpbnRlcmFjdGl2ZSB1c2UgKHN1cHBvcnRzIGN1c3RvbSBhbGlhc2VzKQpfZnVja19kZWZpbmVfYWxpYXNlcygpIHsKICAgIGxvY2FsIGRlZmF1bHRfYWxpYXM9ImZ1Y2siCgogICAgaWYgISBfZnVja190cnV0aHkgIiR7RlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVM6LTB9IjsgdGhlbgogICAgICAgIGFsaWFzICIkZGVmYXVsdF9hbGlhcyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKCiAgICBpZiBbIC1uICIke0ZVQ0tfQUxJQVM6LX0iIF0gJiYgWyAiJEZVQ0tfQUxJQVMiICE9ICIkZGVmYXVsdF9hbGlhcyIgXTsgdGhlbgogICAgICAgIGFsaWFzICIkRlVDS19BTElBUyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKfQoKX2Z1Y2tfZGVmaW5lX2FsaWFzZXMKCiMgLS0tIEVuZCBDb3JlIExvZ2ljIC0tLQpFT0YKCiMgLS0tIEVuZCBvZiBDb3JlIExvZ2ljIEhlcmVkb2MgLS0tCgojIEhlbHBlciB0byBtYXRlcmlhbGl6ZSB0aGUgZW1iZWRkZWQgY29yZSBsb2dpYyBpbnRvIGEgZmlsZSAodXNlZCBmb3IgaW5zdGFsbC90ZW1wIGV4ZWN1dGlvbikKX2Z1Y2tfd3JpdGVfY29yZSgpIHsKICAgIGxvY2FsIHRhcmdldD0iJDEiCiAgICBwcmludGYgJyVzXG4nICIkQ09SRV9MT0dJQyIgPiAiJHRhcmdldCIKfQoKIyBIZWxwZXIgdG8gc291cmNlIHRoZSBjb3JlIGxvZ2ljIGludG8gdGhlIGN1cnJlbnQgc2hlbGwKX2Z1Y2tfc291cmNlX2NvcmUoKSB7CiAgIGxvY2FsIHRtcF9jb3JlCiAgIHRtcF9jb3JlPSQobWt0ZW1wKQogICBfZnVja193cml0ZV9jb3JlICIkdG1wX2NvcmUiCiAgICMgc2hlbGxjaGVjayBkaXNhYmxlPVNDMTA5MAogICBzb3VyY2UgIiR0bXBfY29yZSIKICAgcm0gLWYgIiR0bXBfY29yZSIKfQoKCiMgLS0tIEluc3RhbGxlciBGdW5jdGlvbnMgKFJ1biBieSB0aGUgb3V0ZXIgc2NyaXB0KSAtLS0KCiMgSGVscGVyIHRvIGZpbmQgdGhlIHVzZXIncyBzaGVsbCBwcm9maWxlIGZpbGUKX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSgpIHsKICAgIGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgInpzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uenNocmMiCiAgICBlbGlmIFsgLW4gIiR7U0hFTEw6LX0iIF0gJiYgZWNobyAiJFNIRUxMIiB8IGdyZXAgLXEgImJhc2giOyB0aGVuCiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnByb2ZpbGUiIF07IHRoZW4KICAgICAgICAjIEZhbGxiYWNrIGZvciBzaCwga3NoLCBldGMuCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLmJhc2hyYyIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgaWYgU0hFTEwgdmFyIGlzbid0IHNldAogICAgICAgIGVjaG8gIiRIT01FLy5iYXNocmMiCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93bl9wcm9maWxlIgogICAgZmkKfQoKIyBNYWluIGluc3RhbGxhdGlvbiBmdW5jdGlvbgpfaW5zdGFsbGVyX3NlY3VyZV9jb25maWdfZmlsZSgpIHsKICAgICAgICBpZiBbIC1mICIkQ09ORklHX0ZJTEUiIF07IHRoZW4KICAgICAgICBjaG1vZCA2MDAgIiRDT05GSUdfRklMRSIgMj4vZGV2L251bGwgfHwgdHJ1ZQogICAgZmkKfQoKX2luc3RhbGxfc2NyaXB0KCkgewogICAgZWNobyAtZSAiJEZDS04gJHtDX0JPTER9QWxyaWdodCwgbGV0J3MgZ2V0IHRoaXMgc2hpdCBpbnN0YWxsZWQuLi4ke0NfUkVTRVR9IgogICAgbWtkaXIgLXAgIiRJTlNUQUxMX0RJUiIKICAgIAogICAgIyBXcml0ZSB0aGUgZW1iZWRkZWQgY29yZSBsb2dpYyB0byB0aGUgbWFpbi5zaCBmaWxlCiAgICBfZnVja193cml0ZV9jb3JlICIkTUFJTl9TSCIKICAgIAogICAgaWYgWyAkPyAtbmUgMCBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1DYW4ndCB3cml0ZSB0byB0aGUgZmlsZS4gQ2hlY2sgeW91ciBkYW1uIHBlcm1pc3Npb25zLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMgQ3JlYXRlIGEgZGVmYXVsdCBjb25maWcgZmlsZSBpZiBpdCBkb2Vzbid0IGV4aXN0CiAgICBpZiBbICEgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgICAgIGNhdCA8PCdDRkcnID4gIiRDT05GSUdfRklMRSIKIyBmdWNraXRzIGNvbmZpZ3VyYXRpb24KIyBUb2dnbGUgdGhlIGV4cG9ydHMgYmVsb3cgdG8gY3VzdG9taXNlIHlvdXIgZXhwZXJpZW5jZS4KCiMgQ3VzdG9tIEFQSSBlbmRwb2ludCB0aGF0IHBvaW50cyB0byB5b3VyIHNlbGYtaG9zdGVkIHdvcmtlcgojIGV4cG9ydCBGVUNLX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly95b3VyLWRvbWFpbi53b3JrZXJzLmRldi8iCgojIExvY2FsIE9wZW5BSS1jb21wYXRpYmxlIEFQSSBrZXkgKHJlY29tbWVuZGVkKQojIGV4cG9ydCBGVUNLX09QRU5BSV9BUElfS0VZPSJzay0uLi4iCgojIE9wdGlvbmFsOiBvdmVycmlkZSBtb2RlbC9iYXNlIHdoZW4gdXNpbmcgeW91ciBvd24ga2V5CiMgZXhwb3J0IEZVQ0tfT1BFTkFJX01PREVMPSJncHQtNG8tbWluaSIKIyBleHBvcnQgRlVDS19PUEVOQUlfQVBJX0JBU0U9Imh0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEiCgojIEFkZCBhbiBleHRyYSBhbGlhcyBiZXNpZGVzIHRoZSBkZWZhdWx0ICdmdWNrJwojIGV4cG9ydCBGVUNLX0FMSUFTPSJwbHMiCgojIFNraXAgY29uZmlybWF0aW9uIHByb21wdHMgKHVzZSB3aXRoIGNhdXRpb24hKQojIGV4cG9ydCBGVUNLX0FVVE9fRVhFQz1mYWxzZQoKIyBPdmVycmlkZSBjdXJsIHRpbWVvdXQgKHNlY29uZHMpCiMgZXhwb3J0IEZVQ0tfVElNRU9VVD0zMAoKIyBFbmFibGUgdmVyYm9zZSBkZWJ1ZyBsb2dzCiMgZXhwb3J0IEZVQ0tfREVCVUc9ZmFsc2UKCiMgRGlzYWJsZSB0aGUgYnVpbHQtaW4gJ2Z1Y2snIGFsaWFzCiMgZXhwb3J0IEZVQ0tfRElTQUJMRV9ERUZBVUxUX0FMSUFTPWZhbHNlCkNGRwogICAgICAgIF9pbnN0YWxsZXJfc2VjdXJlX2NvbmZpZ19maWxlCiAgICBmaQoKICAgICMgQWRkIHNvdXJjZSBsaW5lIHRvIHNoZWxsIHByb2ZpbGUKICAgIGxvY2FsIHByb2ZpbGVfZmlsZQogICAgcHJvZmlsZV9maWxlPSQoX2luc3RhbGxlcl9kZXRlY3RfcHJvZmlsZSkKICAgIAogICAgaWYgWyAiJHByb2ZpbGVfZmlsZSIgPSAidW5rbm93bl9wcm9maWxlIiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1JIGNhbid0IGZpbmQgLmJhc2hyYywgLnpzaHJjLCBvciAucHJvZmlsZS4gWW91J3JlIG9uIHlvdXIgb3duLiR7Q19SRVNFVH0iID4mMgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9TWFudWFsbHkgYWRkIHRoaXMgbGluZSB0byB3aGF0ZXZlciBzdGFydHVwIGZpbGUgeW91IHVzZToke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICJcbiAgJHtDX0NZQU59c291cmNlICRNQUlOX1NIJHtDX1JFU0VUfVxuIiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCiAgICBpZiAhIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICMgRW5zdXJlIHRoZSBmaWxlIGVuZHMgd2l0aCBhIG5ld2xpbmUgYmVmb3JlIHdlIGFkZCBvdXIgbGluZXMKICAgICAgICBpZiBbIC1uICIkKHRhaWwgLWMxICIkcHJvZmlsZV9maWxlIikiIF07IHRoZW4KICAgICAgICAgICAgZWNobyAiIiA+PiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBmaQogICAgICAgIGVjaG8gIiMgQWRkZWQgYnkgZnVja2l0cyBpbnN0YWxsZXIiID4+ICIkcHJvZmlsZV9maWxlIgogICAgICAgIGVjaG8gIiRzb3VyY2VfbGluZSIgPj4gIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX0dSRUVOfUl0J3MgaW5zdGFsbGVkLiBOb3cgZ2V0IHRvIHdvcmsuJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfVJlc3RhcnQgeW91ciBzaGVsbCwgb3IgcnVuICR7Q19CT0xEfXNvdXJjZSAkcHJvZmlsZV9maWxlJHtDX1lFTExPV30gdG8gc3RhcnQuJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICJcbiR7Q19CT0xEfS0tLSBIT1cgVE8gVVNFIC0tLSR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiSnVzdCB0eXBlICR7Q19SRURfQk9MRH1mdWNrJHtDX1JFU0VUfSBmb2xsb3dlZCBieSB3aGF0IHlvdSB3YW50IHRvIGRvLiIKICAgICAgICBlY2hvIC1lICJFeGFtcGxlczoiCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIGluc3RhbGwgZ2l0JHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19DWUFOfWZ1Y2sgdW5pbnN0YWxsIGdpdCR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIGZpbmQgYWxsIGZpbGVzIGxhcmdlciB0aGFuIDEwTUIgaW4gdGhlIGN1cnJlbnQgZGlyZWN0b3J5JHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19SRURfQk9MRH1mdWNrIHVuaW5zdGFsbCR7Q19SRVNFVH0gJHtDX0dSRUVOfSMgVW5pbnN0YWxscyAke0NfUkVTRVR9JHtDX1JFRH1mdWNrJHtDX1JFU0VUfSR7Q19HUkVFTn0gaXRzZWxmJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19SRURfQk9MRH1mdWNrIGNvbmZpZyR7Q19SRVNFVH0gJHtDX0dSRUVOfSMgU2hvdyBjb25maWd1cmF0aW9uIGhlbHAke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIlxuJHtDX1lFTExPV31SZW1lbWJlciB0byByZXN0YXJ0IHlvdXIgc2hlbGwgdG8gYmVnaW4hJHtDX1JFU0VUfSIKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfWUVMTE9XfUl0J3MgYWxyZWFkeSBpbnN0YWxsZWQsIGdlbml1cy4gSnVzdCB1cGRhdGVkIHRoZSBzY3JpcHQgZm9yIHlvdS4ke0NfUkVTRVR9IgogICAgZmkKfQoKCiMgLS0tIE1haW4gU2NyaXB0IEVudHJ5cG9pbnQgLS0tCgojIElmIGFyZ3VtZW50cyBhcmUgcGFzc2VkIChlLmcuLCAiYmFzaCAtcyAuLi4iKQppZiBbICIkIyIgLWd0IDAgXTsgdGhlbgogICAgaWYgWyAiJDEiID0gImluc3RhbGwiIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfaW5zdGFsbF9zY3JpcHQKICAgICAgICBleGl0IDAKICAgIGZpCgogICAgX2Z1Y2tfc291cmNlX2NvcmUKICAgIF9mdWNrX2V4ZWN1dGVfcHJvbXB0ICIkQCIKZWxzZQogICAgX2luc3RhbGxfc2NyaXB0CmZpCg=="`);
const INSTALLER_SCRIPT_ZH = b64_to_utf8(`"IyEvYmluL2Jhc2gKIwojIOi/meaYryBmdWNraXRzIOeahOWuieijheWSjOS4tOaXtui/kOihjOiEmuacrAojIOasoui/juS9v+eUqAojCiMgLS0tIOWuieWFqOS9v+eUqOaWueazlSAtLS0KIwojIDEuIOS4i+i9vToKIyAgICBjdXJsIC1vIGZ1Y2tpdHMgaHR0cHM6Ly9mdWNraXRzLjI1NTAwNTUyLnh5ei96aAojCiMgMi4g5p+l55yL5Luj56CBOgojICAgIGxlc3MgZnVja2l0cwojCiMgMy4g6L+Q6KGMICjlronoo4UpOgojICAgIGJhc2ggZnVja2l0cwojCiMgNC4g6L+Q6KGMICjkuLTml7bkvb/nlKgpOgojICAgIGJhc2ggZnVja2l0cyAi5L2g55qE5ZG95LukIgojCgpzZXQgLWV1byBwaXBlZmFpbAoKIyAtLS0g6aKc6Imy5a6a5LmJIC0tLQpyZWFkb25seSBDX1JFU0VUPSdcMDMzWzBtJwpyZWFkb25seSBDX1JFRF9CT0xEPSdcMDMzWzE7MzFtJwpyZWFkb25seSBDX1JFRD0nXDAzM1swOzMxbScKcmVhZG9ubHkgQ19HUkVFTj0nXDAzM1swOzMybScKcmVhZG9ubHkgQ19ZRUxMT1c9J1wwMzNbMDszM20nCnJlYWRvbmx5IENfQ1lBTj0nXDAzM1swOzM2bScKcmVhZG9ubHkgQ19CT0xEPSdcMDMzWzFtJwpyZWFkb25seSBDX0RJTT0nXDAzM1sybScKCnJlYWRvbmx5IEZVQ0tJVFNfTE9DQUxFPSJ6aCIKCiMgLS0tIOaPkOekuuespiAtLS0KcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfVshXSR7Q19SRVNFVH0iCnJlYWRvbmx5IEZDS049IiR7Q19SRUR9W+aPkOekul0ke0NfUkVTRVR9IgoKCiMgLS0tIOmFjee9riAtLS0KaWYgWyAteiAiJHtIT01FOi19IiBdOyB0aGVuCiAgICBlY2hvIC1lICJcMDMzWzE7MzFt6ZSZ6K+vIVwwMzNbMG0gXDAzM1swOzMxbeaCqOeahCBIT01FIOeOr+Wig+WPmOmHj+acquiuvue9ru+8jOaXoOazleehruWumuWuieijheS9jee9ru+8jOivt+WFiOiuvue9ruivpeWPmOmHj+OAgiAo5L6L5aaCOiBleHBvcnQgSE9NRT0vcm9vdClcMDMzWzBtIiA+JjIKICAgIGV4aXQgMQpmaQpyZWFkb25seSBJTlNUQUxMX0RJUj0iJEhPTUUvLmZ1Y2siCnJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgpyZWFkb25seSBDT05GSUdfRklMRT0iJElOU1RBTExfRElSL2NvbmZpZy5zaCIKCgojIC0tLSDmoLjlv4PpgLvovpEgKOWhnui/m+S4gOS4quWtl+espuS4sumHjCkgLS0tCnJlYWQgLXIgLWQgJycgQ09SRV9MT0dJQyA8PCdFT0YnIHx8IHRydWUKCiMgLS0tIGZ1Y2tpdHMg5qC45b+D6YC76L6R5byA5aeLIC0tLQoKIyAtLS0g6aKc6Imy5a6a5LmJIC0tLQojIOWPquacieWcqOayoeWumuS5iei/h+minOiJsueahOaDheWGteS4i+aJjeWumuS5iSAo5Li05pe25qih5byP55SoKQppZiBbIC16ICIke0NfUkVTRVQ6LX0iIF07IHRoZW4KICAgIHJlYWRvbmx5IENfUkVTRVQ9J1wwMzNbMG0nCiAgICByZWFkb25seSBDX1JFRF9CT0xEPSdcMDMzWzE7MzFtJwogICAgcmVhZG9ubHkgQ19SRUQ9J1wwMzNbMDszMW0nCiAgICByZWFkb25seSBDX0dSRUVOPSdcMDMzWzA7MzJtJwogICAgcmVhZG9ubHkgQ19ZRUxMT1c9J1wwMzNbMDszM20nCiAgICByZWFkb25seSBDX0NZQU49J1wwMzNbMDszNm0nCiAgICByZWFkb25seSBDX0JPTEQ9J1wwMzNbMW0nCiAgICByZWFkb25seSBDX0RJTT0nXDAzM1sybScKCiAgICAjIC0tLSDmj5DnpLrnrKYgLS0tCiAgICByZWFkb25seSBGVUNLPSIke0NfUkVEX0JPTER9WyFdJHtDX1JFU0VUfSIKICAgIHJlYWRvbmx5IEZDS049IiR7Q19SRUR9W+aPkOekul0ke0NfUkVTRVR9IgoKZmkKCmlmIFsgLXogIiR7SU5TVEFMTF9ESVIreH0iIF0gfHwgWyAteiAiJHtNQUlOX1NIK3h9IiBdIHx8IFsgLXogIiR7Q09ORklHX0ZJTEUreH0iIF07IHRoZW4KICAgIGlmIFsgLXogIiR7SE9NRTotfSIgXTsgdGhlbgogICAgICAgIHJlYWRvbmx5IElOU1RBTExfRElSPSIvdG1wLy5mdWNrIgogICAgICAgIHJlYWRvbmx5IE1BSU5fU0g9Ii90bXAvLmZ1Y2svbWFpbi5zaCIKICAgICAgICByZWFkb25seSBDT05GSUdfRklMRT0iL3RtcC8uZnVjay9jb25maWcuc2giCiAgICBlbHNlCiAgICAgICAgcmVhZG9ubHkgSU5TVEFMTF9ESVI9IiRIT01FLy5mdWNrIgogICAgICAgIHJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgogICAgICAgIHJlYWRvbmx5IENPTkZJR19GSUxFPSIkSU5TVEFMTF9ESVIvY29uZmlnLnNoIgogICAgZmkKZmkKCiMg5aaC5p6c5a2Y5Zyo6YWN572u5paH5Lu25YiZ5Yqg6L29CmlmIFsgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgc291cmNlICIkQ09ORklHX0ZJTEUiCmZpCgppZiBbIC16ICIke0RFRkFVTFRfQVBJX0VORFBPSU5UK3h9IiBdOyB0aGVuCiAgICByZWFkb25seSBERUZBVUxUX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly9mdWNraXRzLjI1NTAwNTUyLnh5ei96aCIKZmkKCiMg5om+55So5oi3IHNoZWxsIOmFjee9ruaWh+S7tueahOi+heWKqeWHveaVsApfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMg5YW85a65IHNoLCBrc2gg562JCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgU0hFTEwg5Y+Y6YeP5rKh6K6+572u5pe255qE5aSH55So5pa55qGICiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBTSEVMTCDlj5jph4/msqHorr7nva7ml7bnmoTlpIfnlKjmlrnmoYgKICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxzZQogICAgICAgIGVjaG8gInVua25vd25fcHJvZmlsZSIKICAgIGZpCn0KCiMg5qOA5rWL5YyF566h55CG5ZmoCl9mdWNrX2RldGVjdF9wa2dfbWFuYWdlcigpIHsKICAgIGlmIGNvbW1hbmQgLXYgYXB0LWdldCAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJhcHQiCiAgICBlbGlmIGNvbW1hbmQgLXYgeXVtICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gInl1bSIKICAgIGVsaWYgY29tbWFuZCAtdiBkbmYgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAiZG5mIgogICAgZWxpZiBjb21tYW5kIC12IHBhY21hbiAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJwYWNtYW4iCiAgICBlbGlmIGNvbW1hbmQgLXYgenlwcGVyICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gInp5cHBlciIKICAgIGVsaWYgY29tbWFuZCAtdiBicmV3ICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gImJyZXciCiAgICBlbHNlCiAgICAgICAgZWNobyAidW5rbm93biIKICAgIGZpCn0KCiMg5oqK57O757uf5L+h5oGv5pW05oiQ5LiA5Liq5a2X56ym5LiyCl9mdWNrX2NvbGxlY3Rfc3lzaW5mb19zdHJpbmcoKSB7CiAgICBsb2NhbCBwa2dfbWFuYWdlcgogICAgcGtnX21hbmFnZXI9JChfZnVja19kZXRlY3RfcGtnX21hbmFnZXIpCiAgICAjIOacjeWKoeerr+eahCBMTE0g5b6X6IO955yL5oeC6L+Z5Liq5a2X56ym5LiyCiAgICBlY2hvICJPUzogJCh1bmFtZSAtcyksIEFyY2g6ICQodW5hbWUgLW0pLCBTaGVsbDogJHtTSEVMTDotdW5rbm93bn0sIFBrZ01ncjogJHBrZ19tYW5hZ2VyLCBDV0Q6ICQocHdkKSIKfQoKIyBKU09OIOi9rOS5ie+8jOWFjeW+l+WHuumXrumimApfZnVja19qc29uX2VzY2FwZSgpIHsKICAgICMg5bCx6L2s5LmJ6YKj5Yeg5Liq54m55q6K5a2X56ymCiAgICBwcmludGYgJyVzJyAiJDEiIHwgc2VkIC1lICdzL1xcL1xcXFwvZycgLWUgJ3MvIi9cIi9nJyAtZSAncy9cbi9cXG4vZycgLWUgJ3MvXHIvXFxyL2cnIC1lICdzL1x0L1xcdC9nJwp9CgpfZnVja19zaG91bGRfdXNlX2xvY2FsX2FwaSgpIHsKICAgIGlmIFsgLW4gIiR7RlVDS19PUEVOQUlfQVBJX0tFWTotfSIgXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBmaQogICAgcmV0dXJuIDEKfQoKX2Z1Y2tfbG9jYWxfc3lzdGVtX3Byb21wdCgpIHsKICAgIGxvY2FsIHN5c2luZm89IiQxIgogICAgaWYgWyAiJEZVQ0tJVFNfTE9DQUxFIiA9ICJ6aCIgXTsgdGhlbgogICAgICAgIHByaW50ZiAn5L2g5piv5LiA5Liq5LiT5Lia55qEIHNoZWxsIOiEmuacrOeUn+aIkOWZqOOAgueUqOaIt+S8muaPkOS+m+S7luS7rOeahOezu+e7n+S/oeaBr+WSjOS4gOS4quWRveS7pOOAguS9oOeahOS7u+WKoeaYr+i/lOWbnuS4gOS4quWPr+aJp+ihjOeahOOAgeWOn+Wni+eahCBzaGVsbCDohJrmnKzmnaXlrozmiJDku5bku6znmoTnm67moIfjgILohJrmnKzlj6/ku6XmmK/lpJrooYznmoTjgILkuI3opoHmj5Dkvpvku7vkvZXop6Pph4rjgIHms6jph4rjgIFtYXJrZG93biDmoLzlvI/vvIjmr5TlpoIgYGBgYmFzaO+8ieaIliBzaGViYW5n77yI5L6L5aaCICMhL2Jpbi9iYXNo77yJ44CC5Y+q6ZyA6KaB5Y6f5aeL55qE6ISa5pys5YaF5a6544CC55So5oi355qE57O757uf5L+h5oGv5piv77yaJXMnICIkc3lzaW5mbyIKICAgIGVsc2UKICAgICAgICBwcmludGYgJ1lvdSBhcmUgYW4gZXhwZXJ0IHNoZWxsIHNjcmlwdCBnZW5lcmF0b3IuIEEgdXNlciB3aWxsIHByb3ZpZGUgdGhlaXIgc3lzdGVtIGluZm9ybWF0aW9uIGFuZCBhIHByb21wdC4gWW91ciB0YXNrIGlzIHRvIHJldHVybiBhIHJhdywgZXhlY3V0YWJsZSBzaGVsbCBzY3JpcHQgdGhhdCBhY2NvbXBsaXNoZXMgdGhlaXIgZ29hbC4gVGhlIHNjcmlwdCBjYW4gYmUgbXVsdGktbGluZS4gRG8gbm90IHByb3ZpZGUgYW55IGV4cGxhbmF0aW9uLCBjb21tZW50cywgbWFya2Rvd24gZm9ybWF0dGluZyAobGlrZSBgYGBiYXNoKSwgb3IgYSBzaGViYW5nIChlLmcuLCAjIS9iaW4vYmFzaCkuIEp1c3QgdGhlIHJhdyBzY3JpcHQgY29udGVudC4gVGhlIHVzZXInIiciJ3Mgc3lzdGVtIGluZm8gaXM6ICVzJyAiJHN5c2luZm8iCiAgICBmaQp9CgpfZnVja19leHRyYWN0X2NvbW1hbmRfZnJvbV9qc29uKCkgewogICAgbG9jYWwganNvbl9maWxlPSIkMSIKICAgIGlmIGNvbW1hbmQgLXYgcHl0aG9uMyA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBweXRob24zIC0gIiRqc29uX2ZpbGUiIDw8J1BZMicKaW1wb3J0IGpzb24sIHN5cwpwYXRoID0gc3lzLmFyZ3ZbMV0Kd2l0aCBvcGVuKHBhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgIGRhdGEgPSBqc29uLmxvYWQoZikKY2hvaWNlcyA9IGRhdGEuZ2V0KCdjaG9pY2VzJykgb3IgW10KaWYgbm90IGNob2ljZXM6CiAgICBzeXMuZXhpdCgxKQptZXNzYWdlID0gY2hvaWNlc1swXS5nZXQoJ21lc3NhZ2UnKSBvciB7fQpjb250ZW50ID0gKG1lc3NhZ2UuZ2V0KCdjb250ZW50Jykgb3IgJycpLnN0cmlwKCkKaWYgbm90IGNvbnRlbnQ6CiAgICBzeXMuZXhpdCgxKQpwcmludChjb250ZW50KQpQWTIKICAgICAgICByZXR1cm4KICAgIGZpCgogICAgaWYgY29tbWFuZCAtdiBub2RlID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgIG5vZGUgLSAiJGpzb25fZmlsZSIgPDwnSlMyJwpjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CmNvbnN0IHBhdGggPSBwcm9jZXNzLmFyZ3ZbMV07CmNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmOCcpKTsKY29uc3QgY2hvaWNlID0gKGRhdGEuY2hvaWNlcyAmJiBkYXRhLmNob2ljZXNbMF0pIHx8IHt9Owpjb25zdCBtZXNzYWdlID0gY2hvaWNlLm1lc3NhZ2UgfHwge307CmNvbnN0IGNvbnRlbnQgPSAobWVzc2FnZS5jb250ZW50IHx8ICcnKS50cmltKCk7CmlmICghY29udGVudCkgewogIHByb2Nlc3MuZXhpdCgxKTsKfQpjb25zb2xlLmxvZyhjb250ZW50KTsKSlMyCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR95peg5rOV6Kej5p6Q5qih5Z6L6L+U5Zue55qE5pWw5o2u77yM6K+35a6J6KOFIHB5dGhvbjMg5oiWIG5vZGXjgIIke0NfUkVTRVR9IiA+JjIKICAgIHJldHVybiAxCn0KCl9mdWNrX3JlcXVlc3RfbG9jYWxfbW9kZWwoKSB7CiAgICBsb2NhbCBwcm9tcHQ9IiQxIgogICAgbG9jYWwgc3lzaW5mbz0iJDIiCiAgICBsb2NhbCBjdXJsX3RpbWVvdXQ9IiQzIgoKICAgIGxvY2FsIGFwaV9rZXk9IiR7RlVDS19PUEVOQUlfQVBJX0tFWTotfSIKICAgIGlmIFsgLXogIiRhcGlfa2V5IiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH3mnKrphY3nva7mnKzlnLAgQVBJIEtlee+8jOivt+WcqCB+Ly5mdWNrL2NvbmZpZy5zaCDkuK3orr7nva4gRlVDS19PUEVOQUlfQVBJX0tFWeOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIG1vZGVsPSIke0ZVQ0tfT1BFTkFJX01PREVMOi1ncHQtNS1uYW5vfSIKICAgIGxvY2FsIGFwaV9iYXNlPSIke0ZVQ0tfT1BFTkFJX0FQSV9CQVNFOi1odHRwczovL2FwaS5vcGVuYWkuY29tL3YxfSIKICAgIGFwaV9iYXNlPSR7YXBpX2Jhc2UlL30KICAgIGxvY2FsIGFwaV91cmw9IiRhcGlfYmFzZS9jaGF0L2NvbXBsZXRpb25zIgoKICAgIF9mdWNrX2RlYnVnICLmnKzlnLAgQVBJIOWfuuWdgDogJGFwaV9iYXNlIgogICAgX2Z1Y2tfZGVidWcgIuacrOWcsOaooeWeizogJG1vZGVsIgoKICAgIGxvY2FsIHN5c3RlbV9wcm9tcHQKICAgIHN5c3RlbV9wcm9tcHQ9JChfZnVja19sb2NhbF9zeXN0ZW1fcHJvbXB0ICIkc3lzaW5mbyIpCgogICAgbG9jYWwgcGF5bG9hZAogICAgcGF5bG9hZD0kKHByaW50ZiAneyAibW9kZWwiOiAiJXMiLCAibWVzc2FnZXMiOiBbIHsicm9sZSI6InN5c3RlbSIsImNvbnRlbnQiOiIlcyJ9LCB7InJvbGUiOiJ1c2VyIiwiY29udGVudCI6IiVzIn0gXSwgIm1heF90b2tlbnMiOiAxMDI0LCAidGVtcGVyYXR1cmUiOiAwLjIgfScgXAogICAgICAgICIkbW9kZWwiICIkKF9mdWNrX2pzb25fZXNjYXBlICIkc3lzdGVtX3Byb21wdCIpIiAiJChfZnVja19qc29uX2VzY2FwZSAiJHByb21wdCIpIikKCiAgICBsb2NhbCB0bXBfanNvbgogICAgdG1wX2pzb249JChta3RlbXApIHx8IHJldHVybiAxCgogICAgaWYgISBjdXJsIC1mc1MgLS1tYXgtdGltZSAiJGN1cmxfdGltZW91dCIgIiRhcGlfdXJsIiBcCiAgICAgICAgLUggIkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbiIgXAogICAgICAgIC1IICJBdXRob3JpemF0aW9uOiBCZWFyZXIgJGFwaV9rZXkiIFwKICAgICAgICAtZCAiJHBheWxvYWQiID4gIiR0bXBfanNvbiI7IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfeacrOWcsCBBUEkg6K+35rGC5aSx6LSl44CCJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgY2F0ICIkdG1wX2pzb24iID4mMgogICAgICAgIHJtIC1mICIkdG1wX2pzb24iCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgbG9jYWwgY29tbWFuZF9vdXRwdXQKICAgIGlmICEgY29tbWFuZF9vdXRwdXQ9JChfZnVja19leHRyYWN0X2NvbW1hbmRfZnJvbV9qc29uICIkdG1wX2pzb24iKTsgdGhlbgogICAgICAgIHJtIC1mICIkdG1wX2pzb24iCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH3ml6Dms5Xop6PmnpDmqKHlnovov5Tlm57lhoXlrrnjgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBybSAtZiAiJHRtcF9qc29uIgogICAgcHJpbnRmICclc1xuJyAiJGNvbW1hbmRfb3V0cHV0Igp9CgpfZnVja19yZXF1ZXN0X3dvcmtlcl9tb2RlbCgpIHsKICAgIGxvY2FsIHByb21wdD0iJDEiCiAgICBsb2NhbCBzeXNpbmZvPSIkMiIKICAgIGxvY2FsIGN1cmxfdGltZW91dD0iJDMiCgogICAgbG9jYWwgYWRtaW5fa2V5PSIke0ZVQ0tfQURNSU5fS0VZOi19IgogICAgbG9jYWwgYWRtaW5fc2VnbWVudD0iIgogICAgaWYgWyAtbiAiJGFkbWluX2tleSIgXTsgdGhlbgogICAgICAgIGFkbWluX3NlZ21lbnQ9JChwcmludGYgJywgImFkbWluS2V5IjogIiVzIicgIiQoIF9mdWNrX2pzb25fZXNjYXBlICIkYWRtaW5fa2V5IiApIikKICAgIGZpCgogICAgbG9jYWwgcGF5bG9hZAogICAgcGF5bG9hZD0kKHByaW50ZiAneyAic3lzaW5mbyI6ICIlcyIsICJwcm9tcHQiOiAiJXMiJXMgfScgXAogICAgICAgICIkKCBfZnVja19qc29uX2VzY2FwZSAiJHN5c2luZm8iICkiIFwKICAgICAgICAiJCggX2Z1Y2tfanNvbl9lc2NhcGUgIiRwcm9tcHQiICkiIFwKICAgICAgICAiJGFkbWluX3NlZ21lbnQiKQoKICAgIGxvY2FsIGFwaV91cmw9IiR7RlVDS19BUElfRU5EUE9JTlQ6LSRERUZBVUxUX0FQSV9FTkRQT0lOVH0iCgogICAgX2Z1Y2tfZGVidWcgIkFQSSBVUkw6ICRhcGlfdXJsIgogICAgX2Z1Y2tfZGVidWcgIlBheWxvYWQ6ICRwYXlsb2FkIgogICAgX2Z1Y2tfZGVidWcgIlRpbWVvdXQ6ICRjdXJsX3RpbWVvdXQiCgogICAgbG9jYWwgdG1wX3Jlc3BvbnNlIHRtcF9zdGF0dXMKICAgIHRtcF9yZXNwb25zZT0kKG1rdGVtcCkKICAgIHRtcF9zdGF0dXM9JChta3RlbXApCgogICAgKAogICAgICAgIGN1cmwgLXNTIC0tbWF4LXRpbWUgIiRjdXJsX3RpbWVvdXQiIC1YIFBPU1QgIiRhcGlfdXJsIiBcCiAgICAgICAgICAgIC1IICJDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb24iIFwKICAgICAgICAgICAgLWQgIiRwYXlsb2FkIiAtbyAiJHRtcF9yZXNwb25zZSIgLXcgIiV7aHR0cF9jb2RlfSIgPiAiJHRtcF9zdGF0dXMiCiAgICApICYKICAgIGxvY2FsIHBpZD0kIQoKICAgIGlmIFsgLXQgMiBdOyB0aGVuCiAgICAgICAgX2Z1Y2tfc3Bpbm5lciAiJHBpZCIgPiYyCiAgICBmaQoKICAgIGxvY2FsIGN1cmxfZXhpdD0wCiAgICBpZiAhIHdhaXQgIiRwaWQiOyB0aGVuCiAgICAgICAgY3VybF9leGl0PSQ/CiAgICBmaQoKICAgIGxvY2FsIGh0dHBfc3RhdHVzPSIiCiAgICBpZiBbIC1mICIkdG1wX3N0YXR1cyIgXTsgdGhlbgogICAgICAgIGh0dHBfc3RhdHVzPSQodHIgLWQgJ1xyXG4nIDwgIiR0bXBfc3RhdHVzIikKICAgICAgICBybSAtZiAiJHRtcF9zdGF0dXMiCiAgICBmaQoKICAgIGxvY2FsIHJlc3BvbnNlPSIiCiAgICBpZiBbIC1mICIkdG1wX3Jlc3BvbnNlIiBdOyB0aGVuCiAgICAgICAgcmVzcG9uc2U9JChjYXQgIiR0bXBfcmVzcG9uc2UiKQogICAgICAgIHJtIC1mICIkdG1wX3Jlc3BvbnNlIgogICAgZmkKCiAgICBpZiBbICRjdXJsX2V4aXQgLW5lIDAgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR95peg5rOV6L+e5o6l5Yiw5YWx5LqrIFdvcmtlcuOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIGlmIFsgLW4gIiRyZXNwb25zZSIgXTsgdGhlbgogICAgICAgICAgICBlY2hvIC1lICIke0NfRElNfSRyZXNwb25zZSR7Q19SRVNFVH0iID4mMgogICAgICAgIGZpCiAgICAgICAgcmV0dXJuICRjdXJsX2V4aXQKICAgIGZpCgogICAgaWYgWyAteiAiJGh0dHBfc3RhdHVzIiBdOyB0aGVuCiAgICAgICAgaHR0cF9zdGF0dXM9MAogICAgZmkKCiAgICBpZiBbICIkaHR0cF9zdGF0dXMiIC1lcSA0MjkgXSAmJiBwcmludGYgJyVzJyAiJHJlc3BvbnNlIiB8IGdyZXAgLXEgJ0RFTU9fTElNSVRfRVhDRUVERUQnOyB0aGVuCiAgICAgICAgbG9jYWwgbGltaXQKICAgICAgICBsaW1pdD0kKHByaW50ZiAnJXMnICIkcmVzcG9uc2UiIHwgc2VkIC1uICdzLy4qImxpbWl0IjpbWzpzcGFjZTpdXSpcKFswLTldXCtcKS4qL1wxL3AnIHwgaGVhZCAtbjEpCiAgICAgICAgbG9jYWwgcmVtYWluaW5nCiAgICAgICAgcmVtYWluaW5nPSQocHJpbnRmICclcycgIiRyZXNwb25zZSIgfCBzZWQgLW4gJ3MvLioicmVtYWluaW5nIjpbWzpzcGFjZTpdXSpcKFswLTldXCtcKS4qL1wxL3AnIHwgaGVhZCAtbjEpCiAgICAgICAgWyAteiAiJGxpbWl0IiBdICYmIGxpbWl0PTEwCiAgICAgICAgX2Z1Y2tfbm90aWZ5X2RlbW9fbGltaXQgIiRsaW1pdCIgIiRyZW1haW5pbmciCiAgICAgICAgcmV0dXJuIDIKICAgIGZpCgogICAgaWYgWyAiJGh0dHBfc3RhdHVzIiAtZ2UgNDAwIF0gfHwgWyAteiAiJHJlc3BvbnNlIiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH3lhbHkuqsgV29ya2VyIOi/lOWbniBIVFRQICRodHRwX3N0YXR1c+OAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIGlmIFsgLW4gIiRyZXNwb25zZSIgXTsgdGhlbgogICAgICAgICAgICBlY2hvIC1lICIke0NfRElNfSRyZXNwb25zZSR7Q19SRVNFVH0iID4mMgogICAgICAgIGZpCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgcHJpbnRmICclc1xuJyAiJHJlc3BvbnNlIgp9CgpfZnVja19ub3RpZnlfZGVtb19saW1pdCgpIHsKICAgIGxvY2FsIGRhaWx5X2xpbWl0PSIkezE6LTEwfSIKICAgIGxvY2FsIHJlbWFpbmluZz0iJHsyOi0wfSIKCiAgICBlY2hvIC1lICIkRlVDSyAke0NfWUVMTE9XfeWFseS6q+S9k+mqjOmineW6puW3sueUqOWFie+8iOavj+WkqeacgOWkmiAke2RhaWx5X2xpbWl0fSDmrKHvvInjgIIke0NfUkVTRVR9IiA+JjIKICAgIGNhc2UgIiRyZW1haW5pbmciIGluCiAgICAgICAgJyd8KlshMC05XSopIDs7CiAgICAgICAgKikKICAgICAgICAgICAgaWYgWyAiJHJlbWFpbmluZyIgLWd0IDAgXTsgdGhlbgogICAgICAgICAgICAgICAgZWNobyAtZSAiJHtDX0RJTX3ku4rml6XliankvZnpop3luqbvvJokcmVtYWluaW5nIOasoeOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICBmaQogICAgICAgICAgICA7OwogICAgZXNhYwoKICAgIF9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzCiAgICBfZnVja19zZWN1cmVfY29uZmlnX2ZpbGUKCiAgICBlY2hvIC1lICIke0NfQ1lBTn3op6PlhrPmlrnmoYjvvJoke0NfUkVTRVR96L+Q6KGMICR7Q19HUkVFTn1mdWNrIGNvbmZpZyR7Q19SRVNFVH3vvIzlnKggJHtDX0dSRUVOfSRDT05GSUdfRklMRSR7Q19SRVNFVH0g5Lit6K6+572uICR7Q19CT0xEfUZVQ0tfT1BFTkFJX0FQSV9LRVkke0NfUkVTRVR977yM5b+F6KaB5pe25ZCM5pe26YWN572uICR7Q19CT0xEfUZVQ0tfT1BFTkFJX01PREVMJHtDX1JFU0VUfS8ke0NfQk9MRH1GVUNLX09QRU5BSV9BUElfQkFTRSR7Q19SRVNFVH3jgIIiID4mMgogICAgZWNobyAtZSAiJHtDX0NZQU596Iul5L2g5oyB5pyJ566h55CG5ZGY5YWN6aKd5a+G6ZKl77yaJHtDX1JFU0VUfeWQjOagt+WcqOivpeaWh+S7tuS4remFjee9riAke0NfQk9MRH1GVUNLX0FETUlOX0tFWSR7Q19SRVNFVH3vvIjpnIDkuI4gV29ya2VyIOS+p+eahCBBRE1JTl9BQ0NFU1NfS0VZIOWMuemFje+8ieWNs+WPr+i3s+i/h+WFseS6q+mineW6pumZkOWItuOAgiIgPiYyCiAgICBpZiBbIC1uICIke0VESVRPUjotfSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95o+Q56S677yaJHtDX1JFU0VUfSR7RURJVE9SfSBcIiRDT05GSUdfRklMRVwiIiA+JjIKICAgIGZpCiAgICBlY2hvIC1lICIke0NfRElNfeWuieWFqOaPkOekuu+8mumFjee9ruaWh+S7tuiHquWKqCBjaG1vZCA2MDDvvIzku4XpmZDlvZPliY3nlKjmiLfor7vlj5bjgIIke0NfUkVTRVR9IiA+JjIKfQoKCiMg5Yik5pat5piv5ZCm5Li6IHRydWUveWVzL29uIOetiQpfZnVja190cnV0aHkoKSB7CiAgICBsb2NhbCB2YWx1ZT0iJHsxOi19IgogICAgbG9jYWwgbm9ybWFsaXplZAogICAgbm9ybWFsaXplZD0kKHByaW50ZiAnJXMnICIkdmFsdWUiIHwgdHIgJ1s6dXBwZXI6XScgJ1s6bG93ZXI6XScpCiAgICBjYXNlICIkbm9ybWFsaXplZCIgaW4KICAgICAgICAxfHRydWV8eWVzfHl8b2585pivfOW8gHznnJ8pCiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgIDs7CiAgICAgICAgKikKICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgOzsKICAgIGVzYWMKfQoKIyDosIPor5Xml6Xlv5cKX2Z1Y2tfZGVidWcoKSB7CiAgICBpZiBfZnVja190cnV0aHkgIiR7RlVDS19ERUJVRzotMH0iOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX0RJTX1b6LCD6K+VXSAkKiR7Q19SRVNFVH0iID4mMgogICAgZmkKfQoKIyBTcGlubmVyIOWKqOeUuwpfZnVja19zcGlubmVyKCkgewogICAgbG9jYWwgcGlkPSQxCiAgICBsb2NhbCBkZWxheT0wLjEKICAgIGxvY2FsIHNwaW5zdHI9J+Kgi+KgmeKgueKguOKgvOKgtOKgpuKgp+Kgh+KgjycKICAgIAogICAgIyDpmpDol4/lhYnmoIcKICAgIHRwdXQgY2l2aXMgMj4vZGV2L251bGwgfHwgcHJpbnRmICJcMDMzWz8yNWwiCgogICAgd2hpbGUga2lsbCAtMCAiJHBpZCIgMj4vZGV2L251bGw7IGRvCiAgICAgICAgbG9jYWwgdGVtcD0ke3NwaW5zdHIjP30KICAgICAgICBwcmludGYgIiAlYyAiICIkc3BpbnN0ciIKICAgICAgICBsb2NhbCBzcGluc3RyPSR0ZW1wJHtzcGluc3RyJSIkdGVtcCJ9CiAgICAgICAgc2xlZXAgJGRlbGF5CiAgICAgICAgcHJpbnRmICJcYlxiXGIiCiAgICBkb25lCiAgICBwcmludGYgIiAgIFxiXGJcYiIKICAgIAogICAgIyDmgaLlpI3lhYnmoIcKICAgIHRwdXQgY25vcm0gMj4vZGV2L251bGwgfHwgcHJpbnRmICJcMDMzWz8yNWgiCn0KCiMg5qOA5rWL5r2c5Zyo5Y2x6Zmp5ZG95Luk5bm25Y+R5Ye66K2m5ZGKCl9mdWNrX2RldGVjdF9kYW5nZXJvdXNfY29tbWFuZCgpIHsKICAgIGxvY2FsIGNvbW1hbmRfdG9fY2hlY2s9IiQxIgogICAgbG9jYWwgZGFuZ2Vyb3VzX2ZvdW5kPWZhbHNlCgogICAgIyDljbHpmanmqKHlvI/liJfooagKICAgIGxvY2FsIHBhdHRlcm5zPSgKICAgICAgICAnXGJybSAtcmYnCiAgICAgICAgJ1xibWtmc1xiJwogICAgICAgICdcYmRkXGInCiAgICAgICAgJyA+IC9kZXYvbnVsbCcgIyDph43lrprlkJHovpPlh7rliLAgL2Rldi9udWxsIOeahOa9nOWcqOWNsemZqeWRveS7pAogICAgICAgICcgPiAvZXRjL3Bhc3N3ZCcKICAgICAgICAnID4gL2V0Yy9zaGFkb3cnCiAgICAgICAgJyA+IC9ldGMvc3Vkb2VycycKICAgICAgICAnID4gL2Rldi9zZGEnICMg5oiW5YW25LuW56OB55uY6K6+5aSHCiAgICAgICAgJ2NobW9kIC4qIDc3NycKICAgICAgICAnXGJ3aXBlZnNcYicKICAgICAgICAnXGJmb3JtYXRcYicKICAgICAgICAnXGJzaHJlZFxiJwogICAgICAgICdcYmZkaXNrXGInCiAgICAgICAgJ1xicGFydGVkXGInCiAgICAgICAgJ1xiY3VybCAuKiBcfCBzdWRvIHNoJyAjIHBpcGluZyBjdXJsIHRvIHN1ZG8gc2gKICAgICAgICAnXGJ3Z2V0IC4qIFx8IHN1ZG8gc2gnICMgcGlwaW5nIHdnZXQgdG8gc3VkbyBzaAogICAgKQoKICAgIGZvciBwYXR0ZXJuIGluICIke3BhdHRlcm5zW0BdfSI7IGRvCiAgICAgICAgaWYgcHJpbnRmICclcycgIiRjb21tYW5kX3RvX2NoZWNrIiB8IGdyZXAgLUVxICIkcGF0dGVybiI7IHRoZW4KICAgICAgICAgICAgZWNobyAtZSAiJHtDX1JFRF9CT0xEfeKaoO+4jyAg6K2m5ZGKOiDmo4DmtYvliLDmvZzlnKjljbHpmanlkb3ku6QhIOKaoO+4jyR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfeeUn+aIkOeahOWRveS7pOWMheWQq+WPr+iDveWvvOiHtOaVsOaNruS4ouWkseaIluezu+e7n+S4jeeos+WumueahOaooeW8j+OAgiR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9Xfeivt+WcqOaJp+ihjOWJjeS7lOe7huajgOafpeOAguWmguaenOS4jeehruWumu+8jOivt+aMiSAke0NfQk9MRH1uJHtDX1JFU0VUfSR7Q19ZRUxMT1d9IOWPlua2iOOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgICAgICBkYW5nZXJvdXNfZm91bmQ9dHJ1ZQogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICBkb25lCiAgICAKICAgIGlmICRkYW5nZXJvdXNfZm91bmQ7IHRoZW4KICAgICAgICByZXR1cm4gMCAjIOWPkeeOsOWNsemZqeWRveS7pAogICAgZWxzZQogICAgICAgIHJldHVybiAxICMg5pyq5Y+R546w5Y2x6Zmp5ZG95LukCiAgICBmaQp9CgoKIyDnoa7kv53phY3nva7mlofku7blrZjlnKgKX2Z1Y2tfc2VjdXJlX2NvbmZpZ19maWxlKCkgewogICAgaWYgWyAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICAgICAgY2htb2QgNjAwICIkQ09ORklHX0ZJTEUiIDI+L2Rldi9udWxsIHx8IHRydWUKICAgIGZpCn0KCl9mdWNrX2FwcGVuZF9jb25maWdfaGludCgpIHsKICAgIGxvY2FsIGtleT0iJDEiCiAgICBsb2NhbCBjb21tZW50PSIkMiIKICAgIGxvY2FsIHNhbXBsZT0iJDMiCiAgICBsb2NhbCBxdW90ZWQ9IiR7NDotMX0iCiAgICBbIC1mICIkQ09ORklHX0ZJTEUiIF0gfHwgcmV0dXJuCiAgICBpZiBncmVwIC1FcSAiXlxccyojP1xccypleHBvcnRcXHMrJGtleSIgIiRDT05GSUdfRklMRSI7IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCgogICAgbG9jYWwgYXNzaWdubWVudAogICAgaWYgWyAiJHF1b3RlZCIgPSAiMSIgXTsgdGhlbgogICAgICAgIGFzc2lnbm1lbnQ9IiMgZXhwb3J0ICRrZXk9XCIkc2FtcGxlXCIiCiAgICBlbHNlCiAgICAgICAgYXNzaWdubWVudD0iIyBleHBvcnQgJGtleT0kc2FtcGxlIgogICAgZmkKCiAgICB7CiAgICAgICAgcHJpbnRmICdcbicKICAgICAgICBwcmludGYgJyMgJXNcbicgIiRjb21tZW50IgogICAgICAgIHByaW50ZiAnJXNcbicgIiRhc3NpZ25tZW50IgogICAgfSA+PiAiJENPTkZJR19GSUxFIgp9CgpfZnVja19zZWVkX2NvbmZpZ19wbGFjZWhvbGRlcnMoKSB7CiAgICBbIC1mICIkQ09ORklHX0ZJTEUiIF0gfHwgcmV0dXJuCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfT1BFTkFJX0FQSV9LRVkiICLmnKzlnLAgT3BlbkFJIOWFvOWuuSBLZXnvvIjmjqjojZDvvIkiICdzay0uLi4nCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfQURNSU5fS0VZIiAi566h55CG5ZGY5YWN6aKd5bqm5a+G6ZKl77yI5LuF5YiG5Lqr57uZ5L+h5Lu755qE5Lq677yJIiAnYWRtLS4uLicKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19PUEVOQUlfTU9ERUwiICLopobnm5bpu5jorqTmqKHlnosiICdncHQtNG8tbWluaScKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19PUEVOQUlfQVBJX0JBU0UiICLoh6rlrprkuYkgQVBJIOWfuuWdgCIgJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEnCiAgICBfZnVja19hcHBlbmRfY29uZmlnX2hpbnQgIkZVQ0tfQUxJQVMiICLpop3lpJbliKvlkI3vvIjkuI3lvbHlk43pu5jorqQgZnVja++8iSIgJ+i/kOihjCcKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19BVVRPX0VYRUMiICLoh6rliqjmiafooYzov5Tlm57lkb3ku6TvvIjljbHpmanmk43kvZzvvIkiICdmYWxzZScgMAogICAgX2Z1Y2tfYXBwZW5kX2NvbmZpZ19oaW50ICJGVUNLX1RJTUVPVVQiICLor7fmsYLotoXml7bml7bpl7TvvIjnp5LvvIkiICczMCcgMAogICAgX2Z1Y2tfYXBwZW5kX2NvbmZpZ19oaW50ICJGVUNLX0RFQlVHIiAi5piv5ZCm6L6T5Ye66LCD6K+V5L+h5oGvIiAnZmFsc2UnIDAKICAgIF9mdWNrX2FwcGVuZF9jb25maWdfaGludCAiRlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVMiICLnpoHnlKjlhoXnva4gZnVjayDliKvlkI0iICdmYWxzZScgMAp9CgpfZnVja19lbnN1cmVfY29uZmlnX2V4aXN0cygpIHsKICAgIGlmIFsgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgICAgIF9mdWNrX3NlZWRfY29uZmlnX3BsYWNlaG9sZGVycwogICAgICAgIF9mdWNrX3NlY3VyZV9jb25maWdfZmlsZQogICAgICAgIHJldHVybgogICAgZmkKCiAgICBta2RpciAtcCAiJChkaXJuYW1lICIkQ09ORklHX0ZJTEUiKSIKICAgIGNhdCA8PCdDRkcnID4gIiRDT05GSUdfRklMRSIKIyBmdWNraXRzIOmFjee9ruekuuS+iwojIOWOu+aOieihjOmmlueahCAj77yM5pS55oiQ5L2g6Ieq5bex55qE5YC85Y2z5Y+v44CCCgojIOiHquW7ui/oh6rlrprkuYkgV29ya2VyIOWFpeWPowojIGV4cG9ydCBGVUNLX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly95b3VyLWRvbWFpbi53b3JrZXJzLmRldi8iCgojIOacrOWcsCBPcGVuQUkg5YW85a65IEtlee+8iOW8uueDiOaOqOiNkO+8iQojIGV4cG9ydCBGVUNLX09QRU5BSV9BUElfS0VZPSJzay0uLi4iCgojIOeuoeeQhuWRmOS4k+eUqOWFjemineW6puWvhumSpe+8iOS7heWIhuS6q+e7meS/oeS7u+eahOS6uu+8iQojIGV4cG9ydCBGVUNLX0FETUlOX0tFWT0iYWRtLS4uLiIKCiMg6KaG55uW6buY6K6k5qih5Z6L5oiWIEFQSSDln7rlnYAKIyBleHBvcnQgRlVDS19PUEVOQUlfTU9ERUw9ImdwdC00by1taW5pIgojIGV4cG9ydCBGVUNLX09QRU5BSV9BUElfQkFTRT0iaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MSIKCiMg6aKd5aSW5Yir5ZCN77yI5LiN5Lya5b2x5ZON6buY6K6kIGZ1Y2vvvIkKIyBleHBvcnQgRlVDS19BTElBUz0i6L+Q6KGMIgoKIyDoh6rliqjmiafooYzov5Tlm57lkb3ku6TvvIjljbHpmanvvIzosKjmhY7lvIDlkK/vvIkKIyBleHBvcnQgRlVDS19BVVRPX0VYRUM9ZmFsc2UKCiMg6K+35rGC6LaF5pe25pe26Ze077yI56eS77yJCiMgZXhwb3J0IEZVQ0tfVElNRU9VVD0zMAoKIyDmmK/lkKbovpPlh7rosIPor5Xkv6Hmga8KIyBleHBvcnQgRlVDS19ERUJVRz1mYWxzZQoKIyDnpoHnlKjlhoXnva4gZnVjayDliKvlkI0KIyBleHBvcnQgRlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVM9ZmFsc2UKQ0ZHCgogICAgX2Z1Y2tfc2VlZF9jb25maWdfcGxhY2Vob2xkZXJzCiAgICBfZnVja19zZWN1cmVfY29uZmlnX2ZpbGUKfQoKIyDmmL7npLrphY3nva7mj5DnpLoKX2Z1Y2tfc2hvd19jb25maWdfaGVscCgpIHsKICAgIF9mdWNrX2Vuc3VyZV9jb25maWdfZXhpc3RzCiAgICBlY2hvIC1lICIke0NfWUVMTE9XfemFjee9ruaWh+S7tu+8miR7Q19SRVNFVH0gJHtDX0NZQU59JENPTkZJR19GSUxFJHtDX1JFU0VUfSIKICAgIGlmIFsgLW4gIiR7RURJVE9SOi19IiBdOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33lj6/ku6Xkvb/nlKjvvJoke0NfUkVTRVR9ICR7Q19DWUFOfSR7RURJVE9SfSAkQ09ORklHX0ZJTEUke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d955So5Lu75oSP57yW6L6R5Zmo5omT5byA6K+l5paH5Lu25Y2z5Y+v5L+u5pS56YWN572u44CCJHtDX1JFU0VUfSIKICAgIGZpCiAgICBlY2hvIC1lICIke0NfQ1lBTn3lj6/nlKjpgInpobnvvJoke0NfUkVTRVR9RlVDS19BUElfRU5EUE9JTlQsIEZVQ0tfT1BFTkFJX0FQSV9LRVksIEZVQ0tfQURNSU5fS0VZLCBGVUNLX09QRU5BSV9NT0RFTCwgRlVDS19PUEVOQUlfQVBJX0JBU0UsIEZVQ0tfQUxJQVMsIEZVQ0tfQVVUT19FWEVDLCBGVUNLX1RJTUVPVVQsIEZVQ0tfREVCVUcsIEZVQ0tfRElTQUJMRV9ERUZBVUxUX0FMSUFTIgogICAgZWNobyAtZSAiJHtDX0RJTX3lronlhajor7TmmI7vvJrphY3nva7mlofku7bkvJroh6rliqggY2htb2QgNjAw77yM6Ziy5q2iIEtleSDms4TpnLLjgIIke0NfUkVTRVR9Igp9CgojIOWNuOi9veiEmuacrApfdW5pbnN0YWxsX3NjcmlwdCgpIHsKICAgIGVjaG8gLWUgIiR7Q19SRURfQk9MRH3lpb3lpb3lpb3vvIEke0NfUkVTRVR9JHtDX1lFTExPV33mgI7kuYjnnYDvvIzopoHljbjno6jmnYDpqbTllYrvvJ/ooYzllYrkvaDkuKrogIHlha3vvIzmiJHnnJ/osKLosKLkvaDkuobjgIIke0NfUkVTRVR9IgoKICAgICMg5om+6YWN572u5paH5Lu2CiAgICBsb2NhbCBwcm9maWxlX2ZpbGUKICAgIHByb2ZpbGVfZmlsZT0kKF9pbnN0YWxsZXJfZGV0ZWN0X3Byb2ZpbGUpCiAgICBsb2NhbCBzb3VyY2VfbGluZT0ic291cmNlICRNQUlOX1NIIgoKICAgIGlmIFsgIiRwcm9maWxlX2ZpbGUiICE9ICJ1bmtub3duX3Byb2ZpbGUiIF0gJiYgWyAtZiAiJHByb2ZpbGVfZmlsZSIgXTsgdGhlbgogICAgICAgIGlmIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICAgICAjIOeUqCBzZWQg5oqK6YKj5Yeg6KGM5Yig5LqG77yM6aG65L6/5aSH5Liq5Lu9CiAgICAgICAgICAgIGlmIHNlZCAtLXZlcnNpb24gPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICJcfCRzb3VyY2VfbGluZVx8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICJcfCMgQWRkZWQgYnkgZnVja2l0cyBpbnN0YWxsZXJcfGQiICIkcHJvZmlsZV9maWxlIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICIiIC1lICJcfCRzb3VyY2VfbGluZVx8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgICAgICAgICBzZWQgLWkuYmFrICIiIC1lICJcfCMgQWRkZWQgYnkgZnVja2l0cyBpbnN0YWxsZXJcfGQiICIkcHJvZmlsZV9maWxlIgogICAgICAgICAgICBmaQogICAgICAgIGZpCiAgICBlbHNlCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33mib7kuI3liLAgc2hlbGwg6YWN572u5paH5Lu277yM5oKo5Y+v5Lul5omL5Yqo5Yig6Zmk55u45YWz6YWN572u44CCJHtDX1JFU0VUfSIKICAgIGZpCgogICAgaWYgWyAtZCAiJElOU1RBTExfRElSIiBdOyB0aGVuCiAgICAgICAgcm0gLXJmICIkSU5TVEFMTF9ESVIiCiAgICBmaQoKICAgIHNsZWVwIDMKICAgIGVjaG8gLWUgIiR7Q19HUkVFTn3ooYzvvIzmiJHlhYjotbDkuIDmraXvvIzlkYrovp7jgIIke0NfQ1lBTn3otbbntKfph43lkK/kvaDpgqPnu4jnq6/lkKfvvIzkuI3nhLbkvJrliKvlkI3msaHmn5PjgIIke0NfUkVTRVR9IgogICAgc2xlZXAgMwogICAgZWNobyAtZSAiJHtDX1lFTExPV33kuLTliKvkuYvpmYXvvIznjK7kuIrkuIDpppblsI/or5fvvIznpZ3mgqjliY3nqIvkvLzplKbvvJoke0NfUkVTRVR9IgogICAgc2xlZXAgMgogICAgZWNobyAtZSAiXG4ke0NfUkVEfeOAiuivl+e7j8K35b286Ziz44CLJHtDX1JFU0VUfSIKICAgIHNsZWVwIDIKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95b286Ziz6Iul6Iez77yM5Yid5Y2H5Lic5pum44CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDIKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d957uv6Zu+6aOS6JS977yM5Ly85bmV57uh57u444CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDMKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95b286Ziz56+d56Kn77yM6Zu+6ZyC5ran5ruB44CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDQKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d96LWk55+z5Yas5rqq77yM5Ly8546b55GZ5r2t44CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDQKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95b286Ziz5pma5oSP77yM5pqW5qKm5Ly85LmQ44CCJHtDX1JFU0VUfSIKICAgIHNsZWVwIDMKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d95a+Q5ri45rWu5rKQ77yM6Iul6ZuJ6aOe6Iie44CCJHtDX1JFU0VUfSIKfQoKIyDot58gQVBJIOmAmuS/oeeahOS4u+WHveaVsAojIOWPguaVsOWwseaYr+imgeaJp+ihjOeahOWRveS7pApfZnVja19leGVjdXRlX3Byb21wdCgpIHsKICAgICMg5aaC5p6c55So5oi35Y+q6L6T5YWlICJmdWNrIHVuaW5zdGFsbCIKICAgIGlmIFsgIiQxIiA9ICJ1bmluc3RhbGwiIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfdW5pbnN0YWxsX3NjcmlwdAogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgICMg5aaC5p6c55So5oi36L6T5YWlICJmdWNrIGNvbmZpZyIKICAgIGlmIFsgIiQxIiA9ICJjb25maWciIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfZnVja19zaG93X2NvbmZpZ19oZWxwCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgaWYgISBjb21tYW5kIC12IGN1cmwgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH0nZnVjaycg5ZG95Luk6ZyA6KaBICdjdXJsJ++8jOivt+WFiOWuieijhSBjdXJs44CCJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgaWYgWyAiJCMiIC1lcSAwIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfeivt+aPkOS+m+imgeaJp+ihjOeahOWRveS7pOOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIHByb21wdD0iJCoiCiAgICBsb2NhbCBhdXRvX21vZGU9IiR7RlVDS19BVVRPX0VYRUM6LTB9IgogICAgbG9jYWwgY3VybF90aW1lb3V0PSIke0ZVQ0tfVElNRU9VVDotMzB9IgogICAgbG9jYWwgc3lzaW5mb19zdHJpbmcKICAgIHN5c2luZm9fc3RyaW5nPSQoX2Z1Y2tfY29sbGVjdF9zeXNpbmZvX3N0cmluZykKCiAgICBsb2NhbCByZXNwb25zZT0iIgogICAgbG9jYWwgZXhpdF9jb2RlPTAKICAgIGlmIF9mdWNrX3Nob3VsZF91c2VfbG9jYWxfYXBpOyB0aGVuCiAgICAgICAgZWNobyAtbmUgIiR7Q19ZRUxMT1d95L2/55So5pys5ZywIEFQSSBLZXkuLi4ke0NfUkVTRVR9ICIKICAgICAgICByZXNwb25zZT0kKF9mdWNrX3JlcXVlc3RfbG9jYWxfbW9kZWwgIiRwcm9tcHQiICIkc3lzaW5mb19zdHJpbmciICIkY3VybF90aW1lb3V0IikKICAgICAgICBleGl0X2NvZGU9JD8KICAgIGVsc2UKICAgICAgICBlY2hvIC1uZSAiJHtDX1lFTExPV33mgJ3ogIPkuK0uLi4ke0NfUkVTRVR9ICIKICAgICAgICByZXNwb25zZT0kKF9mdWNrX3JlcXVlc3Rfd29ya2VyX21vZGVsICIkcHJvbXB0IiAiJHN5c2luZm9fc3RyaW5nIiAiJGN1cmxfdGltZW91dCIpCiAgICAgICAgZXhpdF9jb2RlPSQ/CiAgICBmaQoKICAgIGVjaG8gIiIKCiAgICBpZiBbICRleGl0X2NvZGUgLW5lIDAgXSB8fCBbIC16ICIkcmVzcG9uc2UiIF07IHRoZW4KICAgICAgICByZXR1cm4gJGV4aXRfY29kZQogICAgZmkKCiAgICBlY2hvIC1lICIke0NfQ1lBTn3kuLrmgqjnlJ/miJDkuobku6XkuIvlkb3ku6TvvJoke0NfUkVTRVR9IgogICAgZWNobyAtZSAiJHtDX0RJTX0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJHtDX1JFU0VUfSIKICAgIHByaW50ZiAnJXNcbicgIiRyZXNwb25zZSIKICAgIGVjaG8gLWUgIiR7Q19ESU19LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSR7Q19SRVNFVH0iCgogICAgX2Z1Y2tfZGV0ZWN0X2Rhbmdlcm91c19jb21tYW5kICIkcmVzcG9uc2UiCgogICAgbG9jYWwgc2hvdWxkX2V4ZWM9ZmFsc2UKCiAgICBpZiBfZnVja190cnV0aHkgIiRhdXRvX21vZGUiOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV33imqEg5bey5byA5ZCv6Ieq5Yqo5omn6KGM5qih5byP77yM56uL5Y2z6L+Q6KGMLi4uJHtDX1JFU0VUfSIKICAgICAgICBzaG91bGRfZXhlYz10cnVlCiAgICBlbHNlCiAgICAgICAgd2hpbGUgdHJ1ZTsgZG8KICAgICAgICAgICAgcHJpbnRmICIke0NfQk9MRH3mmK/lkKbmiafooYzvvJ9bWS9uXSAke0NfUkVTRVR9IgogICAgICAgICAgICBsb2NhbCBjb25maXJtYXRpb24gbm9ybWFsaXplZAogICAgICAgICAgICBpZiBbIC1yIC9kZXYvdHR5IF07IHRoZW4KICAgICAgICAgICAgICAgIElGUz0gcmVhZCAtciBjb25maXJtYXRpb24gPCAvZGV2L3R0eQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICByZWFkIC1yIGNvbmZpcm1hdGlvbgogICAgICAgICAgICBmaQoKICAgICAgICAgICAgY29uZmlybWF0aW9uPSQocHJpbnRmICclcycgIiR7Y29uZmlybWF0aW9uOi19IiB8IHRyIC1kICcgXHRccicpCiAgICAgICAgICAgIG5vcm1hbGl6ZWQ9JChwcmludGYgJyVzJyAiJGNvbmZpcm1hdGlvbiIgfCB0ciAnWzp1cHBlcjpdJyAnWzpsb3dlcjpdJykKCiAgICAgICAgICAgIGNhc2UgIiRub3JtYWxpemVkIiBpbgogICAgICAgICAgICAgICAgIiJ8InkifCJ5ZXMifCLmmK8iKQogICAgICAgICAgICAgICAgICAgIHNob3VsZF9leGVjPXRydWUKICAgICAgICAgICAgICAgICAgICBlY2hvIC1lICIke0NfR1JFRU594pyFIOaJp+ihjOS4rS4uLiR7Q19SRVNFVH0iCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAgICAgIm4ifCJubyJ8IuWQpiIpCiAgICAgICAgICAgICAgICAgICAgc2hvdWxkX2V4ZWM9ZmFsc2UKICAgICAgICAgICAgICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfeKdjCDlt7Llj5bmtojjgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICAgICAqKQogICAgICAgICAgICAgICAgICAgICMgTG9vcAogICAgICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgIGVzYWMKICAgICAgICBkb25lCiAgICBmaQoKICAgIGlmIFsgIiRzaG91bGRfZXhlYyIgPSAidHJ1ZSIgXTsgdGhlbgogICAgICAgIGV2YWwgIiRyZXNwb25zZSIKICAgICAgICBsb2NhbCBleGl0X2NvZGU9JD8KICAgICAgICBpZiBbICRleGl0X2NvZGUgLW5lIDAgXTsgdGhlbgogICAgICAgICAgICBlY2hvIC1lICIke0NfUkVEX0JPTER96ZSZ6K+v77yBJHtDX1JFRH3lkb3ku6TmiafooYzlpLHotKXvvIzpgIDlh7rnoIEgJGV4aXRfY29kZeOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIGZpCiAgICAgICAgcmV0dXJuICRleGl0X2NvZGUKICAgIGVsc2UKICAgICAgICAjICLlt7Llj5bmtojjgIIiIOa2iOaBr+eOsOWcqOWcqOW+queOr+WGheaJk+WNsO+8jAogICAgICAgICMg5omA5Lul5aaC5p6cIHNob3VsZF9leGVjIOS4uiBmYWxzZe+8jOebtOaOpei/lOWbniAxIOWNs+WPr+OAggogICAgICAgIHJldHVybiAxCiAgICBmaQp9CgojIOWumuS5ieWIq+WQje+8iOaUr+aMgeiHquWumuS5ieWIq+WQje+8iQpfZnVja19kZWZpbmVfYWxpYXNlcygpIHsKICAgIGxvY2FsIGRlZmF1bHRfYWxpYXM9ImZ1Y2siCgogICAgaWYgISBfZnVja190cnV0aHkgIiR7RlVDS19ESVNBQkxFX0RFRkFVTFRfQUxJQVM6LTB9IjsgdGhlbgogICAgICAgIGFsaWFzICIkZGVmYXVsdF9hbGlhcyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKCiAgICBpZiBbIC1uICIke0ZVQ0tfQUxJQVM6LX0iIF0gJiYgWyAiJEZVQ0tfQUxJQVMiICE9ICIkZGVmYXVsdF9hbGlhcyIgXTsgdGhlbgogICAgICAgIGFsaWFzICIkRlVDS19BTElBUyI9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwogICAgZmkKfQoKX2Z1Y2tfZGVmaW5lX2FsaWFzZXMKCiMgLS0tIOaguOW/g+mAu+i+kee7k+adnyAtLS0KRU9GCgojIC0tLSDmoLjlv4PpgLvovpEgSGVyZWRvYyDnu5PmnZ8gLS0tCgojIOWwhuWGheW1jOaguOW/g+mAu+i+keWGmeWIsOaWh+S7tuS4re+8iOWuieijhS/kuLTml7bmqKHlvI/pg73kvJrnlKjliLDvvIkKX2Z1Y2tfd3JpdGVfY29yZSgpIHsKICAgIGxvY2FsIHRhcmdldD0iJDEiCiAgICBwcmludGYgJyVzXG4nICIkQ09SRV9MT0dJQyIgPiAiJHRhcmdldCIKfQoKIyDlsIbmoLjlv4PpgLvovpHovb3lhaXlvZPliY0gc2hlbGwKX2Z1Y2tfc291cmNlX2NvcmUoKSB7CiAgICBsb2NhbCB0bXBfY29yZQogICAgdG1wX2NvcmU9JChta3RlbXApCiAgICBfZnVja193cml0ZV9jb3JlICIkdG1wX2NvcmUiCiAgICAjIHNoZWxsY2hlY2sgZGlzYWJsZT1TQzEwOTAKICAgIHNvdXJjZSAiJHRtcF9jb3JlIgogICAgcm0gLWYgIiR0bXBfY29yZSIKfQoKIyDlsIblhoXltYzmoLjlv4PpgLvovpHlhpnlhaXmjIflrprmlofku7bvvIjlronoo4XkuI7kuLTml7bmiafooYzkvJrnlKjliLDvvIkKX2Z1Y2tfd3JpdGVfY29yZSgpIHsKICAgIGxvY2FsIHRhcmdldD0iJDEiCiAgICBwcmludGYgJyVzXG4nICIkQ09SRV9MT0dJQyIgPiAiJHRhcmdldCIKfQoKCiMgLS0tIOWuieijheWHveaVsCAo55Sx5aSW6YOo6ISa5pys6L+Q6KGMKSAtLS0KCiMg5om+55So5oi3IHNoZWxsIOmFjee9ruaWh+S7tueahOi+heWKqeWHveaVsApfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMg5YW85a65IHNoLCBrc2gg562JCiAgICAgICAgZWNobyAiJEhPTUUvLnByb2ZpbGUiCiAgICBlbGlmIFsgLWYgIiRIT01FLy56c2hyYyIgXTsgdGhlbgogICAgICAgICMgU0hFTEwg5Y+Y6YeP5rKh6K6+572u5pe255qE5aSH55So5pa55qGICiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBTSEVMTCDlj5jph4/msqHorr7nva7ml7bnmoTlpIfnlKjmlrnmoYgKICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxzZQogICAgICAgIGVjaG8gInVua25vd25fcHJvZmlsZSIKICAgIGZpCn0KCiMg5Li75a6J6KOF5Ye95pWwCl9pbnN0YWxsZXJfc2VjdXJlX2NvbmZpZ19maWxlKCkgewogICAgaWYgWyAtZiAiJENPTkZJR19GSUxFIiBdOyB0aGVuCiAgICAgICAgY2htb2QgNjAwICIkQ09ORklHX0ZJTEUiIDI+L2Rldi9udWxsIHx8IHRydWUKICAgIGZpCn0KCl9pbnN0YWxsX3NjcmlwdCgpIHsKICAgIGVjaG8gLWUgIiR7Q19CT0xEfeW8gOWni+WuieijhSBmdWNraXRzLi4uJHtDX1JFU0VUfSIKICAgIG1rZGlyIC1wICIkSU5TVEFMTF9ESVIiCiAgICAKICAgICMg5oqK5qC45b+D6YC76L6R5YaZ6L+bIG1haW4uc2gKICAgIF9mdWNrX3dyaXRlX2NvcmUgIiRNQUlOX1NIIgogICAgCiAgICBpZiBbICQ/IC1uZSAwIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfeaXoOazleWGmeWFpeaWh+S7tu+8jOivt+ajgOafpeebruW9leadg+mZkOOAgiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMg5aaC5p6c5rKh5pyJ6YWN572u5paH5Lu25YiZ55Sf5oiQ5LiA5Liq56S65L6LCiAgICBpZiBbICEgLWYgIiRDT05GSUdfRklMRSIgXTsgdGhlbgogICAgICAgIGNhdCA8PCdDRkcnID4gIiRDT05GSUdfRklMRSIKIyBmdWNraXRzIOmFjee9ruekuuS+iwojIOWOu+aOieihjOmmlueahCAj77yM5pS55oiQ5L2g6Ieq5bex55qE5YC85Y2z5Y+v44CCCgojIOiHquW7ui/oh6rlrprkuYkgV29ya2VyIOWFpeWPowojIGV4cG9ydCBGVUNLX0FQSV9FTkRQT0lOVD0iaHR0cHM6Ly95b3VyLWRvbWFpbi53b3JrZXJzLmRldi8iCgojIOacrOWcsCBPcGVuQUkg5YW85a65IEtlee+8iOW8uueDiOaOqOiNkO+8iQojIGV4cG9ydCBGVUNLX09QRU5BSV9BUElfS0VZPSJzay0uLi4iCgojIOimhueblum7mOiupOaooeWei+aIliBBUEkg5Z+65Z2ACiMgZXhwb3J0IEZVQ0tfT1BFTkFJX01PREVMPSJncHQtNG8tbWluaSIKIyBleHBvcnQgRlVDS19PUEVOQUlfQVBJX0JBU0U9Imh0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEiCgojIOmineWkluWIq+WQje+8iOS4jeS8muW9seWTjem7mOiupCBmdWNr77yJCiMgZXhwb3J0IEZVQ0tfQUxJQVM9Iui/kOihjCIKCiMg6Ieq5Yqo5omn6KGM6L+U5Zue55qE5ZG95Luk77yI5Y2x6Zmp77yM6LCo5oWO5byA5ZCv77yJCiMgZXhwb3J0IEZVQ0tfQVVUT19FWEVDPWZhbHNlCgojIOivt+axgui2heaXtuaXtumXtO+8iOenku+8iQojIGV4cG9ydCBGVUNLX1RJTUVPVVQ9MzAKCiMg5piv5ZCm6L6T5Ye66LCD6K+V5L+h5oGvCiMgZXhwb3J0IEZVQ0tfREVCVUc9ZmFsc2UKCiMg56aB55So5YaF572uIGZ1Y2sg5Yir5ZCNCiMgZXhwb3J0IEZVQ0tfRElTQUJMRV9ERUZBVUxUX0FMSUFTPWZhbHNlCkNGRwogICAgICAgIF9pbnN0YWxsZXJfc2VjdXJlX2NvbmZpZ19maWxlCiAgICBmaQoKICAgICMg5oqKIHNvdXJjZSDpgqPooYzliqDliLAgc2hlbGwg6YWN572u5paH5Lu26YeMCiAgICBsb2NhbCBwcm9maWxlX2ZpbGUKICAgIHByb2ZpbGVfZmlsZT0kKF9pbnN0YWxsZXJfZGV0ZWN0X3Byb2ZpbGUpCiAgICAKICAgIGlmIFsgIiRwcm9maWxlX2ZpbGUiID0gInVua25vd25fcHJvZmlsZSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR95om+5LiN5YiwIC5iYXNocmMsIC56c2hyYyDmiJYgLnByb2ZpbGXvvIzml6Dms5Xoh6rliqjphY3nva7jgIIke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9Xfeivt+aJi+WKqOWwhuS7peS4i+WGheWuuea3u+WKoOWIsOaCqOeahCBzaGVsbCDphY3nva7mlofku7bkuK3vvJoke0NfUkVTRVR9IiA+JjIKICAgICAgICBlY2hvIC1lICJcbiAgJHtDX0NZQU59c291cmNlICRNQUlOX1NIJHtDX1JFU0VUfVxuIiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgIGxvY2FsIHNvdXJjZV9saW5lPSJzb3VyY2UgJE1BSU5fU0giCiAgICBpZiAhIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICMg5L+d6K+B5paH5Lu25pyA5ZCO5pyJ5o2i6KGMCiAgICAgICAgaWYgWyAtbiAiJCh0YWlsIC1jMSAiJHByb2ZpbGVfZmlsZSIpIiBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gIiIgPj4gIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZmkKICAgICAgICBlY2hvICIjIEFkZGVkIGJ5IGZ1Y2tpdHMgaW5zdGFsbGVyIiA+PiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBlY2hvICIkc291cmNlX2xpbmUiID4+ICIkcHJvZmlsZV9maWxlIgogICAgICAgIGVjaG8gLWUgIiR7Q19HUkVFTn3lronoo4XlrozmiJDvvIEke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d96K+36YeN5ZCv57uI56uv5oiW5omn6KGMICR7Q19CT0xEfXNvdXJjZSAkcHJvZmlsZV9maWxlJHtDX1lFTExPV30g5Lul5L2/5pu05pS555Sf5pWI44CCJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICJcbiR7Q19CT0xEfS0tLSDkvb/nlKjmlrnms5UgLS0tJHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICLkvb/nlKggJHtDX1JFRF9CT0xEfWZ1Y2ske0NfUkVTRVR9IOWRveS7pOWQjui3n+aCqOaDs+aJp+ihjOeahOaTjeS9nOWNs+WPr+OAgiIKICAgICAgICBlY2hvIC1lICLnpLrkvos6IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX0NZQU59ZnVjayBpbnN0YWxsIGdpdCR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIHVuaW5zdGFsbCBnaXQke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX0NZQU59ZnVjayDmib7lh7rlvZPliY3nm67lvZXmiYDmnInlpKfkuo4xME1C55qE5paH5Lu2JHtDX1JFU0VUfSIKICAgICAgICBlY2hvIC1lICIgICR7Q19SRURfQk9MRH1mdWNrIHVuaW5zdGFsbCR7Q19SRVNFVH0gJHtDX0dSRUVOfSMg5Y246L29IGZ1Y2tpdHMke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX1JFRF9CT0xEfWZ1Y2sgY29uZmlnJHtDX1JFU0VUfSAke0NfR1JFRU59IyDmmL7npLrphY3nva7luK7liqkke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIlxuJHtDX1lFTExPV33orrDlvpfph43lkK/nu4jnq6/ku6Xkvb/nlKjmlrDlkb3ku6TvvIEke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19ZRUxMT1d95qOA5rWL5Yiw5bey5a6J6KOF77yM5bey5Li65oKo5pu05paw6ISa5pys44CCJHtDX1JFU0VUfSIKICAgIGZpCn0KCgojIC0tLSDkuLvohJrmnKzlhaXlj6MgLS0tCgojIOWmguaenOacieWPguaVsOS8oOi/m+adpSAo5q+U5aaCICJiYXNoIC1zIC4uLiIpCmlmIFsgIiQjIiAtZ3QgMCBdOyB0aGVuCiAgICBpZiBbICIkMSIgPSAiaW5zdGFsbCIgXSAmJiBbICIkIyIgLWVxIDEgXTsgdGhlbgogICAgICAgIF9pbnN0YWxsX3NjcmlwdAogICAgICAgIGV4aXQgMAogICAgZmkKCiAgICBfZnVja19zb3VyY2VfY29yZQogICAgX2Z1Y2tfZXhlY3V0ZV9wcm9tcHQgIiRAIgplbHNlCiAgICBfaW5zdGFsbF9zY3JpcHQKZmkK"`);

const README_URL_EN = 'https://github.com/Silentely/fuckits/blob/main/README.en.md';
const README_URL_ZH = 'https://github.com/Silentely/fuckits';
const INSTALLER_FILENAME_EN = 'fuckits.sh';
const INSTALLER_FILENAME_ZH = 'fuckits-zh.sh';
const SHARED_DEFAULT_LIMIT = 10;
const SECONDS_IN_DAY = 24 * 60 * 60;

let lastQuotaDate = null;
const sharedUsage = new Map();

function resolveSharedLimit(env) {
  const raw = Number(env?.SHARED_DAILY_LIMIT ?? env?.SHARED_DEFAULT_LIMIT);
  if (Number.isFinite(raw) && raw > 0) {
    return Math.floor(raw);
  }
  return SHARED_DEFAULT_LIMIT;
}

function resolveQuotaStore(env) {
  if (env?.QUOTA_KV && typeof env.QUOTA_KV.get === 'function') {
    return env.QUOTA_KV;
  }

  const alias = env?.QUOTA_KV_BINDING;
  if (alias && env?.[alias] && typeof env[alias].get === 'function') {
    return env[alias];
  }

  if (env?.fuckits && typeof env.fuckits.get === 'function') {
    return env.fuckits;
  }

  return null;
}

async function checkSharedQuota(ip, limit, env) {
  const quotaStore = resolveQuotaStore(env);
  if (quotaStore) {
    return checkSharedQuotaKV(quotaStore, ip, limit);
  }
  return checkSharedQuotaInMemory(ip, limit);
}

function checkSharedQuotaInMemory(ip, limit) {
  const today = new Date().toISOString().slice(0, 10);
  if (lastQuotaDate !== today) {
    sharedUsage.clear();
    lastQuotaDate = today;
  }
  const key = ip || 'anonymous';
  const current = (sharedUsage.get(key) || 0) + 1;
  sharedUsage.set(key, current);
  return {
    allowed: current <= limit,
    remaining: Math.max(limit - current, 0),
    count: current,
  };
}

async function checkSharedQuotaKV(kv, ip, limit) {
  const today = new Date().toISOString().slice(0, 10);
  const key = `quota:${today}:${ip || 'anonymous'}`;
  const ttl = secondsUntilNextUtcMidnight();

  try {
    const raw = await kv.get(key);
    let count = Number(raw) || 0;
    count += 1;
    await kv.put(key, String(count), { expirationTtl: ttl > 0 ? ttl : SECONDS_IN_DAY });
    return {
      allowed: count <= limit,
      remaining: Math.max(limit - count, 0),
      count,
    };
  } catch (error) {
    console.error('Failed to persist quota counter, falling back to in-memory map', error);
    return checkSharedQuotaInMemory(ip, limit);
  }
}

function secondsUntilNextUtcMidnight() {
  const now = new Date();
  const midnight = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1);
  return Math.ceil((midnight - now.getTime()) / 1000);
}

function isBrowserRequest(userAgent = '') {
  return /Mozilla|Chrome|Safari|Firefox|Edg/.test(userAgent);
}

function resolveLocale(url, headers) {
  const pathname = url.pathname.toLowerCase();
  if (pathname === '/zh' || pathname.startsWith('/zh/')) {
    return 'zh';
  }

  const langParam = (url.searchParams.get('lang') || '').toLowerCase();
  if (langParam.startsWith('zh')) {
    return 'zh';
  }

  const acceptLanguage = (headers.get('Accept-Language') || '').toLowerCase();
  if (acceptLanguage.split(',').some((token) => token.trim().startsWith('zh'))) {
    return 'zh';
  }

  return 'en';
}


export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    if (request.method === 'GET' && url.pathname === '/health') {
      return handleHealthCheck(env);
    }

    if (request.method === 'GET') {
      return handleGetRequest(request);
    } else if (request.method === 'POST') {
      return handlePostRequest(request, env);
    } else {
      return new Response('Expected GET or POST', { status: 405 });
    }
  },
};

function handleHealthCheck(env) {
  const payload = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    hasApiKey: Boolean(env?.OPENAI_API_KEY),
  };

  return new Response(JSON.stringify(payload), {
    status: 200,
    headers: { 'Content-Type': 'application/json; charset=utf-8' },
  });
}

/**
 * Handles GET requests to serve the installer script or redirect browsers to GitHub.
 * @param {Request} request The incoming request.
 * @returns {Response} A response with the shell script or a redirect.
 */
function handleGetRequest(request) {
  const userAgent = request.headers.get('User-Agent') || '';
  const url = new URL(request.url);
  const locale = resolveLocale(url, request.headers);
  const isBrowser = isBrowserRequest(userAgent);

  // If the request comes from a browser, redirect to the appropriate README.
  if (isBrowser) {
    const docsUrl = locale === 'zh' ? README_URL_ZH : README_URL_EN;
    return Response.redirect(docsUrl, 302);
  }

  // Otherwise, serve the installer script based on the resolved locale.
  const script = locale === 'zh' ? INSTALLER_SCRIPT_ZH : INSTALLER_SCRIPT;
  const filename = locale === 'zh' ? INSTALLER_FILENAME_ZH : INSTALLER_FILENAME_EN;

  return new Response(script, {
    headers: {
      'Content-Type': 'text/plain; charset=utf-8',
      'Content-Disposition': `attachment; filename="${filename}"`,
    },
  });
}

/**
 * Handles POST requests by forwarding the prompt to an AI model.
 * @param {Request} request The incoming request.
 * @param {object} env The environment variables.
 * @returns {Promise<Response>} A promise that resolves to the AI's response.
 */
async function handlePostRequest(request, env) {
  try {
    const { sysinfo, prompt, adminKey } = await request.json();

    if (!prompt) {
      return new Response('Missing "prompt" in request body', { status: 400 });
    }
    if (!env.OPENAI_API_KEY) {
      return new Response('Missing OPENAI_API_KEY secret', { status: 500 });
    }

    const normalizedAdminKey = typeof adminKey === 'string' ? adminKey.trim() : '';
    const hasAdminBypass = Boolean(
      normalizedAdminKey && env?.ADMIN_ACCESS_KEY && normalizedAdminKey === env.ADMIN_ACCESS_KEY,
    );

    const clientIp = request.headers.get('CF-Connecting-IP') ||
      request.headers.get('X-Forwarded-For') ||
      'anonymous';
    if (!hasAdminBypass) {
      const sharedLimit = resolveSharedLimit(env);
      const quota = await checkSharedQuota(clientIp, sharedLimit, env);
      if (!quota.allowed) {
        const message = {
          error: 'DEMO_LIMIT_EXCEEDED',
          message: `Shared demo quota exceeded (max ${sharedLimit} calls per day).`,
          hint: 'Configure FUCK_OPENAI_API_KEY in ~/.fuck/config.sh to use your own key.',
          remaining: quota.remaining,
          limit: sharedLimit,
        };
        return new Response(JSON.stringify(message), {
          status: 429,
          headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
        });
      }
    }

    const model = env.OPENAI_API_MODEL || 'gpt-5-nano';
    const apiBase = (env.OPENAI_API_BASE || 'https://api.openai.com/v1').replace(/\/$/, '');
    const apiUrl = `${apiBase}/chat/completions`;

    const url = new URL(request.url);
    const locale = resolveLocale(url, request.headers);
    const isChinese = locale === 'zh';

    const system_prompt = isChinese
      ? ` fuckits  /shsh -ceval ''""  &&||;|  Markdown shebang${sysinfo}`
      : `You are the fuckits command architect. Use the provided system information to fully respect the user's OS, architecture, package manager, and constraints. Return only raw executable command lines (one command per line) that run directly in their shell without extra wrapping. Never include /sh, sh -c, eval, or wrap the entire output inside quotes such as '' or "". Do not use separators like &&, ||, ;, | to chain commands, and avoid markdown, comments, code fences, or shebangs. Output only these command lines tailored to this system info: ${sysinfo}`;

    const aiRequestPayload = {
      model: model,
      messages: [
        {
          role: 'system',
          content: system_prompt,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 1024,
      temperature: 0.2,
    };

    const aiResponse = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify(aiRequestPayload),
    });

    if (!aiResponse.ok) {
      const errorText = await aiResponse.text();
      return new Response(`AI API Error: ${errorText}`, { status: aiResponse.status });
    }

    const aiJson = await aiResponse.json();
    const command = aiJson.choices[0]?.message?.content.trim();

    if (!command) {
      return new Response('The AI returned an empty command.', { status: 500 });
    }

    return new Response(command, {
      headers: { 'Content-Type': 'text/plain' },
    });
  } catch (error) {
    return new Response(`Error: ${error.message}`, { status: 500 });
  }
}
